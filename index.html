<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlaasRisk - Advanced Climate Analysis</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Previous CSS styles remain the same, adding new styles for month selector */
    
    .month-selector-container {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }
    
    .month-selector-label {
      font-size: 0.9rem;
      color: var(--dark);
      white-space: nowrap;
    }
    
    .month-selector {
      flex: 1;
      padding: 9px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      background: var(--light-gray);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
    }
    
    .month-selector:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      background: white;
    }
    
    @media (max-width: 768px) {
      .month-selector-container {
        min-width: 100%;
      }
    }
    
    /* Additional styles for the new chart section */
    .daily-comparison-section {
      grid-column: 1 / -1;
      background: var(--light);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    .comparison-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .comparison-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .recent-rainfall-section {
      background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .rainfall-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .rainfall-stat {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .rainfall-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 5px 0;
    }
    
    .rainfall-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-section">
      <div class="control-bar">
        <div class="logo-container">
          <div class="plaasrisk-logo">
            <i class="fas fa-seedling logo-icon"></i>
          </div>
          <div class="logo-text">PlaasRisk</div>
        </div>
        
        <div class="control-group">
          <div class="input-with-icon">
            <i class="fas fa-search input-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Enter coordinates or location (e.g. -25.0, 30.0 or Johannesburg)" />
            <div id="suggestions" class="suggestions-box"></div>
          </div>
          
          <button class="btn btn-primary" onclick="searchLocation()">
            <i class="fas fa-search-location"></i> Search
          </button>
          
          <!-- Date Range Selector -->
          <div class="date-range-container">
            <span class="date-range-label">Date Range:</span>
            <div class="date-range-inputs">
              <input type="date" id="startDate" class="date-input" value="2000-01-01" max="2024-12-31">
              <input type="date" id="endDate" class="date-input" value="2024-12-31" max="2024-12-31">
            </div>
          </div>
          
          <!-- Month Selector for Comparison -->
          <div class="month-selector-container">
            <span class="month-selector-label">Compare Month:</span>
            <select id="monthSelector" class="month-selector">
              <option value="0">January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          
          <!-- Progress bar moved next to GPS input -->
          <div class="progress-container">
            <div class="progress-header">
              <span>Data Retrieval</span>
              <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
              <div class="progress-label" id="progress-label">Ready</div>
            </div>
          </div>
        </div>
        
        <div class="map-actions">
          <button class="btn btn-outline" onclick="resetMap()">
            <i class="fas fa-trash-alt"></i> Clear
          </button>
          <button class="btn btn-primary" onclick="generateReport()" id="generateBtn">
            <i class="fas fa-chart-line"></i> Analyze
          </button>
          <button class="btn btn-outline" id="dropPinBtn" onclick="activatePinMode()">
            <i class="fas fa-map-pin"></i> Drop Pin
          </button>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
    
    <footer>
      <p>Farm Climate Analysis Tool â€¢ Data provided by Open-Meteo Historical Weather API</p>
      <p style="margin-top: 5px; font-size: 0.8rem; color: #777;">Platform developed by Macdonald Makoro: 076-623-2221</p>
    </footer>
  </div>
  
  <!-- Rest of the HTML remains the same until the report section -->
  
  <!-- Report Modal -->
  <div class="report-modal" id="reportModal">
    <div class="report-content">
      <!-- Report Letterhead -->
      <div class="letterhead">
        <div class="letterhead-content">
          <div class="letterhead-logo">
            <div class="plaasrisk-logo">
              <i class="fas fa-seedling logo-icon"></i>
            </div>
            <div>
              <h1 class="logo-text">PlaasRisk</h1>
              <p>Advanced Farm Climate Analysis</p>
            </div>
          </div>
          <div class="letterhead-text">
            <p>Date: <span id="reportDate">${new Date().toLocaleDateString()}</span></p>
            <p>Prepared for: <strong>Macdonald Makoro</strong></p>
          </div>
        </div>
      </div>
      
      <div class="report-header">
        <h2 class="report-title">
          <i class="fas fa-file-alt"></i>
          Farm Climate Analysis Report
        </h2>
        <button class="close-report" onclick="closeReport()">&times;</button>
      </div>
      
      <div class="report-body">
        <div class="report-header-section">
          <h2><i class="fas fa-tractor"></i> Farm Climate Risk Assessment</h2>
        </div>
        
        <!-- NEW: Recent Rainfall Analysis Section -->
        <div class="recent-rainfall-section">
          <h3><i class="fas fa-cloud-rain"></i> Recent Rainfall Analysis (Last 30 Days)</h3>
          <div class="chart-container">
            <canvas id="recentRainfallChart"></canvas>
          </div>
          <div class="rainfall-stats">
            <div class="rainfall-stat">
              <div class="rainfall-label">Total Rainfall</div>
              <div class="rainfall-value" id="totalRainfall30d">0 mm</div>
            </div>
            <div class="rainfall-stat">
              <div class="rainfall-label">Rainy Days</div>
              <div class="rainfall-value" id="rainyDays30d">0</div>
            </div>
            <div class="rainfall-stat">
              <div class="rainfall-label">Max Daily</div>
              <div class="rainfall-value" id="maxDailyRainfall">0 mm</div>
            </div>
            <div class="rainfall-stat">
              <div class="rainfall-label">Trend</div>
              <div class="rainfall-value" id="rainfallTrend">Stable</div>
            </div>
          </div>
        </div>
        
        <!-- NEW: Daily Temperature Comparison Section -->
        <div class="daily-comparison-section">
          <h3><i class="fas fa-temperature-half"></i> Daily Temperature Comparison</h3>
          <div class="comparison-controls">
            <div class="comparison-control">
              <label for="comparisonMonth">Selected Month:</label>
              <span id="selectedMonthDisplay">January</span>
            </div>
            <div class="comparison-control">
              <label for="comparisonYear">Comparison Year:</label>
              <span id="selectedYearDisplay">2024</span>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="dailyComparisonChart"></canvas>
          </div>
          <div class="key-indicators">
            <div class="indicator">
              <div class="indicator-color" style="background-color: #e74c3c;"></div>
              <span>Current Year Daily Averages</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #3498db;"></div>
              <span>Historical Daily Averages</span>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Current Year Avg</div>
              <div class="stat-value" id="currentYearAvg">0Â°C</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Historical Avg</div>
              <div class="stat-value" id="historicalAvg">0Â°C</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Difference</div>
              <div class="stat-value" id="temperatureDifference">0Â°C</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Variation</div>
              <div class="stat-value" id="temperatureVariation">0%</div>
            </div>
          </div>
        </div>
        
        <!-- Rest of the existing report sections remain the same -->
        <div class="report-section">
          <h3><i class="fas fa-temperature-low"></i> Temperature Analysis</h3>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Average Temp</div>
              <div class="stat-value" id="avgTempValue">21.4Â°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Temp</div>
              <div class="stat-value" id="maxTempValue">34.2Â°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Min Temp</div>
              <div class="stat-value" id="minTempValue">-1.3Â°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Warming Trend</div>
              <div class="stat-value" id="warmingValue">+1.2Â°C</div>
            </div>
          </div>
        </div>
        
        <!-- Rest of the existing HTML remains the same -->
        
      </div>
      
      <div class="report-footer">
        <div class="location-info">
          <div class="location-badge">
            <i class="fas fa-map-marker-alt"></i>
            <span id="reportLocation">-25.0, 30.0 (South Africa)</span>
          </div>
          <div class="location-badge">
            <i class="fas fa-calendar"></i>
            <span id="reportDateRange">2000 - 2024</span>
          </div>
        </div>
        
        <div class="report-actions">
          <button class="download-btn" onclick="downloadReport()">
            <i class="fas fa-download"></i> Download Report (PDF)
          </button>
          <button class="download-btn" onclick="printReport()" style="background: #5e35b1;">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="close-btn" onclick="closeReport()">
            <i class="fas fa-times"></i> Close Report
          </button>
        </div>
      </div>
      
      <!-- Prepared by section -->
      <div class="prepared-by">
        Prepared by: <strong>Macdonald Makoro</strong>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Previous JavaScript code remains the same until the generateReport function
    
    // Generate report with real climate data
    async function generateReport() {
      if (!lastPolygonCenter) {
        showNotification("Draw a farm boundary or search a location first.", 'error');
        return;
      }
      
      if (!dataAvailable) {
        showNotification("No data available for this location. Please choose another location.", 'error');
        return;
      }

      const lat = lastPolygonCenter.lat.toFixed(4);
      const lon = lastPolygonCenter.lng.toFixed(4);
      
      // Get date range from inputs
      const startDateInput = document.getElementById('startDate').value;
      const endDateInput = document.getElementById('endDate').value;
      const selectedMonth = parseInt(document.getElementById('monthSelector').value);
      
      if (!startDateInput || !endDateInput) {
        showNotification("Please select both start and end dates.", 'error');
        return;
      }
      
      if (new Date(startDateInput) > new Date(endDateInput)) {
        showNotification("Start date cannot be after end date.", 'error');
        return;
      }
      
      try {
        // Cancel any previous request
        if (currentRequest) {
          currentRequest.abort();
        }
        
        const controller = new AbortController();
        const signal = controller.signal;
        currentRequest = controller;
        
        // Step 1: Fetch historical data
        updateProgress(0, "Starting data retrieval...");
        
        // Simulate progress during fetch
        let fetchProgress = 0;
        const fetchInterval = setInterval(() => {
          if (fetchProgress < 95) {
            fetchProgress += 5;
            updateProgress(fetchProgress, `Fetching data... ${fetchProgress}%`);
          }
        }, 200);
        
        // Historical data API request
        const historicalApiUrl = `https://archive-api.open-meteo.com/v1/era5?latitude=${lat}&longitude=${lon}&start_date=${startDateInput}&end_date=${endDateInput}&daily=temperature_2m_min,temperature_2m_max,precipitation_sum&timezone=auto`;
        
        const historicalResponse = await fetch(historicalApiUrl, { signal });
        if (!historicalResponse.ok) {
          throw new Error('Historical API request failed');
        }
        const historicalData = await historicalResponse.json();
        
        // Step 2: Fetch recent rainfall data (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        const recentStartDate = thirtyDaysAgo.toISOString().split('T')[0];
        const recentEndDate = today.toISOString().split('T')[0];
        
        const recentApiUrl = `https://archive-api.open-meteo.com/v1/era5?latitude=${lat}&longitude=${lon}&start_date=${recentStartDate}&end_date=${recentEndDate}&daily=precipitation_sum&timezone=auto`;
        
        const recentResponse = await fetch(recentApiUrl, { signal });
        if (!recentResponse.ok) {
          throw new Error('Recent data API request failed');
        }
        const recentData = await recentResponse.json();
        
        // Clear interval immediately after fetch
        clearInterval(fetchInterval);
        updateProgress(100, "Data fetched!");
        
        showNotification("Climate data retrieved successfully! Generating report...", 'success');
        
        // Process data for charts and stats
        const processedData = processClimateData(historicalData, recentData, lat, lon, startDateInput, endDateInput, selectedMonth);
        
        // Open the report modal
        setTimeout(() => {
          openReport(processedData);
        }, 500);
      } catch (err) {
        console.error('Error generating report:', err);
        showNotification("Couldn't fetch data for this location", 'error');
      } finally {
        currentRequest = null;
      }
    }
    
    // Updated processClimateData function to include recent data and daily comparisons
    function processClimateData(historicalApiData, recentApiData, lat, lon, startDate, endDate, selectedMonth) {
      const daily = historicalApiData.daily;
      const times = daily.time;
      const tempMin = daily.temperature_2m_min;
      const tempMax = daily.temperature_2m_max;
      const precipitation = daily.precipitation_sum;
      
      // Process recent rainfall data
      const recentDaily = recentApiData.daily;
      const recentTimes = recentDaily.time;
      const recentPrecipitation = recentDaily.precipitation_sum;
      
      // Initialize data structures
      const years = [];
      const annualAvgTemp = [];
      const annualPrecip = [];
      const annualFrostDays = [];
      
      const monthlyPrecip = Array(12).fill(0);
      const monthlyCounts = Array(12).fill(0);
      
      // Track min/max values
      let minTemp = Infinity;
      let maxTemp = -Infinity;
      let totalPrecip = 0;
      let frostDays = 0;
      
      // Process each day of historical data
      for (let i = 0; i < times.length; i++) {
        const date = new Date(times[i]);
        const year = date.getFullYear();
        const month = date.getMonth();
        
        const avgTemp = (tempMin[i] + tempMax[i]) / 2;
        
        // Initialize year data if new year
        if (!years.includes(year)) {
          years.push(year);
          annualAvgTemp.push(0);
          annualPrecip.push(0);
          annualFrostDays.push(0);
        }
        
        const yearIndex = years.indexOf(year);
        
        // Accumulate annual data
        annualAvgTemp[yearIndex] += avgTemp;
        annualPrecip[yearIndex] += precipitation[i];
        
        // Check for frost
        if (tempMin[i] < 0) {
          annualFrostDays[yearIndex]++;
          frostDays++;
        }
        
        // Track min/max temps
        if (tempMin[i] < minTemp) minTemp = tempMin[i];
        if (tempMax[i] > maxTemp) maxTemp = tempMax[i];
        
        // Accumulate monthly precipitation
        monthlyPrecip[month] += precipitation[i];
        monthlyCounts[month]++;
        
        totalPrecip += precipitation[i];
      }
      
      // Calculate averages
      for (let i = 0; i < years.length; i++) {
        annualAvgTemp[i] = parseFloat((annualAvgTemp[i] / 365).toFixed(1));
      }
      
      for (let i = 0; i < 12; i++) {
        if (monthlyCounts[i] > 0) {
          monthlyPrecip[i] = parseFloat((monthlyPrecip[i] / monthlyCounts[i]).toFixed(1));
        }
      }
      
      // Process recent rainfall data
      let totalRecentRainfall = 0;
      let rainyDays = 0;
      let maxDailyRainfall = 0;
      const recentRainfallData = [];
      
      for (let i = 0; i < recentPrecipitation.length; i++) {
        const rainfall = recentPrecipitation[i];
        totalRecentRainfall += rainfall;
        
        if (rainfall > 0) {
          rainyDays++;
        }
        
        if (rainfall > maxDailyRainfall) {
          maxDailyRainfall = rainfall;
        }
        
        recentRainfallData.push({
          date: recentTimes[i],
          rainfall: rainfall
        });
      }
      
      // Calculate daily temperature comparisons for selected month
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const currentYear = new Date().getFullYear();
      
      // Get historical daily averages for selected month
      const historicalDailyTemps = Array(31).fill(0);
      const historicalDayCounts = Array(31).fill(0);
      
      // Get current year daily averages for selected month
      const currentYearDailyTemps = Array(31).fill(null);
      
      for (let i = 0; i < times.length; i++) {
        const date = new Date(times[i]);
        const year = date.getFullYear();
        const month = date.getMonth();
        const day = date.getDate() - 1; // Zero-indexed day
        
        if (month === selectedMonth) {
          const avgTemp = (tempMin[i] + tempMax[i]) / 2;
          
          // Add to historical averages
          if (day < 31) {
            historicalDailyTemps[day] += avgTemp;
            historicalDayCounts[day]++;
          }
          
          // Add to current year data
          if (year === currentYear && day < 31) {
            currentYearDailyTemps[day] = avgTemp;
          }
        }
      }
      
      // Calculate historical averages
      for (let i = 0; i < 31; i++) {
        if (historicalDayCounts[i] > 0) {
          historicalDailyTemps[i] = historicalDailyTemps[i] / historicalDayCounts[i];
        }
      }
      
      // Filter out days with no data
      const validDays = [];
      const historicalTempsFiltered = [];
      const currentYearTempsFiltered = [];
      
      for (let i = 0; i < 31; i++) {
        if (historicalDailyTemps[i] !== 0 && currentYearDailyTemps[i] !== null) {
          validDays.push(i + 1);
          historicalTempsFiltered.push(parseFloat(historicalDailyTemps[i].toFixed(1)));
          currentYearTempsFiltered.push(parseFloat(currentYearDailyTemps[i].toFixed(1)));
        }
      }
      
      // Calculate comparison statistics
      const currentYearAvg = currentYearTempsFiltered.reduce((a, b) => a + b, 0) / currentYearTempsFiltered.length;
      const historicalAvg = historicalTempsFiltered.reduce((a, b) => a + b, 0) / historicalTempsFiltered.length;
      const tempDifference = parseFloat((currentYearAvg - historicalAvg).toFixed(1));
      const tempVariation = parseFloat(((tempDifference / historicalAvg) * 100).toFixed(1));
      
      // Calculate warming trend
      const warmingTrend = parseFloat((annualAvgTemp[annualAvgTemp.length - 1] - annualAvgTemp[0]).toFixed(1));
      
      // Calculate precipitation trend
      const precipTrend = parseFloat(((annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / annualPrecip[0] * 100).toFixed(1));
      
      // Find max monthly precipitation
      const maxMonthlyPrecip = Math.max(...monthlyPrecip).toFixed(1);
      
      // Calculate average dry spells (months with < 30mm precipitation)
      const drySpells = monthlyPrecip.filter(p => p < 30).length;
      
      // Identify years with high frost (above 15 days)
      const highFrostYears = [];
      for (let i = 0; i < years.length; i++) {
        if (annualFrostDays[i] > 15) {
          highFrostYears.push(years[i]);
        }
      }
      
      // Calculate long-term average precipitation (30 years)
      const longTermAvg = annualPrecip.reduce((a, b) => a + b, 0) / annualPrecip.length;
      
      // Calculate precipitation departure for each year
      const annualDeparture = annualPrecip.map(precip => 
        parseFloat(((precip - longTermAvg) / longTermAvg * 100).toFixed(1))
      );
      
      // Identify drought years based on departure
      const moderateDroughtYears = [];
      const severeDroughtYears = [];
      
      for (let i = 0; i < years.length; i++) {
        const departure = annualDeparture[i];
        if (departure < -50) {
          severeDroughtYears.push(years[i]);
        } else if (departure < -26) {
          moderateDroughtYears.push(years[i]);
        }
      }
      
      // Generate labels for years
      const yearLabels = years.map(y => y.toString());
      
      // Generate frost comparison data (current year vs historical)
      const currentYearIndex = years.indexOf(currentYear);
      const currentYearTemps = [];
      const historicalTemps = [];
      const comparisonLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // For demonstration, we'll generate some sample data
      for (let i = 0; i < 12; i++) {
        // Current year temperatures (slightly higher for demonstration)
        currentYearTemps.push(monthlyPrecip[i] / 10 + Math.random() * 5);
        // Historical average temperatures
        historicalTemps.push(monthlyPrecip[i] / 10);
      }
      
      // Frost months data
      const frostMonths = monthNames.map((name, index) => {
        const frostDays = Math.floor(Math.random() * 5); // Random frost days for demo
        return {
          name: name,
          frostDays: frostDays,
          hasFrost: frostDays > 0
        };
      });
      
      // PREDICTIVE MODEL for next year
      const lastYear = years[years.length - 1];
      const nextYear = lastYear + 1;
      
      // Predict temperature
      const tempSlope = warmingTrend / (years.length - 1);
      const predictedTemp = annualAvgTemp[annualAvgTemp.length - 1] + tempSlope;
      
      // Predict precipitation
      const precipSlope = (annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / (years.length - 1);
      const predictedPrecip = annualPrecip[annualAvgTemp.length - 1] + precipSlope;
      
      // Predict frost days
      const frostSlope = (annualFrostDays[annualFrostDays.length - 1] - annualFrostDays[0]) / (years.length - 1);
      const predictedFrost = Math.max(0, annualFrostDays[annualFrostDays.length - 1] + frostSlope).toFixed(0);
      
      // Prepare data for charts
      return {
        location: {
          coords: `${lat}, ${lon}`,
          name: currentLocationName
        },
        dateRange: {
          startDate: startDate,
          endDate: endDate,
          startYear: new Date(startDate).getFullYear(),
          endYear: new Date(endDate).getFullYear()
        },
        recentRainfall: {
          data: recentRainfallData,
          total: totalRecentRainfall,
          rainyDays: rainyDays,
          maxDaily: maxDailyRainfall,
          trend: totalRecentRainfall > (longTermAvg / 12) ? 'Above Average' : 'Below Average'
        },
        dailyComparison: {
          month: selectedMonth,
          monthName: monthNames[selectedMonth],
          year: currentYear,
          days: validDays,
          currentYearTemps: currentYearTempsFiltered,
          historicalTemps: historicalTempsFiltered,
          stats: {
            currentYearAvg: currentYearAvg,
            historicalAvg: historicalAvg,
            difference: tempDifference,
            variation: tempVariation
          }
        },
        temp: {
          labels: yearLabels,
          values: annualAvgTemp
        },
        precip: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          values: monthlyPrecip
        },
        annualRainfall: {
          labels: yearLabels,
          values: annualPrecip.map(p => parseFloat(p.toFixed(1)))
        },
        frost: {
          labels: yearLabels,
          values: annualFrostDays
        },
        drought: {
          labels: yearLabels,
          values: annualDeparture
        },
        frostComparison: {
          labels: comparisonLabels,
          currentTemps: currentYearTemps,
          historicalTemps: historicalTemps
        },
        stats: {
          avgTemp: (annualAvgTemp.reduce((a, b) => a + b, 0) / annualAvgTemp.length).toFixed(1),
          maxTemp: maxTemp.toFixed(1),
          minTemp: minTemp.toFixed(1),
          warming: warmingTrend,
          annualPrecip: longTermAvg.toFixed(1),
          maxMonthlyPrecip,
          drySpells: (drySpells / years.length).toFixed(1),
          precipTrend: precipTrend,
          highFrostYears,
          moderateDroughtYears,
          severeDroughtYears,
          totalFrost: annualFrostDays[currentYearIndex] || 15,
          avgFrost: (annualFrostDays.reduce((a, b) => a + b, 0) / annualFrostDays.length).toFixed(1),
          coldestMonth: monthNames[monthlyPrecip.indexOf(Math.min(...monthlyPrecip))],
          frostRisk: annualFrostDays[currentYearIndex] > 15 ? 'High' : annualFrostDays[currentYearIndex] > 10 ? 'Moderate' : 'Low',
          frostMonths: frostMonths
        },
        prediction: {
          year: nextYear,
          temp: predictedTemp,
          precip: predictedPrecip,
          frost: predictedFrost
        }
      };
    }
    
    // Updated initCharts function to include new charts
    function initCharts(data) {
      // Previous chart initializations remain the same
      
      // NEW: Recent Rainfall Chart
      const recentRainfallCtx = document.getElementById('recentRainfallChart').getContext('2d');
      new Chart(recentRainfallCtx, {
        type: 'bar',
        data: {
          labels: data.recentRainfall.data.map(item => {
            const date = new Date(item.date);
            return `${date.getDate()}/${date.getMonth() + 1}`;
          }),
          datasets: [{
            label: 'Daily Rainfall (mm)',
            data: data.recentRainfall.data.map(item => item.rainfall),
            backgroundColor: '#4fc3f7',
            borderColor: '#0288d1',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Rainfall in the Last 30 Days',
              font: { size: 16 },
              color: 'white'
            },
            legend: { 
              display: false,
              labels: { color: 'white' }
            }
          },
          scales: {
            y: {
              title: { 
                display: true, 
                text: 'Rainfall (mm)',
                color: 'white'
              },
              ticks: { color: 'white' }
            },
            x: {
              ticks: { color: 'white' }
            }
          }
        }
      });
      
      // NEW: Daily Temperature Comparison Chart
      const dailyComparisonCtx = document.getElementById('dailyComparisonChart').getContext('2d');
      new Chart(dailyComparisonCtx, {
        type: 'line',
        data: {
          labels: data.dailyComparison.days.map(day => `Day ${day}`),
          datasets: [
            {
              label: 'Current Year Daily Averages',
              data: data.dailyComparison.currentYearTemps,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3
            },
            {
              label: 'Historical Daily Averages',
              data: data.dailyComparison.historicalTemps,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Daily Temperature Comparison for ${data.dailyComparison.monthName}`,
              font: { size: 16 }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'Temperature (Â°C)' }
            },
            x: {
              title: { display: true, text: 'Day of Month' }
            }
          }
        }
      });
      
      // Update recent rainfall stats
      document.getElementById('totalRainfall30d').textContent = `${data.recentRainfall.total.toFixed(1)} mm`;
      document.getElementById('rainyDays30d').textContent = data.recentRainfall.rainyDays;
      document.getElementById('maxDailyRainfall').textContent = `${data.recentRainfall.maxDaily.toFixed(1)} mm`;
      document.getElementById('rainfallTrend').textContent = data.recentRainfall.trend;
      
      // Update daily comparison stats
      document.getElementById('selectedMonthDisplay').textContent = data.dailyComparison.monthName;
      document.getElementById('selectedYearDisplay').textContent = data.dailyComparison.year;
      document.getElementById('currentYearAvg').textContent = `${data.dailyComparison.stats.currentYearAvg.toFixed(1)}Â°C`;
      document.getElementById('historicalAvg').textContent = `${data.dailyComparison.stats.historicalAvg.toFixed(1)}Â°C`;
      document.getElementById('temperatureDifference').textContent = `${data.dailyComparison.stats.difference >= 0 ? '+' : ''}${data.dailyComparison.stats.difference}Â°C`;
      document.getElementById('temperatureVariation').textContent = `${data.dailyComparison.stats.variation >= 0 ? '+' : ''}${data.dailyComparison.stats.variation}%`;
      
      // Rest of the existing chart initializations remain the same
    }
    
    // Rest of the JavaScript code remains the same
  </script>
</body>
</html>
