/* Code.gs — Earth Engine NDVI timeseries API (free via Apps Script) */
const EEDataset = 'MODIS/061/MOD13A2'; // 16-day, 1km. Band: NDVI (scale 1e-4)
function toFeature(aoi) { return ee.Geometry.Polygon(aoi.coordinates); }

function seriesNDVI(aoi, start, end) {
  const geom = toFeature(aoi);
  const col = ee.ImageCollection(EEDataset)
    .filterDate(start, end)
    .select('NDVI')
    .map(img => img.updateMask(img.neq(-3000))); // mask fill

  const dates = col.aggregate_array('system:time_start');
  const means = col.map(img => img.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: geom,
    scale: 1000,
    bestEffort: true,
    maxPixels: 1e13
  }).get('NDVI').divide(10000))
    .aggregate_array('NDVI');

  return ee.Dictionary({ dates, means });
}

function doGet(e) { return handle(e); }
function doPost(e) { return handle(e); }

function handle(e) {
  try {
    const body = e.postData?.contents || e.parameter?.q || '{}';
    const req = JSON.parse(body);
    const aoi = req.aoi;     // GeoJSON Polygon
    const start = req.start; // 'YYYY-MM-DD'
    const end = req.end;     // 'YYYY-MM-DD'

    const dict = seriesNDVI(aoi, start, end);
    const res = dict.evaluate(d => {
      const out = (d.dates || []).map((t,i)=>({
        date: new Date(t).toISOString().slice(0,10),
        ndvi: +(d.means?.[i] ?? null)
      })).filter(p => p.ndvi !== null);
      return ContentService
        .createTextOutput(JSON.stringify({ ok:true, points: out }))
        .setMimeType(ContentService.MimeType.JSON);
    });
    // evaluate is async; Apps Script requires returning something; we’ll return a placeholder.
    return ContentService.createTextOutput(JSON.stringify({ ok:true, note:"Processing"}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ ok:false, error: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
