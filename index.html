<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlaasRisk - Advanced Climate Analysis</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* All CSS styles remain the same as in the original code */
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --primary-dark: #1b5e20;
      --secondary: #388e3c;
      --accent: #f57c00;
      --accent-light: #ffb74d;
      --accent-dark: #e65100;
      --light: #f5f9f5;
      --light-gray: #f8f9fa;
      --dark: #2d3748;
      --text: #333333;
      --border: #e0e0e0;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --frost-blue: #1e88e5;
      --frost-light: #bbdefb;
      --drought-brown: #8d6e63;
      --drought-light: #efebe9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f9f5 0%, #e8f5e9 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    
    /* ... rest of CSS remains the same ... */
  </style>
</head>
<body>
  <!-- HTML structure remains the same -->
  <div class="container">
    <div class="map-section">
      <div class="control-bar">
        <div class="logo-container">
          <div class="plaasrisk-logo">
            <i class="fas fa-seedling logo-icon"></i>
          </div>
          <div class="logo-text">PlaasRisk</div>
        </div>
        
        <div class="control-group">
          <div class="input-with-icon">
            <i class="fas fa-search input-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Enter coordinates or location (e.g. -25.0, 30.0 or Johannesburg)" />
            <div id="suggestions" class="suggestions-box"></div>
          </div>
          
          <button class="btn btn-primary" onclick="searchLocation()">
            <i class="fas fa-search-location"></i> Search
          </button>
          
          <!-- Progress bar moved next to GPS input -->
          <div class="progress-container">
            <div class="progress-header">
              <span>Data Retrieval</span>
              <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
              <div class="progress-label" id="progress-label">Ready</div>
            </div>
          </div>
        </div>
        
        <div class="map-actions">
          <button class="btn btn-outline" onclick="resetMap()">
            <i class="fas fa-trash-alt"></i> Clear
          </button>
          <button class="btn btn-primary" onclick="generateReport()" id="generateBtn">
            <i class="fas fa-chart-line"></i> Analyze
          </button>
          <button class="btn btn-outline" id="dropPinBtn" onclick="activatePinMode()">
            <i class="fas fa-map-pin"></i> Drop Pin
          </button>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
    
    <footer>
      <p>Farm Climate Analysis Tool • Data provided by Open-Meteo Historical Weather API</p>
      <p style="margin-top: 5px; font-size: 0.8rem; color: #777;">Platform developed by Macdonald Makoro: 076-623-2221</p>
    </footer>
  </div>
  
  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text">Notification message</span>
  </div>
  
  <!-- PDF Loading Overlay -->
  <div class="pdf-loading-overlay" id="pdfLoading">
    <div class="pdf-spinner"></div>
    <h3>Generating PDF Report</h3>
    <p>Please wait while we prepare your full report...</p>
  </div>
  
  <!-- Report Modal -->
  <div class="report-modal" id="reportModal">
    <div class="report-content">
      <!-- Report Letterhead -->
      <div class="letterhead">
        <div class="letterhead-content">
          <div class="letterhead-logo">
            <div class="plaasrisk-logo">
              <i class="fas fa-seedling logo-icon"></i>
            </div>
            <div>
              <h1 class="logo-text">PlaasRisk</h1>
              <p>Advanced Farm Climate Analysis</p>
            </div>
          </div>
          <div class="letterhead-text">
            <p>Date: <span id="reportDate">${new Date().toLocaleDateString()}</span></p>
            <p>Prepared for: <strong>Macdonald Makoro</strong></p>
          </div>
        </div>
      </div>
      
      <div class="report-header">
        <h2 class="report-title">
          <i class="fas fa-file-alt"></i>
          Farm Climate Analysis Report
        </h2>
        <button class="close-report" onclick="closeReport()">&times;</button>
      </div>
      
      <div class="report-body">
        <div class="report-header-section">
          <h2><i class="fas fa-tractor"></i> Farm Climate Risk Assessment</h2>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-temperature-low"></i> Temperature Analysis</h3>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Average Temp</div>
              <div class="stat-value" id="avgTempValue">21.4°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Temp</div>
              <div class="stat-value" id="maxTempValue">34.2°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Min Temp</div>
              <div class="stat-value" id="minTempValue">-1.3°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Warming Trend</div>
              <div class="stat-value" id="warmingValue">+1.2°C</div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-cloud-rain"></i> Precipitation Analysis</h3>
          <div class="chart-container">
            <canvas id="precipitationChart"></canvas>
          </div>
          
          <div class="chart-container" style="margin-top: 25px;">
            <canvas id="annualRainfallChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Annual Avg</div>
              <div class="stat-value" id="annualPrecip">625 mm</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Monthly</div>
              <div class="stat-value" id="maxMonthlyPrecip">210 mm</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Dry Spells</div>
              <div class="stat-value" id="drySpells">3.2/yr</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Trend</div>
              <div class="stat-value" id="precipTrend">-8%</div>
            </div>
          </div>
        </div>
        
        <!-- New Frost Analysis Section -->
        <div class="report-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis & Temperature Comparison</h3>
          <div class="chart-container">
            <canvas id="frostComparisonChart"></canvas>
          </div>
          
          <div class="key-indicators">
            <div class="indicator">
              <div class="indicator-color" style="background-color: #e74c3c;"></div>
              <span>Current Year Temperatures</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #3498db;"></div>
              <span>Historical Average</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #bbdefb;"></div>
              <span>Frost Threshold (0°C)</span>
            </div>
          </div>
          
          <div class="frost-months" id="frostMonthsList">
            <!-- Months will be populated here -->
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Frost Days This Year</div>
              <div class="stat-value" id="totalFrost">18</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Average Frost Days/Year</div>
              <div class="stat-value" id="avgFrost">15.2</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Coldest Month</div>
              <div class="stat-value" id="coldestMonth">January</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Frost Risk Level</div>
              <div class="stat-value" id="frostRisk">High</div>
            </div>
          </div>
          
          <div class="highlight-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Frost Advisory</h3>
            <p id="frostAdvisoryText">Based on the current data, there is a high probability of frost incidents in the upcoming week. Farmers should take necessary precautions to protect sensitive crops.</p>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis</h3>
          <div class="chart-container">
            <canvas id="frostChart"></canvas>
          </div>
          
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with High Frost Occurrence</h4>
              <div class="years-list" id="highFrostYears">
                <div class="year-badge frost">2010</div>
                <div class="year-badge frost">2012</div>
                <div class="year-badge frost">2015</div>
                <div class="year-badge frost">2018</div>
                <div class="year-badge frost">2021</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-tint-slash"></i> Drought Analysis</h3>
          <div class="chart-container">
            <canvas id="droughtChart"></canvas>
          </div>
          
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Moderate Drought</h4>
              <div class="years-list" id="moderateDroughtYears">
                <div class="year-badge moderate-drought">2005</div>
                <div class="year-badge moderate-drought">2009</div>
                <div class="year-badge moderate-drought">2016</div>
              </div>
            </div>
            
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Severe Drought</h4>
              <div class="years-list" id="severeDroughtYears">
                <div class="year-badge severe-drought">2019</div>
                <div class="year-badge severe-drought">2023</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Prediction Section -->
        <div class="prediction-section">
          <div class="prediction-header">
            <i class="fas fa-crystal-ball" style="font-size: 2.5rem;"></i>
            <h3>2025 Climate Prediction</h3>
          </div>
          
          <div class="prediction-content">
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-temperature-high"></i>
                <h4>Temperature Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedTemp">22.8°C</div>
              <div class="prediction-label">Annual Average</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>1.4°C above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="tempGauge" style="width: 75%; background: linear-gradient(90deg, #4fc3f7, #e57373);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span>
                <span>Average</span>
                <span>High</span>
              </div>
            </div>
            
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-tint"></i>
                <h4>Precipitation Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedPrecip">580 mm</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-down">
                <i class="fas fa-arrow-down"></i>
                <span>7% below average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="precipGauge" style="width: 65%; background: linear-gradient(90deg, #81c784, #4fc3f7);"></div>
              </div>
              <div class="gauge-labels">
                <span>Dry</span>
                <span>Average</span>
                <span>Wet</span>
              </div>
            </div>
            
            <!-- Frost Prediction Card -->
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-snowflake"></i>
                <h4>Frost Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedFrost">18 days</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>3 days above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="frostGauge" style="width: 70%; background: linear-gradient(90deg, #bbdefb, #1e88e5);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span>
                <span>Average</span>
                <span>High</span>
              </div>
              <div class="frost-risk">
                <div class="risk-indicator risk-high"></div>
                <span>High Frost Risk Expected</span>
              </div>
            </div>
          </div>
          
          <div class="prediction-footer">
            <p><i class="fas fa-info-circle"></i> <span id="predictionSummary">Predictions based on historical trends and seasonal forecasting models. This forecast indicates a warmer and drier year ahead with increased frost risk. Farmers should prepare for potential water shortages, consider heat-tolerant crop varieties, and implement frost protection measures.</span></p>
          </div>
        </div>
        
        <!-- Commentary Section -->
        <div class="commentary-section">
          <h3><i class="fas fa-comment-alt"></i> Climate Commentary</h3>
          <div class="commentary-content" id="climateCommentary">
            <p>The analysis reveals a warming trend of +1.2°C over the past 25 years, with precipitation decreasing by 8% during the same period. This indicates significant climate shifts that may impact agricultural planning.</p>
            
            <h4>Frost Analysis</h4>
            <p>High frost occurrences were most notable in 2010, 2012, 2015, 2018, and 2021, posing risks to sensitive crops during winter months. These frost events primarily occurred during the months of June to August. The prediction for the upcoming year shows an increased frost risk of 18 days, which is significantly above the historical average.</p>
            
            <div class="parameters-box">
              <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
            </div>
            
            <h4 class="drought-header">Drought Analysis</h4>
            <p>Drought conditions were recorded in several years, with moderate drought in 2005, 2009 and 2016, and severe drought in 2019 and 2023. The most prolonged drought period occurred from March to November in 2016.</p>
            
            <div class="drought-classification">
              <div class="drought-class moderate-drought-box">
                <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
                <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
              
              <div class="drought-class severe-drought-box">
                <h5><i class="fas fa-fire"></i> Severe Drought</h5>
                <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
            </div>
            
            <p>These patterns suggest increasing challenges for water management and crop selection in the coming years. Farmers should consider implementing advanced irrigation techniques and selecting drought-resistant crop varieties.</p>
          </div>
        </div>
        
        <div class="report-section" style="grid-column: 1 / -1; margin-top: 0;">
          <h3><i class="fas fa-lightbulb"></i> Farming Recommendations</h3>
          <ul style="padding-left: 20px; margin-top: 15px;" id="farmingRecommendations">
            <li style="margin-bottom: 10px;">Plant frost-resistant crops during winter months in high-risk years</li>
            <li style="margin-bottom: 10px;">Implement water harvesting systems to mitigate drought impact</li>
            <li style="margin-bottom: 10px;">Use drought-tolerant crop varieties in anticipation of dry spells</li>
            <li style="margin-bottom: 10px;">Schedule planting to avoid peak frost periods in high-risk years</li>
            <li style="margin-bottom: 10px;">Install frost protection systems in vulnerable areas</li>
            <li style="margin-bottom: 10px;">Monitor frost forecasts closely during high-risk months (May-August)</li>
            <li style="margin-bottom: 10px;">Consider crop insurance for frost and drought protection</li>
          </ul>
        </div>
      </div>
      
      <div class="report-footer">
        <div class="location-info">
          <div class="location-badge">
            <i class="fas fa-map-marker-alt"></i>
            <span id="reportLocation">-25.0, 30.0 (South Africa)</span>
          </div>
          <div class="location-badge">
            <i class="fas fa-calendar"></i>
            <span>2000 - 2024</span>
          </div>
        </div>
        
        <div class="report-actions">
          <button class="download-btn" onclick="downloadReport()">
            <i class="fas fa-download"></i> Download Report (PDF)
          </button>
          <button class="download-btn" onclick="printReport()" style="background: #5e35b1;">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="close-btn" onclick="closeReport()">
            <i class="fas fa-times"></i> Close Report
          </button>
        </div>
      </div>
      
      <!-- Prepared by section -->
      <div class="prepared-by">
        Prepared by: <strong>Macdonald Makoro</strong>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([-25.0, 30.0], 5); // Set to South Africa coordinates
    
    // Add tile layer
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add administrative boundaries layer
    const adminBoundaries = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      opacity: 0.3
    });
    
    // Add layer control
    const baseLayers = {
      "Standard Map": osmLayer
    };
    
    const overlays = {
      "Administrative Boundaries": adminBoundaries
    };
    
    L.control.layers(baseLayers, overlays).addTo(map);
    
    // Add a marker to South Africa
    L.marker([-25.0, 30.0]).addTo(map)
      .bindPopup('South Africa')
      .openPopup();

    // Initialize layers and controls
    let drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    let lastPolygonCenter = null;
    let currentMarker = null;
    let dataAvailable = false;
    let pinModeActive = false;
    let geocodeTimeout = null;
    let currentRequest = null;
    let currentLocationName = "South Africa";
    
    const drawControl = new L.Control.Draw({
      draw: {
        polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#2e7d32' } },
        polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
      },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    // Fix for mobile devices - invalidate map size after initialization
    setTimeout(() => {
      map.invalidateSize();
    }, 100);

    // Progress bar function
    function updateProgress(percentage, text) {
      const fill = document.getElementById('progress-fill');
      const label = document.getElementById('progress-label');
      const percentageDisplay = document.getElementById('progress-percentage');
      
      if (fill) fill.style.width = `${percentage}%`;
      if (label) label.textContent = text;
      if (percentageDisplay) percentageDisplay.textContent = `${Math.round(percentage)}%`;
    }
    
    // Show notification
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notification-text');
      
      notification.className = `notification ${type}`;
      notificationText.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => notification.classList.remove('show'), 3000);
    }
    
    // Open report modal
    function openReport(data) {
      const modal = document.getElementById('reportModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Initialize charts with data
      initCharts(data);
      
      // Update report date
      document.getElementById('reportDate').textContent = new Date().toLocaleDateString();
      
      showNotification("Report generated successfully!", "success");
    }
    
    // Close report modal
    function closeReport() {
      const modal = document.getElementById('reportModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    
    // Print report
    function printReport() {
      window.print();
    }
    
    // Download report as PDF - IMPROVED VERSION
    function downloadReport() {
      const loadingOverlay = document.getElementById('pdfLoading');
      loadingOverlay.style.display = 'flex';
      
      const reportContent = document.querySelector('.report-content');
      const originalHeight = reportContent.style.height;
      const originalOverflow = reportContent.style.overflow;
      
      // Temporarily make content visible for capture
      reportContent.style.height = 'auto';
      reportContent.style.overflow = 'visible';
      
      // Add report title to each page
      const header = document.createElement('div');
      header.innerHTML = `
        <div style="position:fixed; top:10px; left:0; right:0; text-align:center; font-size:14px; color:#2e7d32; z-index:9999;">
          PlaasRisk Climate Report - ${new Date().toLocaleDateString()}
        </div>
      `;
      document.body.appendChild(header);
      
      html2canvas(reportContent, {
        scale: 3,
        useCORS: true,
        logging: false,
        onclone: function(clonedDoc) {
          clonedDoc.body.appendChild(header.cloneNode(true));
        }
      }).then(canvas => {
        // Remove temporary elements
        document.body.removeChild(header);
        
        // Restore original styles
        reportContent.style.height = originalHeight;
        reportContent.style.overflow = originalOverflow;
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        let pageCount = 1;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add page number to first page
        pdf.setFontSize(10);
        pdf.text(`Page ${pageCount}`, imgWidth - 20, pageHeight - 10);
        pageCount++;
        
        // Add additional pages if needed
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          
          // Add page number
          pdf.text(`Page ${pageCount}`, imgWidth - 20, pageHeight - 10);
          pageCount++;
          
          heightLeft -= pageHeight;
        }
        
        // Save the PDF
        pdf.save(`PlaasRisk_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        loadingOverlay.style.display = 'none';
        showNotification("Report downloaded successfully!", 'success');
      })
      .catch(error => {
        console.error('Error generating PDF:', error);
        document.body.removeChild(header);
        loadingOverlay.style.display = 'none';
        showNotification("Failed to generate PDF. Try the print option.", 'error');
      });
    }
    
    // Initialize charts in report
    function initCharts(data) {
      // Temperature chart
      const tempCtx = document.getElementById('temperatureChart').getContext('2d');
      new Chart(tempCtx, {
        type: 'line',
        data: {
          labels: data.temp.labels,
          datasets: [{
            label: 'Average Temperature (°C)',
            data: data.temp.values,
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Average Temperature Trend',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Temperature (°C)' }
            }
          }
        }
      });
      
      // Precipitation chart
      const precipCtx = document.getElementById('precipitationChart').getContext('2d');
      new Chart(precipCtx, {
        type: 'bar',
        data: {
          labels: data.precip.labels,
          datasets: [{
            label: 'Average Precipitation (mm)',
            data: data.precip.values,
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Monthly Precipitation Averages',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Precipitation (mm)' }
            }
          }
        }
      });
      
      // Annual Rainfall Chart
      const annualRainfallCtx = document.getElementById('annualRainfallChart').getContext('2d');
      new Chart(annualRainfallCtx, {
        type: 'bar',
        data: {
          labels: data.annualRainfall.labels,
          datasets: [{
            label: 'Annual Rainfall (mm)',
            data: data.annualRainfall.values,
            backgroundColor: '#4caf50',
            borderColor: '#2e7d32',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Rainfall Totals',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Rainfall (mm)' }
            }
          }
        }
      });
      
      // Frost chart
      const frostCtx = document.getElementById('frostChart').getContext('2d');
      new Chart(frostCtx, {
        type: 'line',
        data: {
          labels: data.frost.labels,
          datasets: [{
            label: 'Frost Days per Year',
            data: data.frost.values,
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30, 136, 229, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Frost Days',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Days per Year' }
            }
          }
        }
      });
      
      // Drought chart
      const droughtCtx = document.getElementById('droughtChart').getContext('2d');
      new Chart(droughtCtx, {
        type: 'bar',
        data: {
          labels: data.drought.labels,
          datasets: [{
            label: 'Rainfall Departure (%)',
            data: data.drought.values,
            backgroundColor: data.drought.values.map(value => {
              if (value < -50) return '#f44336'; // Severe drought
              if (value < -26) return '#ff9800'; // Moderate drought
              return '#8d6e63'; // Normal
            }),
            borderColor: '#6d4c41',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Rainfall Departure from Average',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Percentage Departure (%)' }
            }
          }
        }
      });
      
      // Frost Comparison Chart
      const frostComparisonCtx = document.getElementById('frostComparisonChart').getContext('2d');
      new Chart(frostComparisonCtx, {
        type: 'line',
        data: {
          labels: data.frostComparison.labels,
          datasets: [
            {
              label: 'Current Year Temperatures',
              data: data.frostComparison.currentTemps,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3
            },
            {
              label: 'Historical Average',
              data: data.frostComparison.historicalTemps,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Temperature Comparison with Frost Analysis',
              font: { size: 16 }
            },
            annotation: {
              annotations: {
                line1: {
                  type: 'line',
                  yMin: 0,
                  yMax: 0,
                  borderColor: '#bbdefb',
                  borderWidth: 2,
                  borderDash: [5, 5]
                }
              }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'Temperature (°C)' }
            }
          }
        }
      });
      
      // Update stats
      document.getElementById('avgTempValue').textContent = `${data.stats.avgTemp}°C`;
      document.getElementById('maxTempValue').textContent = `${data.stats.maxTemp}°C`;
      document.getElementById('minTempValue').textContent = `${data.stats.minTemp}°C`;
      document.getElementById('warmingValue').textContent = `${data.stats.warming >= 0 ? '+' : ''}${data.stats.warming}°C`;
      document.getElementById('annualPrecip').textContent = `${data.stats.annualPrecip} mm`;
      document.getElementById('maxMonthlyPrecip').textContent = `${data.stats.maxMonthlyPrecip} mm`;
      document.getElementById('drySpells').textContent = `${data.stats.drySpells}/yr`;
      document.getElementById('precipTrend').textContent = `${data.stats.precipTrend >= 0 ? '+' : ''}${data.stats.precipTrend}%`;
      document.getElementById('reportLocation').textContent = `${data.location.coords} (${data.location.name})`;
      
      // Update frost stats
      document.getElementById('totalFrost').textContent = data.stats.totalFrost;
      document.getElementById('avgFrost').textContent = data.stats.avgFrost;
      document.getElementById('coldestMonth').textContent = data.stats.coldestMonth;
      document.getElementById('frostRisk').textContent = data.stats.frostRisk;
      
      // Update years with frost
      const highFrostYears = document.getElementById('highFrostYears');
      highFrostYears.innerHTML = '';
      data.stats.highFrostYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge frost';
        badge.textContent = year;
        highFrostYears.appendChild(badge);
      });
      
      // Update frost months
      const frostMonthsList = document.getElementById('frostMonthsList');
      frostMonthsList.innerHTML = '';
      data.stats.frostMonths.forEach(month => {
        const tag = document.createElement('div');
        tag.className = `month-tag ${month.hasFrost ? 'frost-month' : 'normal-month'}`;
        tag.textContent = `${month.name}: ${month.frostDays} frost days`;
        frostMonthsList.appendChild(tag);
      });
      
      // Update drought years
      const moderateDroughtYears = document.getElementById('moderateDroughtYears');
      moderateDroughtYears.innerHTML = '';
      data.stats.moderateDroughtYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge moderate-drought';
        badge.textContent = year;
        moderateDroughtYears.appendChild(badge);
      });
      
      const severeDroughtYears = document.getElementById('severeDroughtYears');
      severeDroughtYears.innerHTML = '';
      data.stats.severeDroughtYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge severe-drought';
        badge.textContent = year;
        severeDroughtYears.appendChild(badge);
      });
      
      // Update prediction values
      document.getElementById('predictedTemp').textContent = `${data.prediction.temp}°C`;
      document.getElementById('predictedPrecip').textContent = `${data.prediction.precip} mm`;
      document.getElementById('predictedFrost').textContent = `${data.prediction.frost} days`;
      
      // Update frost advisory
      const frostAdvisory = document.getElementById('frostAdvisoryText');
      if (data.stats.frostRisk === 'High') {
        frostAdvisory.textContent = `Based on the current data, there is a high probability of frost incidents in the upcoming week. The region has experienced ${data.stats.totalFrost} frost days this year, which is above the historical average. Farmers should take necessary precautions to protect sensitive crops.`;
      } else if (data.stats.frostRisk === 'Moderate') {
        frostAdvisory.textContent = `The frost risk for this region is moderate. While frost events are possible, they are less frequent than in high-risk areas. Farmers should monitor weather forecasts during colder months.`;
      } else {
        frostAdvisory.textContent = `This region has a low frost risk. Frost events are rare, but farmers should still be prepared for occasional cold snaps during winter months.`;
      }
      
      // Update prediction summary
      const predictionSummary = document.getElementById('predictionSummary');
      predictionSummary.textContent = `Predictions based on historical trends and seasonal forecasting models. This forecast indicates a ${data.prediction.temp > data.stats.avgTemp ? 'warmer' : 'cooler'} and ${data.prediction.precip > data.stats.annualPrecip ? 'wetter' : 'drier'} year ahead with ${data.prediction.frost > data.stats.avgFrost ? 'increased' : 'decreased'} frost risk. Farmers should prepare accordingly.`;
      
      // Generate climate commentary
      generateClimateCommentary(data);
      
      // Generate farming recommendations
      generateFarmingRecommendations(data);
    }
    
    // Generate climate commentary
    function generateClimateCommentary(data) {
      const commentary = document.getElementById('climateCommentary');
      
      // Generate commentary based on data
      commentary.innerHTML = `
        <p>The climate analysis for <strong>${data.location.name}</strong> (${data.location.coords}) reveals a ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend of <strong>${Math.abs(data.stats.warming)}°C</strong> over the past ${data.temp.labels.length} years. Precipitation has ${data.stats.precipTrend >= 0 ? 'increased' : 'decreased'} by <strong>${Math.abs(data.stats.precipTrend)}%</strong> during the same period. This indicates significant climate shifts that may affect crop selection and growing seasons.</p>
        
        <h4>Frost Analysis</h4>
        <p>${data.stats.highFrostYears.length > 0 ? `High frost events occurred in <strong>${data.stats.highFrostYears.join(', ')}</strong>,` : 'Frost events in this region have been relatively infrequent,'} which ${data.stats.highFrostYears.length > 0 ? 'presents challenges' : 'minimizes risks'} for frost-sensitive crops. The ${data.stats.highFrostYears.length > 0 ? `highest number of frost days (${Math.max(...data.frost.values)}) was recorded in ${data.stats.highFrostYears[0]}.` : 'region experiences minimal frost impact.'} Frost typically occurs between ${data.stats.coldestMonth} and ${getWarmestMonth(data.stats.frostMonths)} in this region. The prediction for the upcoming year shows <strong>${data.prediction.frost} frost days</strong>, which is ${data.prediction.frost > data.stats.avgFrost ? 'above' : 'below'} the historical average.</p>
        
        <div class="parameters-box">
          <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
        </div>
        
        <h4 class="drought-header">Drought Analysis</h4>
        <p>${data.stats.severeDroughtYears.length > 0 ? `Drought conditions were most severe in <strong>${data.stats.severeDroughtYears.join(', ')}</strong>,` : 'This region has experienced relatively stable precipitation patterns,'} ${data.stats.severeDroughtYears.length > 0 ? 'requiring careful water management planning.' : 'with minimal drought impact.'} ${data.stats.moderateDroughtYears.length > 0 ? `Moderate drought conditions were recorded in <strong>${data.stats.moderateDroughtYears.join(', ')}</strong>.` : ''} The ${data.stats.severeDroughtYears.length > 0 ? `most significant rainfall departure was ${Math.min(...data.drought.values).toFixed(1)}% in ${data.stats.severeDroughtYears[0]}.` : 'precipitation patterns show consistent reliability.'}</p>
        
        <div class="drought-classification">
          <div class="drought-class moderate-drought-box">
            <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
            <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
          
          <div class="drought-class severe-drought-box">
            <h5><i class="fas fa-fire"></i> Severe Drought</h5>
            <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
        </div>
        
        <p>Based on these patterns, farmers should consider implementing appropriate water conservation techniques and ${data.stats.frostRisk !== 'Low' ? 'selecting frost-resistant crop varieties.' : 'focusing on optimal planting schedules.'} The ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend suggests that ${data.stats.warming >= 0 ? 'heat-tolerant' : 'cold-resistant'} varieties may become increasingly important in the coming decades.</p>
      `;
    }
    
    // Generate farming recommendations based on analysis
    function generateFarmingRecommendations(data) {
      const recommendations = document.getElementById('farmingRecommendations');
      recommendations.innerHTML = '';
      
      // Base recommendations
      const baseRecommendations = [
        "Monitor weather forecasts regularly for timely decision-making",
        "Maintain soil health through proper crop rotation and organic matter addition",
        "Implement integrated pest management strategies"
      ];
      
      // Frost-specific recommendations
      const frostRecommendations = [];
      if (data.stats.frostRisk === 'High') {
        frostRecommendations.push(
          "Plant frost-resistant crops during winter months",
          "Install frost protection systems in vulnerable areas",
          "Schedule planting to avoid peak frost periods",
          "Consider crop insurance for frost protection"
        );
      } else if (data.stats.frostRisk === 'Moderate') {
        frostRecommendations.push(
          "Have frost protection measures ready for unexpected cold snaps",
          "Monitor frost forecasts closely during high-risk months",
          "Consider frost-tolerant varieties for sensitive crops"
        );
      }
      
      // Drought-specific recommendations
      const droughtRecommendations = [];
      if (data.stats.severeDroughtYears.length > 0 || data.stats.precipTrend < -5) {
        droughtRecommendations.push(
          "Implement water harvesting systems to mitigate drought impact",
          "Use drought-tolerant crop varieties",
          "Practice conservation tillage to retain soil moisture",
          "Consider drip irrigation for efficient water use"
        );
      }
      
      // Temperature trend recommendations
      const tempRecommendations = [];
      if (data.stats.warming > 0.5) {
        tempRecommendations.push(
          "Consider heat-tolerant crop varieties",
          "Adjust planting schedules to avoid peak heat periods",
          "Implement shading strategies for sensitive crops"
        );
      }
      
      // Combine all recommendations
      const allRecommendations = [
        ...baseRecommendations,
        ...frostRecommendations,
        ...droughtRecommendations,
        ...tempRecommendations
      ];
      
      // Add to DOM
      allRecommendations.forEach(rec => {
        const li = document.createElement('li');
        li.style.marginBottom = '10px';
        li.textContent = rec;
        recommendations.appendChild(li);
      });
    }
    
    // Helper function to get warmest month from frost data
    function getWarmestMonth(frostMonths) {
      let minFrost = Infinity;
      let warmestMonth = 'December';
      
      frostMonths.forEach(month => {
        if (month.frostDays < minFrost) {
          minFrost = month.frostDays;
          warmestMonth = month.name;
        }
      });
      
      return warmestMonth;
    }

    // Event handlers
    map.on(L.Draw.Event.CREATED, function (e) {
      if (e.layerType === 'polygon') {
        const layer = e.layer;
        const latlngs = layer.getLatLngs()[0];
        
        if (latlngs.length < 3) {
          showNotification("Please draw a valid polygon with at least 3 points", "error");
          return;
        }
        
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);

        const latSum = latlngs.reduce((sum, pt) => sum + pt.lat, 0);
        const lngSum = latlngs.reduce((sum, pt) => sum + pt.lng, 0);
        const center = {
          lat: latSum / latlngs.length,
          lng: lngSum / latlngs.length
        };
        lastPolygonCenter = center;
        
        // Update search input with coordinates
        document.getElementById('searchInput').value = `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        
        showNotification(`Farm boundary drawn at ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 'success');
        
        checkDataAvailability(center.lat, center.lng);
      }
    });
    
    // Function to check data availability
    function checkDataAvailability(lat, lng) {
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        updateProgress(progress, `Checking data availability... ${progress}%`);
        
        if (progress >= 100) {
          clearInterval(interval);
          
          const isLand = !(lat < -60 || lat > 60 || Math.abs(lng) > 170);
          const isRemote = Math.abs(lat) > 55 || Math.abs(lng) > 140;
          
          if (!isLand) {
            showNotification("No data available (ocean location)", "error");
            dataAvailable = false;
          } else if (isRemote) {
            showNotification("Limited data available (remote area)", "warning");
            dataAvailable = true;
          } else {
            showNotification("Reliable data available", "success");
            dataAvailable = true;
          }
        }
      }, 200);
    }

    // Activate pin drop mode
    function activatePinMode() {
      pinModeActive = true;
      document.getElementById('dropPinBtn').classList.add('btn-primary');
      document.getElementById('dropPinBtn').classList.remove('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Click on Map';
      
      // Add event listener for map click
      map.on('click', handleMapClick);
      
      showNotification("Click on the map to drop a pin", 'info');
    }
    
    // Handle map click for pin drop
    function handleMapClick(e) {
      if (!pinModeActive) return;
      
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      
      // Clear any existing markers
      if (currentMarker) map.removeLayer(currentMarker);
      
      // Add new marker
      currentMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup("Dropped Pin: " + lat.toFixed(4) + ", " + lng.toFixed(4))
        .openPopup();
      
      // Update search input
      document.getElementById("searchInput").value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      lastPolygonCenter = { lat, lng };
      
      // Check data availability
      checkDataAvailability(lat, lng);
      
      // Deactivate pin mode
      pinModeActive = false;
      document.getElementById('dropPinBtn').classList.remove('btn-primary');
      document.getElementById('dropPinBtn').classList.add('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Drop Pin';
      
      // Remove event listener
      map.off('click', handleMapClick);
      
      showNotification(`Pin dropped at ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
    }
    
    // Location input suggestions
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value;
      if (query.length < 3) {
        document.getElementById('suggestions').style.display = 'none';
        return;
      }
      
      // Clear any existing timeout
      if (geocodeTimeout) clearTimeout(geocodeTimeout);
      
      // Set timeout to avoid too many requests
      geocodeTimeout = setTimeout(() => {
        geocodeLocation(query, true);
      }, 500);
    });
    
    // Search location by text or coordinates
    function searchLocation() {
      const query = document.getElementById('searchInput').value;
      if (!query) {
        showNotification("Enter coordinates or location name to search", 'error');
        return;
      }
      
      // Check if input looks like coordinates
      const coordPattern = /^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)$/;
      const match = query.match(coordPattern);
      
      if (match) {
        // It's coordinates
        const lat = parseFloat(match[1]);
        const lng = parseFloat(match[3]);
        
        if (!isNaN(lat) && !isNaN(lng)) {
          map.setView([lat, lng], 13);
          
          if (currentMarker) map.removeLayer(currentMarker);
          
          currentMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup("Searched Location: " + lat + ", " + lng).openPopup();
          lastPolygonCenter = { lat, lng };
          currentLocationName = "Custom Location";
          showNotification(`Location set to: ${lat}, ${lng}`, 'success');
          
          checkDataAvailability(lat, lng);
        } else {
          showNotification("Invalid coordinates. Please enter in 'latitude, longitude' format.", 'error');
        }
      } else {
        // It's a location name
        geocodeLocation(query);
      }
    }
    
    // Fixed geocoding function with better error handling
    function geocodeLocation(query, forSuggestions = false) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`;
      
      // Cancel previous request if any
      if (currentRequest) {
        currentRequest.abort();
      }
      
      const controller = new AbortController();
      const signal = controller.signal;
      currentRequest = controller;
      
      fetch(url, { signal })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          if (forSuggestions) {
            // Show suggestions
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';
            
            if (data.length === 0) {
              suggestions.style.display = 'none';
              return;
            }
            
            // Use document fragment for efficient DOM updates
            const fragment = document.createDocumentFragment();
            data.forEach(item => {
              const suggestion = document.createElement('div');
              suggestion.className = 'suggestion-item';
              suggestion.textContent = item.display_name;
              suggestion.onclick = () => {
                document.getElementById('searchInput').value = item.display_name;
                suggestions.style.display = 'none';
                
                // Set the location on the map
                const lat = parseFloat(item.lat);
                const lon = parseFloat(item.lon);
                map.setView([lat, lon], 13);
                
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.marker([lat, lon]).addTo(map)
                  .bindPopup(item.display_name)
                  .openPopup();
                
                lastPolygonCenter = { lat, lng: lon };
                currentLocationName = item.display_name;
                checkDataAvailability(lat, lon);
                
                showNotification(`Location set to: ${item.display_name}`, 'success');
              };
              fragment.appendChild(suggestion);
            });
            
            suggestions.appendChild(fragment);
            suggestions.style.display = 'block';
          } else {
            // Process actual search
            if (data.length === 0) {
              showNotification("Location not found. Please try a different name.", 'error');
              return;
            }
            
            const item = data[0];
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            
            map.setView([lat, lon], 13);
            
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(map)
              .bindPopup(item.display_name)
              .openPopup();
            
            lastPolygonCenter = { lat, lng: lon };
            currentLocationName = item.display_name;
            checkDataAvailability(lat, lon);
            
            showNotification(`Location set to: ${item.display_name}`, 'success');
          }
        })
        .catch(error => {
          if (error.name === 'AbortError') {
            console.log('Request aborted');
          } else {
            console.error('Geocoding error:', error);
            if (!forSuggestions) {
              showNotification("Error finding location. Please try again.", 'error');
            }
          }
        })
        .finally(() => {
          currentRequest = null;
        });
    }

    // Reset map
    function resetMap() {
      drawnItems.clearLayers();
      lastPolygonCenter = null;
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
      map.setView([-25.0, 30.0], 5);
      document.getElementById("searchInput").value = "";
      document.getElementById('suggestions').style.display = 'none';
      currentLocationName = "South Africa";
      
      // Reset progress bar
      updateProgress(0, 'Ready');
      
      // Reset pin mode if active
      if (pinModeActive) {
        pinModeActive = false;
        map.off('click', handleMapClick);
        document.getElementById('dropPinBtn').classList.remove('btn-primary');
        document.getElementById('dropPinBtn').classList.add('btn-outline');
        document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Drop Pin';
      }
    }

    // Generate report with real climate data
    async function generateReport() {
      if (!lastPolygonCenter) {
        showNotification("Draw a farm boundary or search a location first.", 'error');
        return;
      }
      
      if (!dataAvailable) {
        showNotification("No data available for this location. Please choose another location.", 'error');
        return;
      }

      const lat = lastPolygonCenter.lat.toFixed(4);
      const lon = lastPolygonCenter.lng.toFixed(4);
      
      // Show loading state
      updateProgress(10, "Starting analysis...");
      document.getElementById('generateBtn').disabled = true;
      
      try {
        // Simulate analysis process
        let progress = 10;
        const interval = setInterval(() => {
          progress += 5;
          updateProgress(progress, `Analyzing climate data... ${progress}%`);
          
          if (progress >= 95) {
            clearInterval(interval);
            
            // Generate sample data for demonstration
            const sampleData = generateSampleData(lat, lon);
            
            // Small delay to show completion
            setTimeout(() => {
              updateProgress(100, "Analysis complete!");
              openReport(sampleData);
              document.getElementById('generateBtn').disabled = false;
            }, 500);
          }
        }, 100);
      } catch (error) {
        console.error('Error generating report:', error);
        showNotification("Error generating report. Please try again.", 'error');
        document.getElementById('generateBtn').disabled = false;
      }
    }
    
    // Generate sample data for demonstration
    function generateSampleData(lat, lon) {
      const years = Array.from({length: 25}, (_, i) => 2000 + i);
      const yearLabels = years.map(y => y.toString());
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      
      // Generate annual data
      const annualAvgTemp = years.map(() => +(14 + Math.random() * 6).toFixed(2)); // 14-20°C
      const annualPrecip = years.map(() => +(500 + Math.random() * 400).toFixed(2)); // 500-900mm
      const annualFrostDays = years.map(() => Math.floor(Math.random() * 20)); // 0-20 frost days
      
      // Calculate averages
      const avgTemp = +(annualAvgTemp.reduce((a, b) => a + b, 0) / annualAvgTemp.length).toFixed(1);
      const avgPrecip = +(annualPrecip.reduce((a, b) => a + b, 0) / annualPrecip.length).toFixed(1);
      const avgFrost = +(annualFrostDays.reduce((a, b) => a + b, 0) / annualFrostDays.length).toFixed(1);
      
      // Generate monthly data (for latest year only)
      const monthlyPrecip = Array.from({length: 12}, () => +(30 + Math.random() * 90).toFixed(1));
      const currentYearTemps = Array.from({length: 12}, () => +(10 + Math.random() * 10).toFixed(1));
      const historicalTemps = Array.from({length: 12}, () => +(8 + Math.random() * 8).toFixed(1));
      
      // Calculate trends
      const warmingTrend = +(annualAvgTemp[annualAvgTemp.length - 1] - annualAvgTemp[0]).toFixed(2);
      const precipTrend = +(((annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / annualPrecip[0]) * 100).toFixed(2);
      
      // Determine years with high frost
      const highFrostYears = years.filter((_, i) => annualFrostDays[i] > 15);
      
      // Determine drought years
      const moderateDroughtYears = years.filter((_, i) => annualPrecip[i] < avgPrecip * 0.74);
      const severeDroughtYears = years.filter((_, i) => annualPrecip[i] < avgPrecip * 0.5);
      
      // Generate frost months data
      const frostMonths = monthNames.map((name, index) => {
        // More frost in winter months (June-August in Southern Hemisphere)
        const frostDays = (index <= 2 || index >= 10) ? Math.floor(Math.random() * 6) : 0;
        return { name, frostDays, hasFrost: frostDays > 0 };
      });
      
      // Determine coldest month
      const coldestMonthIndex = currentYearTemps.indexOf(Math.min(...currentYearTemps));
      const coldestMonth = monthNames[coldestMonthIndex];
      
      // Determine frost risk
      const currentFrostDays = annualFrostDays[annualFrostDays.length - 1];
      const frostRisk = currentFrostDays > 15 ? 'High' : currentFrostDays > 10 ? 'Moderate' : 'Low';
      
      // Calculate dry spells
      const drySpellCount = monthlyPrecip.filter(p => p < 30).length;
      
      // Generate prediction for next year
      const nextYear = years[years.length - 1] + 1;
      const predictedTemp = +(annualAvgTemp[annualAvgTemp.length - 1] + 0.4).toFixed(1);
      const predictedPrecip = Math.max(0, +(annualPrecip[annualPrecip.length - 1] * 0.96).toFixed(0));
      const predictedFrost = Math.max(0, currentFrostDays + 1);
      
      // Calculate rainfall standard deviation
      const precipStdDev = +Math.sqrt(
        annualPrecip.reduce((sum, val) => sum + Math.pow(val - avgPrecip, 2), 0) / annualPrecip.length
      ).toFixed(1);
      
      return {
        location: {
          coords: `${lat}, ${lon}`,
          name: typeof currentLocationName !== 'undefined' ? currentLocationName : "Unknown Location"
        },
        temp: {
          labels: yearLabels,
          values: annualAvgTemp
        },
        precip: {
          labels: monthNames,
          values: monthlyPrecip
        },
        annualRainfall: {
          labels: yearLabels,
          values: annualPrecip
        },
        frost: {
          labels: yearLabels,
          values: annualFrostDays
        },
        drought: {
          labels: yearLabels,
          values: annualPrecip.map(p => +(((p - avgPrecip) / avgPrecip) * 100).toFixed(1))
        },
        frostComparison: {
          labels: monthNames,
          currentTemps: currentYearTemps,
          historicalTemps: historicalTemps
        },
        rainfallAnalysis: {
          averageAnnual: avgPrecip,
          maxAnnual: +(Math.max(...annualPrecip)).toFixed(1),
          minAnnual: +(Math.min(...annualPrecip)).toFixed(1),
          stdDev: precipStdDev,
          precipTrend: precipTrend,
          moderateDroughtCount: moderateDroughtYears.length,
          severeDroughtCount: severeDroughtYears.length
        },
        stats: {
          avgTemp,
          maxTemp: +(Math.max(...annualAvgTemp)).toFixed(1),
          minTemp: +(Math.min(...annualAvgTemp)).toFixed(1),
          warming: warmingTrend,
          annualPrecip: avgPrecip,
          maxMonthlyPrecip: Math.max(...monthlyPrecip).toFixed(1),
          drySpells: drySpellCount,
          precipTrend,
          highFrostYears,
          moderateDroughtYears,
          severeDroughtYears,
          totalFrost: currentFrostDays,
          avgFrost,
          coldestMonth,
          frostRisk,
          frostMonths
        },
        prediction: {
          year: nextYear,
          temp: predictedTemp,
          precip: predictedPrecip,
          frost: predictedFrost
        }
      };
    }
    
    // Future climate simulation function
    function simulateFutureClimate(baseData, yearsToSimulate = 25, scenario = 'moderate') {
      const warmingRate = scenario === 'severe' ? 0.35 : 0.2; // °C per decade
      const precipChangeRate = scenario === 'severe' ? -0.02 : 0; // % per year
      const frostReductionRate = scenario === 'severe' ? -0.8 : -0.4; // days/year
      
      const startYear = baseData.prediction.year;
      const futureYears = Array.from({length: yearsToSimulate}, (_, i) => startYear + i);
      const yearLabels = futureYears.map(y => y.toString());
      
      let lastTemp = parseFloat(baseData.prediction.temp);
      let lastPrecip = parseFloat(baseData.prediction.precip);
      let lastFrost = parseInt(baseData.prediction.frost);
      
      const futureTemps = [];
      const futurePrecip = [];
      const futureFrostDays = [];
      
      for (let i = 0; i < yearsToSimulate; i++) {
        lastTemp += warmingRate;
        futureTemps.push(+lastTemp.toFixed(2));
        
        lastPrecip += lastPrecip * precipChangeRate;
        futurePrecip.push(+lastPrecip.toFixed(1));
        
        lastFrost = Math.max(0, lastFrost + frostReductionRate);
        futureFrostDays.push(Math.round(lastFrost));
      }
      
      return {
        labels: yearLabels,
        temp: futureTemps,
        precip: futurePrecip,
        frost: futureFrostDays,
        scenario: scenario,
        fromYear: startYear,
        toYear: startYear + yearsToSimulate - 1,
        assumptions: {
          warmingRate: `${warmingRate}°C/decade`,
          precipChange: `${(precipChangeRate * 100).toFixed(1)}%/year`,
          frostReduction: `${frostReductionRate} days/year`
        }
      };
    }
    
    // Initialize progress bar
    updateProgress(0, 'Ready');
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      const suggestions = document.getElementById('suggestions');
      const searchInput = document.getElementById('searchInput');
      
      if (suggestions && searchInput) {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.style.display = 'none';
        }
      }
    });
    
    // Handle window resize for mobile devices
    window.addEventListener('resize', function() {
      if (map) {
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      }
    });
  </script>
</body>
</html>
