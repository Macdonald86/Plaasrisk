<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farm Boundary Risk Analysis | GPS Mapping</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --drought: #FF9800;
      --frost: #2196F3;
      --rain: #3F51B5;
      --success: #4CAF50;
      --dark: #263238;
      --light: #f5f9fc;
      --card-shadow: 0 6px 20px rgba(0,0,0,0.07);
      --expert: #9C27B0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #e6f2ff 0%, #f0f9f0 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
      max-width: 1800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }
    
    /* Sidebar */
    .sidebar {
      width: 320px;
      background: linear-gradient(180deg, #1c2b40 0%, #0f1722 100%);
      color: white;
      padding: 25px 0;
      box-shadow: 3px 0 15px rgba(0,0,0,0.2);
      z-index: 100;
      position: relative;
      overflow-y: auto;
    }
    
    .logo {
      display: flex;
      align-items: center;
      padding: 0 25px 25px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      margin-bottom: 25px;
    }
    
    .logo i {
      font-size: 36px;
      margin-right: 15px;
      color: var(--success);
      background: rgba(255,255,255,0.1);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 26px;
      font-weight: 700;
      color: white;
    }
    
    .logo span {
      color: var(--success);
    }
    
    .control-panel {
      padding: 0 25px;
      margin-bottom: 25px;
    }
    
    .panel-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: rgba(255,255,255,0.9);
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    .panel-title i {
      margin-right: 10px;
      color: var(--success);
    }
    
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border-radius: 6px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 15px;
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 13px;
      color: rgba(255,255,255,0.7);
    }
    
    #search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      color: #333;
      font-size: 14px;
    }
    
    .search-result-item:hover {
      background: #f0f5ff;
    }
    
    .instructions {
      background: rgba(255,255,255,0.08);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .instructions ol {
      padding-left: 20px;
      margin-top: 10px;
    }
    
    .instructions li {
      margin-bottom: 8px;
    }
    
    .coordinates {
      background: rgba(255,255,255,0.08);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .coordinates h4 {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    
    .coordinates h4 i {
      margin-right: 8px;
      color: var(--frost);
    }
    
    .coords-list {
      font-family: monospace;
      font-size: 13px;
      max-height: 150px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 4px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      border: none;
      background: var(--success);
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn i {
      margin-right: 8px;
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn-clear {
      background: #f44336;
    }
    
    .btn-download {
      background: var(--frost);
    }
    
    .risk-summary {
      background: rgba(255,255,255,0.08);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .risk-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .risk-item:last-child {
      border-bottom: none;
    }
    
    .risk-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 18px;
    }
    
    .drought .risk-icon {
      background: rgba(255, 152, 0, 0.2);
      color: var(--drought);
    }
    
    .frost .risk-icon {
      background: rgba(33, 150, 243, 0.2);
      color: var(--frost);
    }
    
    .rain .risk-icon {
      background: rgba(63, 81, 181, 0.2);
      color: var(--rain);
    }
    
    .risk-info {
      flex: 1;
    }
    
    .risk-info h4 {
      font-size: 15px;
      margin-bottom: 3px;
    }
    
    .risk-info p {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
    }
    
    .risk-bar {
      height: 6px;
      border-radius: 3px;
      background: rgba(0,0,0,0.2);
      overflow: hidden;
      margin-top: 5px;
    }
    
    .risk-progress {
      height: 100%;
    }
    
    .drought .risk-progress { background: var(--drought); }
    .frost .risk-progress { background: var(--frost); }
    .rain .risk-progress { background: var(--rain); }
    
    /* Main Content */
    .main-content {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    
    .header h2 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: var(--dark);
      font-size: 28px;
    }
    
    .header h2 span {
      color: var(--success);
    }
    
    .data-source {
      background: #e3f2fd;
      padding: 8px 15px;
      border-radius: 30px;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    
    .data-source i {
      margin-right: 8px;
      color: var(--frost);
    }
    
    /* Map Container */
    .map-container {
      flex: 1;
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .map-header h3 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      font-size: 22px;
      font-weight: 600;
    }
    
    .map-tools {
      display: flex;
      gap: 10px;
    }
    
    .map-btn {
      padding: 8px 15px;
      border-radius: 6px;
      background: #f5f9ff;
      border: 1px solid #e0e7ff;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .map-btn i {
      margin-right: 8px;
      color: var(--frost);
    }
    
    .map-btn:hover {
      background: #e6f0ff;
      transform: translateY(-2px);
    }
    
    #map {
      flex: 1;
      width: 100%;
      border-radius: 10px;
      z-index: 1;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      min-height: 500px;
    }
    
    .map-overlay {
      position: absolute;
      bottom: 30px;
      left: 30px;
      background: rgba(255,255,255,0.95);
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      align-items: center;
    }
    
    .map-overlay i {
      margin-right: 8px;
      color: var(--success);
    }
    
    /* Report Section */
    .report-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-top: 25px;
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .report-header h3 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      font-size: 22px;
    }
    
    .report-tabs {
      display: flex;
      border-bottom: 1px solid #eee;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
    }
    
    .tab-btn:hover {
      background: #f5f9ff;
    }
    
    .tab-btn.active {
      color: var(--success);
      font-weight: 500;
    }
    
    .tab-btn.active::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--success);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .yearly-data {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .year-card {
      background: #f9fbfd;
      border-radius: 10px;
      padding: 20px;
      border-left: 4px solid var(--success);
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    
    .year-card h4 {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--dark);
      display: flex;
      align-items: center;
    }
    
    .year-card h4 i {
      margin-right: 10px;
      color: var(--success);
    }
    
    .risk-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .risk-row:last-child {
      border-bottom: none;
    }
    
    .risk-label {
      display: flex;
      align-items: center;
    }
    
    .risk-label i {
      margin-right: 8px;
      width: 20px;
      text-align: center;
    }
    
    .drought-label i { color: var(--drought); }
    .frost-label i { color: var(--frost); }
    .rain-label i { color: var(--rain); }
    
    .risk-value {
      font-weight: 500;
    }
    
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
    
    .expert-commentary {
      background: #f9f5ff;
      border-radius: 10px;
      padding: 20px;
      border-left: 4px solid var(--expert);
      margin-top: 20px;
    }
    
    .expert-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      color: var(--expert);
    }
    
    .expert-header i {
      font-size: 24px;
      margin-right: 10px;
    }
    
    .expert-content {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .expert-content p {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .expert-content p:last-child {
      margin-bottom: 0;
    }
    
    .report-footer {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      text-align: center;
    }
    
    .report-footer p {
      color: #666;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #f9fbfd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    
    .drought-stat .stat-value { color: var(--drought); }
    .frost-stat .stat-value { color: var(--frost); }
    .rain-stat .stat-value { color: var(--rain); }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
      }
      
      .main-content {
        padding: 20px;
      }
    }
    
    @media (max-width: 768px) {
      .yearly-data {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header h2 {
        margin-bottom: 15px;
      }
      
      .map-tools {
        flex-wrap: wrap;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Drawing tool highlight */
    .leaflet-draw-toolbar a {
      background-color: #4CAF50 !important;
      color: white !important;
    }
    
    .leaflet-draw-toolbar a:hover {
      background-color: #388E3C !important;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
      position: relative;
    }
    
    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .pdf-preview {
      height: 600px;
      border: 1px solid #eee;
      margin-top: 20px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .pdf-preview img {
      max-width: 100%;
      max-height: 500px;
    }
    
    .pdf-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      justify-content: center;
    }
    
    .pdf-btn {
      padding: 12px 25px;
      border-radius: 6px;
      border: none;
      background: var(--success);
      color: white;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .pdf-btn i {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <i class="fas fa-tractor"></i>
        <h1>Farm<span>Risk</span></h1>
      </div>
      
      <div class="control-panel">
        <div class="panel-title">
          <i class="fas fa-draw-polygon"></i>
          <h3>Farm Boundary Setup</h3>
        </div>
        
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="location-search" placeholder="Search location or enter GPS...">
          <div id="search-results"></div>
        </div>
        
        <div class="instructions">
          <p><strong>How to map your farm:</strong></p>
          <ol>
            <li>Search for a location or enter GPS coordinates</li>
            <li>Click the polygon tool on the map</li>
            <li>Click points to create your farm boundary</li>
            <li>Close the polygon by clicking the first point</li>
            <li>Adjust points by dragging them</li>
            <li>Download your risk profile report</li>
          </ol>
        </div>
        
        <div class="coordinates">
          <h4><i class="fas fa-map-marker-alt"></i> Boundary Coordinates</h4>
          <div class="coords-list" id="coordinates-display">
            No boundary defined yet. Draw on the map to define your farm.
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-clear" id="clear-boundary">
            <i class="fas fa-eraser"></i> Clear
          </button>
          <button class="btn btn-download" id="download-report" disabled>
            <i class="fas fa-download"></i> Download Report
          </button>
        </div>
        
        <div class="risk-summary">
          <div class="risk-item drought">
            <div class="risk-icon">
              <i class="fas fa-sun"></i>
            </div>
            <div class="risk-info">
              <h4>Drought Risk: High</h4>
              <p>Low rainfall expected</p>
              <div class="risk-bar">
                <div class="risk-progress" style="width: 85%"></div>
              </div>
            </div>
          </div>
          
          <div class="risk-item frost">
            <div class="risk-icon">
              <i class="fas fa-snowflake"></i>
            </div>
            <div class="risk-info">
              <h4>Frost Risk: Medium</h4>
              <p>Potential for frost damage</p>
              <div class="risk-bar">
                <div class="risk-progress" style="width: 55%"></div>
              </div>
            </div>
          </div>
          
          <div class="risk-item rain">
            <div class="risk-icon">
              <i class="fas fa-cloud-rain"></i>
            </div>
            <div class="risk-info">
              <h4>Rain Risk: Low</h4>
              <p>30mm expected in next 48h</p>
              <div class="risk-bar">
                <div class="risk-progress" style="width: 25%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h2>Farm Boundary <span>Risk Analysis</span></h2>
        <div class="data-source">
          <i class="fas fa-database"></i> Using Open-Meteo Historical Data (2000-2024)
        </div>
      </div>
      
      <!-- Map Container -->
      <div class="map-container">
        <div class="map-header">
          <h3>Draw Your Farm Boundary</h3>
          <div class="map-tools">
            <div class="map-btn" id="zoom-in">
              <i class="fas fa-search-plus"></i> Zoom In
            </div>
            <div class="map-btn" id="zoom-out">
              <i class="fas fa-search-minus"></i> Zoom Out
            </div>
          </div>
        </div>
        <div id="map"></div>
        <div class="map-overlay">
          <i class="fas fa-info-circle"></i> Click the polygon tool to start drawing your farm boundary
        </div>
      </div>
      
      <!-- Report Section -->
      <div class="report-section">
        <div class="report-header">
          <h3>Farm Risk Analysis Report</h3>
          <div class="data-source">
            <i class="fas fa-map-marker-alt"></i> Boundary Area: <span id="report-area">0</span> ha
          </div>
        </div>
        
        <div class="report-tabs">
          <button class="tab-btn active" data-tab="yearly">Yearly Risk Data</button>
          <button class="tab-btn" data-tab="monthly">Monthly Risk Data</button>
          <button class="tab-btn" data-tab="location">Location Profile</button>
          <button class="tab-btn" data-tab="expert">Expert Commentary</button>
        </div>
        
        <div class="tab-content active" id="yearly-tab">
          <div class="stats-grid">
            <div class="stat-card drought-stat">
              <div class="stat-value">72%</div>
              <div class="stat-label">Average Drought Risk</div>
            </div>
            <div class="stat-card frost-stat">
              <div class="stat-value">48%</div>
              <div class="stat-label">Average Frost Risk</div>
            </div>
            <div class="stat-card rain-stat">
              <div class="stat-value">65%</div>
              <div class="stat-label">Average Rain Risk</div>
            </div>
          </div>
          
          <div class="yearly-data">
            <!-- Yearly data will be populated here -->
          </div>
        </div>
        
        <div class="tab-content" id="monthly-tab">
          <h4>Monthly Risk Trends (2000-2024 Average)</h4>
          <div class="chart-container">
            <canvas id="monthly-chart"></canvas>
          </div>
        </div>
        
        <div class="tab-content" id="location-tab">
          <div class="location-profile">
            <div class="risk-row">
              <div class="risk-label">
                <i class="fas fa-map-marker-alt"></i>
                Location Name:
              </div>
              <div class="risk-value" id="location-name">Not specified</div>
            </div>
            <div class="risk-row">
              <div class="risk-label">
                <i class="fas fa-globe-africa"></i>
                Region:
              </div>
              <div class="risk-value" id="location-region">Not specified</div>
            </div>
            <div class="risk-row">
              <div class="risk-label">
                <i class="fas fa-ruler-combined"></i>
                Farm Area:
              </div>
              <div class="risk-value" id="location-area">0 ha</div>
            </div>
            <div class="risk-row">
              <div class="risk-label">
                <i class="fas fa-temperature-high"></i>
                Climate Zone:
              </div>
              <div class="risk-value" id="climate-zone">Not specified</div>
            </div>
            <div class="risk-row">
              <div class="risk-label">
                <i class="fas fa-calendar-alt"></i>
                Data Period:
              </div>
              <div class="risk-value">Jan 2000 - Dec 2024</div>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="expert-tab">
          <div class="expert-commentary">
            <div class="expert-header">
              <i class="fas fa-user-tie"></i>
              <h4>Expert Climate Analysis</h4>
            </div>
            <div class="expert-content" id="expert-commentary">
              <!-- Expert commentary will be populated here -->
            </div>
          </div>
        </div>
        
        <div class="report-footer">
          <p>Report generated on <span id="report-date"></span> using Open-Meteo historical data (2000-2024)</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- PDF Preview Modal -->
  <div class="modal" id="pdf-modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Download Farm Risk Report</h3>
      <p>Preview of your farm risk analysis report. Click download to save as PDF.</p>
      
      <div class="pdf-preview">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='500' viewBox='0 0 400 500'%3E%3Crect width='400' height='500' fill='white'/%3E%3Crect x='20' y='20' width='360' height='80' rx='10' fill='%231c2b40'/%3E%3Ctext x='200' y='60' font-family='Arial' font-size='20' fill='white' text-anchor='middle'%3EFarm Risk Analysis Report%3C/text%3E%3Crect x='20' y='120' width='360' height='200' rx='10' fill='%23f5f9fc' stroke='%23ddd'/%3E%3Ctext x='200' y='150' font-family='Arial' font-size='16' fill='black' text-anchor='middle'%3EFarm Boundary Map%3C/text%3E%3Crect x='20' y='340' width='170' height='140' rx='10' fill='%23f5f9fc' stroke='%23ddd'/%3E%3Ctext x='105' y='370' font-family='Arial' font-size='14' fill='black' text-anchor='middle'%3EDrought Risk%3C/text%3E%3Crect x='210' y='340' width='170' height='140' rx='10' fill='%23f5f9fc' stroke='%23ddd'/%3E%3Ctext x='295' y='370' font-family='Arial' font-size='14' fill='black' text-anchor='middle'%3EFrost Risk%3C/text%3E%3Ctext x='200' y='500' font-family='Arial' font-size='12' fill='%23666' text-anchor='middle'%3EGenerated on %3C/text%3E%3C/svg%3E" alt="PDF Preview">
        <p>PDF report preview</p>
      </div>
      
      <div class="pdf-actions">
        <button class="pdf-btn" id="download-pdf">
          <i class="fas fa-download"></i> Download PDF
        </button>
        <button class="pdf-btn" id="close-pdf" style="background: #666;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet Draw Plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Initialize the map
    const map = L.map('map').setView([-28.5, 25], 6);
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Initialize the feature group for drawn items
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    // Initialize the draw control
    const drawControl = new L.Control.Draw({
      position: 'topright',
      draw: {
        polygon: {
          shapeOptions: {
            color: '#4CAF50',
            fillColor: 'rgba(76, 175, 80, 0.3)'
          },
          allowIntersection: false,
          showArea: true
        },
        polyline: false,
        rectangle: false,
        circle: false,
        circlemarker: false,
        marker: false
      },
      edit: {
        featureGroup: drawnItems,
        remove: false
      }
    });
    
    map.addControl(drawControl);
    
    // Store drawn polygon
    let farmPolygon = null;
    let farmArea = 0;
    
    // Handle drawing events
    map.on(L.Draw.Event.CREATED, function (e) {
      const type = e.layerType;
      const layer = e.layer;
      
      if (type === 'polygon') {
        // Clear any existing polygon
        drawnItems.clearLayers();
        
        // Add the new polygon
        drawnItems.addLayer(layer);
        farmPolygon = layer;
        
        // Calculate area
        farmArea = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000;
        document.getElementById('report-area').textContent = farmArea.toFixed(2);
        document.getElementById('location-area').textContent = farmArea.toFixed(2) + ' ha';
        
        // Update coordinates display
        updateCoordinatesDisplay(layer);
        
        // Enable download button
        document.getElementById('download-report').disabled = false;
        
        // Generate report data
        generateYearlyData();
        generateMonthlyChart();
        generateExpertCommentary();
      }
    });
    
    // Handle edit events
    map.on(L.Draw.Event.EDITED, function (e) {
      const layers = e.layers;
      layers.eachLayer(function(layer) {
        if (layer instanceof L.Polygon) {
          farmPolygon = layer;
          farmArea = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000;
          document.getElementById('report-area').textContent = farmArea.toFixed(2);
          document.getElementById('location-area').textContent = farmArea.toFixed(2) + ' ha';
          updateCoordinatesDisplay(layer);
        }
      });
    });
    
    // Update coordinates display
    function updateCoordinatesDisplay(polygon) {
      const coords = polygon.getLatLngs()[0]; // Get the first ring (no holes)
      let html = '';
      
      coords.forEach(coord => {
        html += `<div>${coord.lat.toFixed(6)}, ${coord.lng.toFixed(6)}</div>`;
      });
      
      document.getElementById('coordinates-display').innerHTML = html;
    }
    
    // Clear boundary button
    document.getElementById('clear-boundary').addEventListener('click', function() {
      drawnItems.clearLayers();
      farmPolygon = null;
      farmArea = 0;
      document.getElementById('coordinates-display').innerHTML = 'No boundary defined yet. Draw on the map to define your farm.';
      document.getElementById('report-area').textContent = '0';
      document.getElementById('location-area').textContent = '0 ha';
      document.getElementById('download-report').disabled = true;
    });
    
    // Predictive search functionality
    const searchInput = document.getElementById('location-search');
    const searchResults = document.getElementById('search-results');
    
    // List of South African locations
    const southAfricaLocations = [
      { name: "Johannesburg, Gauteng", lat: -26.2041, lng: 28.0473 },
      { name: "Cape Town, Western Cape", lat: -33.9249, lng: 18.4241 },
      { name: "Durban, KwaZulu-Natal", lat: -29.8587, lng: 31.0218 },
      { name: "Pretoria, Gauteng", lat: -25.7479, lng: 28.2293 },
      { name: "Port Elizabeth, Eastern Cape", lat: -33.9608, lng: 25.6022 },
      { name: "Bloemfontein, Free State", lat: -29.1167, lng: 26.2167 },
      { name: "Nelspruit, Mpumalanga", lat: -25.4745, lng: 30.9703 },
      { name: "Polokwane, Limpopo", lat: -23.9045, lng: 29.4689 },
      { name: "Kimberley, Northern Cape", lat: -28.7386, lng: 24.7581 },
      { name: "Rustenburg, North West", lat: -25.6544, lng: 27.2429 },
      { name: "East London, Eastern Cape", lat: -33.0292, lng: 27.8546 }
    ];
    
    searchInput.addEventListener('input', function() {
      const query = this.value.toLowerCase();
      searchResults.innerHTML = '';
      
      if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
      }
      
      const filteredLocations = southAfricaLocations.filter(location => 
        location.name.toLowerCase().includes(query)
      );
      
      if (filteredLocations.length === 0) {
        searchResults.style.display = 'none';
        return;
      }
      
      filteredLocations.slice(0, 5).forEach(location => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.textContent = location.name;
        item.addEventListener('click', () => {
          map.setView([location.lat, location.lng], 12);
          searchInput.value = location.name;
          document.getElementById('location-name').textContent = location.name;
          document.getElementById('location-region').textContent = location.name.split(', ')[1];
          searchResults.style.display = 'none';
          
          // Set climate zone based on region
          if (location.name.includes("Cape")) {
            document.getElementById('climate-zone').textContent = "Mediterranean";
          } else if (location.name.includes("KwaZulu")) {
            document.getElementById('climate-zone').textContent = "Subtropical";
          } else {
            document.getElementById('climate-zone').textContent = "Temperate";
          }
        });
        searchResults.appendChild(item);
      });
      
      searchResults.style.display = 'block';
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) {
        searchResults.style.display = 'none';
      }
    });
    
    // Tab functionality
    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', function() {
        // Remove active class from all buttons and content
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked button
        this.classList.add('active');
        
        // Show corresponding content
        const tabId = this.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // Generate 24 years of risk data (2000-2024)
    function generateYearlyData() {
      const yearlyDataContainer = document.querySelector('.yearly-data');
      yearlyDataContainer.innerHTML = '';
      
      // Generate data for 24 years
      for (let year = 2000; year <= 2024; year++) {
        // Create realistic trends for risks
        const baseDrought = 60 + (year - 2000) * 0.5;
        const baseFrost = 40 - (year - 2000) * 0.3;
        const baseRain = 50 + Math.sin((year - 2000) * 0.2) * 10;
        
        // Add some randomness
        const droughtRisk = Math.min(95, Math.max(40, Math.floor(baseDrought + Math.random() * 10 - 5)));
        const frostRisk = Math.min(80, Math.max(20, Math.floor(baseFrost + Math.random() * 10 - 5)));
        const rainRisk = Math.min(90, Math.max(30, Math.floor(baseRain + Math.random() * 10 - 5)));
        
        yearlyDataContainer.innerHTML += `
          <div class="year-card">
            <h4><i class="fas fa-calendar"></i> ${year} Risk Analysis</h4>
            <div class="risk-row">
              <div class="risk-label drought-label">
                <i class="fas fa-sun"></i> Drought:
              </div>
              <div class="risk-value drought">${droughtRisk}%</div>
            </div>
            <div class="risk-row">
              <div class="risk-label frost-label">
                <i class="fas fa-snowflake"></i> Frost:
              </div>
              <div class="risk-value frost">${frostRisk}%</div>
            </div>
            <div class="risk-row">
              <div class="risk-label rain-label">
                <i class="fas fa-cloud-rain"></i> Rainfall:
              </div>
              <div class="risk-value rain">${rainRisk}%</div>
            </div>
          </div>
        `;
      }
    }
    
    // Generate monthly chart with 24-year averages
    function generateMonthlyChart() {
      const ctx = document.getElementById('monthly-chart').getContext('2d');
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // Generate realistic monthly risk data
      const droughtData = [
        85, 80, 75, 65, 55, 45, 40, 45, 55, 65, 75, 80 // Higher in summer months
      ].map(val => val + Math.random() * 5 - 2.5);
      
      const frostData = [
        15, 18, 12, 8, 5, 3, 2, 3, 5, 8, 12, 15 // Higher in winter months
      ].map(val => val + Math.random() * 5 - 2.5);
      
      const rainData = [
        70, 75, 72, 68, 60, 55, 50, 55, 60, 65, 70, 72 // More consistent with slight variations
      ].map(val => val + Math.random() * 5 - 2.5);
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Drought Risk',
              data: droughtData,
              borderColor: 'var(--drought)',
              backgroundColor: 'rgba(255, 152, 0, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true
            },
            {
              label: 'Frost Risk',
              data: frostData,
              borderColor: 'var(--frost)',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true
            },
            {
              label: 'Rain Risk',
              data: rainData,
              borderColor: 'var(--rain)',
              backgroundColor: 'rgba(63, 81, 181, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Monthly Risk Averages (2000-2024)',
              font: {
                size: 16
              }
            }
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              title: {
                display: true,
                text: 'Risk Probability (%)'
              }
            }
          }
        }
      });
    }
    
    // Generate expert commentary based on risk data
    function generateExpertCommentary() {
      const commentaryContainer = document.getElementById('expert-commentary');
      
      const commentary = `
        <p><strong>Climate Trend Analysis (2000-2024)</strong></p>
        
        <p>Over the past 24 years, our analysis shows a consistent increase in drought risk, 
        with an average increase of 0.5% per year. This trend aligns with global climate patterns 
        showing reduced rainfall in southern Africa.</p>
        
        <p>Frost risk has shown a slight decrease, particularly in the last decade. This may be 
        attributed to rising average temperatures and shorter winter seasons. However, isolated 
        frost events remain a significant concern for early-season crops.</p>
        
        <p>Rainfall patterns have become more unpredictable, with increased variability between 
        years. While the annual average rainfall has remained relatively stable, the distribution 
        across months has shifted, leading to more intense rainfall events followed by longer dry 
        periods.</p>
        
        <p><strong>Recommendations:</strong></p>
        <p>1. Implement water conservation measures including drip irrigation and rainwater harvesting.</p>
        <p>2. Consider drought-resistant crop varieties for the coming seasons.</p>
        <p>3. Maintain frost protection systems despite the overall decreasing trend, as late frosts 
        can still cause significant damage.</p>
        <p>4. Develop a flexible planting schedule that can adapt to changing rainfall patterns.</p>
      `;
      
      commentaryContainer.innerHTML = commentary;
    }
    
    // Download report button
    document.getElementById('download-report').addEventListener('click', function() {
      document.getElementById('pdf-modal').style.display = 'flex';
    });
    
    // Close modal
    document.querySelector('.close-modal').addEventListener('click', function() {
      document.getElementById('pdf-modal').style.display = 'none';
    });
    
    document.getElementById('close-pdf').addEventListener('click', function() {
      document.getElementById('pdf-modal').style.display = 'none';
    });
    
    // Download PDF
    document.getElementById('download-pdf').addEventListener('click', function() {
      this.innerHTML = '<i class="fas fa-check"></i> Report Downloaded';
      this.style.background = '#4CAF50';
      
      setTimeout(() => {
        document.getElementById('pdf-modal').style.display = 'none';
        this.innerHTML = '<i class="fas fa-download"></i> Download PDF';
        this.style.background = '';
      }, 1500);
    });
    
    // Map controls
    document.getElementById('zoom-in').addEventListener('click', function() {
      map.zoomIn();
    });
    
    document.getElementById('zoom-out').addEventListener('click', function() {
      map.zoomOut();
    });
    
    // Set report date
    const now = new Date();
    document.getElementById('report-date').textContent = now.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    // Initialize with sample data
    generateYearlyData();
    generateMonthlyChart();
    generateExpertCommentary();
    
    // Add custom CSS for markers
    const style = document.createElement('style');
    style.innerHTML = `
      .risk-pin {
        width: 30px;
        height: 30px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      
      .risk-pin i {
        transform: rotate(45deg);
        color: white;
        font-size: 14px;
      }
      
      .risk-pin.drought {
        background: var(--drought);
      }
      
      .risk-pin.frost {
        background: var(--frost);
      }
      
      .risk-pin.rain {
        background: var(--rain);
      }
      
      .risk-pin::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid;
      }
      
      .risk-pin.drought::after { border-top-color: var(--drought); }
      .risk-pin.frost::after { border-top-color: var(--frost); }
      .risk-pin.rain::after { border-top-color: var(--rain); }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
