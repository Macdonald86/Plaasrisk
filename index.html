<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlaasRisk - Phase 1</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header -->
  <header class="bg-green-700 text-white p-4 shadow">
    <h1 class="text-2xl font-bold text-center">🌱 PlaasRisk Dashboard</h1>
    <p class="text-center text-sm">Field-based climate & NDVI risk monitoring</p>
  </header>

  <!-- Search -->
  <div class="p-4 flex gap-2 justify-center bg-white shadow">
    <input id="searchBox" type="text" placeholder="Search by place or GPS (lat,lon)" class="p-2 border rounded w-1/2">
    <button onclick="searchLocation()" class="bg-green-600 hover:bg-green-800 text-white px-4 py-2 rounded">Search</button>
  </div>

  <!-- Map -->
  <div id="map" class="h-96 w-full"></div>

  <!-- Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
    <div class="bg-white rounded shadow p-4">
      <h2 class="text-lg font-semibold">🌧️ Rainfall (last 120 days)</h2>
      <canvas id="rainChart"></canvas>
    </div>
    <div class="bg-white rounded shadow p-4">
      <h2 class="text-lg font-semibold">🌱 NDVI Index (simulated)</h2>
      <canvas id="ndviChart"></canvas>
    </div>
  </div>

  <!-- Risk Score -->
  <div class="p-4 text-center">
    <div id="riskScore" class="text-2xl font-bold text-green-700">Risk Score: --</div>
  </div>

<script>
  // Init map
  const map = L.map("map").setView([-28.5, 24.7], 6);

  // Base map
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // NDVI overlay (NASA GIBS)
  L.tileLayer(
    "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_16Day/{z}/{y}/{x}.jpg",
    {
      attribution: "NASA GIBS",
      maxZoom: 9
    }
  ).addTo(map);

  // Draw controls
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { circle: false, marker: false }
  }).addTo(map);

  // Handle polygon drawing
  map.on("draw:created", async function (e) {
    drawnItems.clearLayers();
    const layer = e.layer;
    drawnItems.addLayer(layer);

    const centroid = layer.getBounds().getCenter();
    fetchWeatherData(centroid.lat, centroid.lng);
    simulateNDVI();
  });

  // Search
  async function searchLocation() {
    const query = document.getElementById("searchBox").value.trim();
    if (!query) return;

    // Check if GPS entered
    if (query.includes(",")) {
      const [lat, lon] = query.split(",").map(Number);
      map.setView([lat, lon], 10);
      return;
    }

    // Else use Nominatim
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.length > 0) {
      const { lat, lon } = data[0];
      map.setView([lat, lon], 10);
    } else {
      alert("Location not found.");
    }
  }

  // Rainfall chart
  let rainChart;
  async function fetchWeatherData(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=precipitation_sum&past_days=120&timezone=Africa%2FJohannesburg`;
    const res = await fetch(url);
    const data = await res.json();
    const labels = data.daily.time;
    const values = data.daily.precipitation_sum;

    if (rainChart) rainChart.destroy();
    rainChart = new Chart(document.getElementById("rainChart"), {
      type: "line",
      data: {
        labels,
        datasets: [{ label: "Rainfall (mm)", data: values, borderColor: "blue", fill: false }]
      }
    });

    calculateRisk(values);
  }

  // NDVI chart (simulated seasonal curve for now)
  let ndviChart;
  function simulateNDVI() {
    const labels = Array.from({ length: 16 }, (_, i) => `Week ${i + 1}`);
    const values = labels.map((_, i) => 0.2 + 0.4 * Math.sin(i / 2));

    if (ndviChart) ndviChart.destroy();
    ndviChart = new Chart(document.getElementById("ndviChart"), {
      type: "line",
      data: {
        labels,
        datasets: [{ label: "NDVI", data: values, borderColor: "green", fill: false }]
      }
    });
  }

  // Risk calculation (basic)
  function calculateRisk(rainValues) {
    const avgRain = rainValues.reduce((a, b) => a + b, 0) / rainValues.length;
    let risk = 50;

    if (avgRain < 100) risk += 30;
    if (avgRain > 400) risk += 10;
    if (avgRain >= 200 && avgRain <= 350) risk -= 20;

    document.getElementById("riskScore").innerText = `Risk Score: ${risk}`;
  }
</script>
</body>
</html>
