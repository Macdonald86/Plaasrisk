<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Enhanced Farm Climate Analysis</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ... Your existing CSS here ... */
</style>
</head>
<body>
<div class="container">
  <!-- ... Your HTML structure remains unchanged ... -->
</div>

<footer>
  <p>Farm Climate Analysis Tool â€¢ Data provided by <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer" aria-label="Open-Meteo Website">Open-Meteo Historical Weather API</a></p>
  <p style="margin-top: 8px; font-size: 0.8rem; color: #777;">Platform developed by Macdonald Makoro: 076-623-2221</p>
</footer>

<div id="notification" class="notification" aria-live="polite">
  <i class="fas fa-check-circle"></i>
  <span id="notification-text">Notification message</span>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// --- Utility: Debounce Function ---
function debounce(fn, delay) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn.apply(this, args), delay);
  };
}

// --- DOM Ready Helper ---
function onReady(fn) {
  if (document.readyState !== 'loading') fn();
  else document.addEventListener('DOMContentLoaded', fn);
}

onReady(function() {
  // --- Map Initialization ---
  const map = L.map('map').setView([-25.0, 30.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" rel="noopener noreferrer">OpenStreetMap</a> contributors'
  }).addTo(map);

  // --- Variables ---
  let drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  let lastPolygonCenter = null;
  let currentMarker = null;
  let dataAvailable = false;
  let monthlyData = null;
  let selectedMonth = 0;
  let pinModeActive = false;
  let geocodeTimeout = null;
  let currentRequest = null;

  // --- Debounced Location Input ---
  const locationInput = document.getElementById('locationInput');
  locationInput.addEventListener('input', debounce(function(e) {
    const query = e.target.value;
    if (query.length < 3) {
      document.getElementById('suggestions').style.display = 'none';
      return;
    }
    geocodeLocation(query, true);
  }, 300));

  // --- Accessibility: ARIA Labels Example ---
  document.getElementById('gpsInput').setAttribute('aria-label', 'GPS Coordinates');
  document.getElementById('locationInput').setAttribute('aria-label', 'Location Name');
  document.getElementById('generateBtn').setAttribute('aria-label', 'Analyze Location');
  document.getElementById('downloadBtn').setAttribute('aria-label', 'Download PDF Report');

  // --- Example: Modularized Function ---
  async function generateReport() {
    if (!lastPolygonCenter) {
      showNotification("Draw a farm boundary or search a location first.", 'error');
      return;
    }
    if (!dataAvailable) {
      showNotification("No data available for this location. Please choose another location.", 'error');
      return;
    }
    showLoadingState();
    try {
      const data = await fetchClimateData(lastPolygonCenter);
      const analysis = processClimateData(data);
      renderReport(analysis);
      showNotification("Report generated successfully!", 'success');
    } catch (err) {
      showErrorState(err);
    } finally {
      hideLoadingState();
    }
  }

  // --- Example: Show Notification ---
  function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    notification.className = `notification ${type}`;
    notificationText.textContent = message;
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3000);
  }

  // --- The rest of your logic goes here ---
  // (You can modularize other large functions similarly)
});
</script>
</body>
</html>
