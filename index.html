<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PlaasRisk - Advanced Climate Analysis</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --primary-dark: #1b5e20;
      --secondary: #388e3c;
      --accent: #f57c00;
      --accent-light: #ffb74d;
      --accent-dark: #e65100;
      --light: #f5f9f5;
      --light-gray: #f8f9fa;
      --dark: #2d3748;
      --text: #333333;
      --border: #e0e0e0;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --frost-blue: #1e88e5;
      --frost-light: #bbdefb;
      --drought-brown: #8d6e63;
      --drought-light: #efebe9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f5f9f5 0%, #e8f5e9 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 15px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .map-section {
      flex: 1;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin: 15px 0;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #map {
      flex: 1;
      z-index: 1;
      background: #e8f5e9;
    }
    /* HORIZONTAL CONTROL BAR */
    .control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px;
      background: white;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      position: relative;
      align-items: center;
      justify-content: space-between;
    }
    @media (max-width: 1200px) {
      .control-bar {
        gap: 10px;
        padding: 10px;
      }
    }
    @media (max-width: 768px) {
      .control-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 300px;
    }
    @media (max-width: 768px) {
      .control-group {
        min-width: 100%;
      }
    }
    .input-with-icon {
      position: relative;
      flex: 1;
    }
    .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 0.9rem;
    }
    .form-control {
      width: 100%;
      padding: 9px 12px 9px 35px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s;
      background: var(--light-gray);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
    }
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      background: white;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      gap: 6px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(46, 125, 50, 0.25);
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      font-weight: 500;
    }
    .btn-outline:hover {
      background: rgba(46, 125, 50, 0.08);
    }
    .btn-sm {
      padding: 7px 10px;
      font-size: 0.85rem;
    }
    .btn-block {
      width: 100%;
    }
    .map-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .map-actions .btn {
      flex: 1;
      min-width: 110px;
    }
    @media (max-width: 768px) {
      .map-actions {
        width: 100%;
        justify-content: space-between;
      }
      .map-actions .btn {
        min-width: auto;
        flex: none;
      }
    }
    .progress-container {
      width: 200px;
      margin-left: 15px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
      color: var(--dark);
    }
    .progress-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 5px;
      width: 0%;
      transition: width 0.5s ease;
    }
    .progress-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 0.7rem;
      font-weight: 500;
      text-shadow: 0 1px 1px rgba(0,0,0,0.3);
    }
    .suggestions-box {
      position: absolute;
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 180px;
      overflow-y: auto;
      z-index: 1001;
      margin-top: 4px;
      display: none;
      border: 1px solid var(--border);
    }
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
      font-size: 0.85rem;
    }
    .suggestion-item:hover {
      background: var(--light);
    }
    .suggestion-item:last-child {
      border-bottom: none;
    }
    .notification {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(200%);
      transition: transform 0.4s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    @media (max-width: 768px) {
      .notification {
        top: auto;
        bottom: 15px;
        left: 15px;
        right: 15px;
        width: calc(100% - 30px);
      }
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background: var(--success);
    }
    .notification.error {
      background: var(--danger);
    }
    .notification.info {
      background: var(--primary);
    }
    footer {
      text-align: center;
      padding: 8px;
      color: #666;
      font-size: 0.8rem;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-top: 12px;
    }
    /* Redesigned PlaasRisk Logo */
    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 10px;
    }
    .plaasrisk-logo {
      height: 40px;
      width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: linear-gradient(135deg, #1b5e20, #4caf50);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    .logo-icon {
      color: white;
      font-size: 22px;
      position: relative;
      z-index: 2;
    }
    .logo-text {
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      position: relative;
    }
    .logo-text::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--primary);
      border-radius: 2px;
    }
    /* Report Modal */
    .report-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 3000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    .report-modal.active {
      display: block;
      opacity: 1;
    }
    .report-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      margin: 20px auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-height: 95vh;
      overflow-y: auto;
    }
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    .report-title {
      font-size: 1.8rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .close-report {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }
    .close-report:hover {
      color: var(--danger);
    }
    .report-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    @media(max-width: 992px){
      .report-body {
        grid-template-columns: 1fr;
      }
    }
    .report-section {
      background: var(--light);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .report-section h3 {
      margin-bottom: 15px;
      color: var(--primary-dark);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chart-container {
      height: 300px;
      position: relative;
      margin-top: 15px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }
    .report-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .report-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .download-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
    }
    .download-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(46, 125, 50, 0.4);
    }
    .close-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 25px;
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    .close-btn:hover {
      background: #e0e0e0;
    }
    .location-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .location-badge {
      background: var(--light);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* Years sections */
    .years-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .years-container {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .years-container h4 {
      margin-bottom: 10px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .years-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .year-badge {
      padding: 5px 10px;
      background: #e8f5e9;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .year-badge.frost {
      background: var(--frost-light);
      color: var(--frost-blue);
    }
    .year-badge.drought {
      background: var(--drought-light);
      color: var(--drought-brown);
    }
    .year-badge.moderate-drought {
      background: #ffecb3;
      color: #ff9800;
    }
    .year-badge.severe-drought {
      background: #ffcdd2;
      color: #f44336;
    }
    /* Commentary Section */
    .commentary-section {
      grid-column: 1 / -1;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid var(--primary);
    }
    .commentary-section h3 {
      color: var(--primary-dark);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .commentary-content {
      line-height: 1.7;
      padding: 10px;
    }
    .commentary-content p {
      margin-bottom: 15px;
    }
    .commentary-content h4 {
      color: var(--frost-blue);
      margin: 20px 0 10px 0;
      border-bottom: 1px solid var(--frost-light);
      padding-bottom: 5px;
    }
    .commentary-content .drought-header {
      color: var(--drought-brown);
      border-bottom: 1px solid var(--drought-light);
    }
    .parameters-box {
      background: white;
      border-left: 3px solid var(--primary);
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .drought-classification {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .drought-class {
      flex: 1;
      min-width: 200px;
      padding: 15px;
      border-radius: 8px;
      color: white;
    }
    .moderate-drought-box {
      background: linear-gradient(135deg, #ffb74d, #ff9800);
    }
    .severe-drought-box {
      background: linear-gradient(135deg, #f44336, #d32f2f);
    }
    .drought-class h5 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .drought-class p {
      font-size: 0.9rem;
      margin-bottom: 0;
    }
    /* Report Headers */
    .report-header-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .report-header-section h2 {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    /* Prediction Section */
    .prediction-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #1e88e5, #0d47a1);
      color: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }
    .prediction-section::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      z-index: 1;
    }
    .prediction-section::after {
      content: "";
      position: absolute;
      bottom: -30%;
      left: -30%;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      z-index: 1;
    }
    .prediction-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }
    .prediction-header h3 {
      font-size: 1.8rem;
      margin: 0;
    }
    .prediction-content {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }
    @media(max-width: 768px){
      .prediction-content {
        flex-direction: column;
      }
    }
    .prediction-card {
      flex: 1;
      min-width: 300px;
      background: rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .prediction-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    .prediction-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      text-align: center;
    }
    .prediction-label {
      text-align: center;
      font-size: 1rem;
      opacity: 0.9;
    }
    .prediction-trend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .trend-up {
      color: #ff7043;
    }
    .trend-down {
      color: #81c784;
    }
    .prediction-gauge {
      height: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-top: 15px;
      position: relative;
      overflow: hidden;
    }
    .gauge-fill {
      height: 100%;
      border-radius: 10px;
      position: absolute;
      left: 0;
      top: 0;
      transition: width 1s ease;
    }
    .gauge-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .prediction-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 0.9rem;
      position: relative;
      z-index: 2;
    }
    /* Frost Risk Indicator */
    .frost-risk {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
      gap: 8px;
    }
    .risk-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
    }
    .risk-low { background-color: #4caf50; }
    .risk-moderate { background-color: #ff9800; }
    .risk-high { background-color: #f44336; }

    /* Report Letterhead */
    .letterhead {
      position: relative;
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary);
    }
    .letterhead-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .letterhead-logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .letterhead-text {
      text-align: right;
    }
    .letterhead-text h1 {
      color: var(--primary-dark);
      font-size: 2.2rem;
      margin-bottom: 5px;
    }
    .letterhead-text p {
      color: #666;
      font-size: 0.9rem;
    }
    /* PDF loading overlay */
    .pdf-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 4000;
      color: white;
      display: none;
    }
    .pdf-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Prepared by section */
    .prepared-by {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--primary);
    }
    .prepared-by strong {
      color: var(--primary-dark);
    }

    /* Responsive adjustments (already included in above) */

    /* Frost Analysis Specific Styles */
    .frost-months {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .month-tag {
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .frost-month {
      background: var(--frost-light);
      color: var(--frost-blue);
    }
    .normal-month {
      background: var(--light);
      color: var(--text);
    }
    .key-indicators {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    .indicator-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    .highlight-box {
      background: linear-gradient(135deg, #1e88e5, #0d47a1);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    .highlight-box h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-section">
      <div class="control-bar">
        <div class="logo-container">
          <div class="plaasrisk-logo">
            <i class="fas fa-seedling logo-icon"></i>
          </div>
          <div class="logo-text">PlaasRisk</div>
        </div>
        <div class="control-group">
          <div class="input-with-icon" style="flex:1; position:relative;">
            <i class="fas fa-search input-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Enter coordinates or location (e.g. -25.0, 30.0 or Johannesburg)" />
            <div id="suggestions" class="suggestions-box"></div>
          </div>
          <button class="btn btn-primary" onclick="searchLocation()">
            <i class="fas fa-search-location"></i> Search
          </button>
          <!-- Progress bar moved next to GPS input -->
          <div class="progress-container">
            <div class="progress-header">
              <span>Data Retrieval</span>
              <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
              <div class="progress-label" id="progress-label">Ready</div>
            </div>
          </div>
        </div>
        <div class="map-actions">
          <button class="btn btn-outline" onclick="resetMap()">
            <i class="fas fa-trash-alt"></i> Clear
          </button>
          <button class="btn btn-primary" onclick="generateReport()" id="generateBtn">
            <i class="fas fa-chart-line"></i> Analyze
          </button>
          <button class="btn btn-outline" id="dropPinBtn" onclick="activatePinMode()">
            <i class="fas fa-map-pin"></i> Drop Pin
          </button>
        </div>
      </div>
      <div id="map"></div>
    </div>
    <footer>
      <p>Farm Climate Analysis Tool • Data provided by Open-Meteo Historical Weather API</p>
      <p style="margin-top: 5px; font-size: 0.8rem; color: #777;">Platform developed by Macdonald Makoro: 076-623-2221</p>
    </footer>
  </div>
  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text">Notification message</span>
  </div>
  <!-- PDF loading overlay -->
  <div class="pdf-loading-overlay" id="pdfLoading">
    <div class="pdf-spinner"></div>
    <h3>Generating PDF Report</h3>
    <p>Please wait while we prepare your full report...</p>
  </div>
  <!-- Report Modal -->
  <div class="report-modal" id="reportModal">
    <div class="report-content">
      <!-- Report Letterhead -->
      <div class="letterhead">
        <div class="letterhead-content">
          <div class="letterhead-logo">
            <div class="plaasrisk-logo">
              <i class="fas fa-seedling logo-icon"></i>
            </div>
            <div>
              <h1 class="logo-text">PlaasRisk</h1>
              <p>Advanced Farm Climate Analysis</p>
            </div>
          </div>
          <div class="letterhead-text">
            <p>Date: <span id="reportDate"></span></p>
            <p>Prepared for: <strong>Macdonald Makoro</strong></p>
          </div>
        </div>
      </div>
      <div class="report-header">
        <h2 class="report-title">
          <i class="fas fa-file-alt"></i> Farm Climate Analysis Report
        </h2>
        <button class="close-report" onclick="closeReport()">&times;</button>
      </div>
      <div class="report-body">
        <div class="report-header-section">
          <h2><i class="fas fa-tractor"></i> Farm Climate Risk Assessment</h2>
        </div>
        <div class="report-section">
          <h3><i class="fas fa-temperature-low"></i> Temperature Analysis</h3>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Average Temp</div>
              <div class="stat-value" id="avgTempValue">21.4°C</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Max Temp</div>
              <div class="stat-value" id="maxTempValue">34.2°C</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Min Temp</div>
              <div class="stat-value" id="minTempValue">-1.3°C</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Warming Trend</div>
              <div class="stat-value" id="warmingValue">+1.2°C</div>
            </div>
          </div>
        </div>
        <div class="report-section">
          <h3><i class="fas fa-cloud-rain"></i> Precipitation Analysis</h3>
          <div class="chart-container">
            <canvas id="precipitationChart"></canvas>
          </div>
          <div class="chart-container" style="margin-top: 25px;">
            <canvas id="annualRainfallChart"></canvas>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Annual Avg</div>
              <div class="stat-value" id="annualPrecip">625 mm</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Max Monthly</div>
              <div class="stat-value" id="maxMonthlyPrecip">210 mm</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Dry Spells</div>
              <div class="stat-value" id="drySpells">3.2/yr</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Trend</div>
              <div class="stat-value" id="precipTrend">-8%</div>
            </div>
          </div>
        </div>
        <!-- Frost Analysis & Temperature Comparison -->
        <div class="report-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis & Temperature Comparison</h3>
          <div class="chart-container">
            <canvas id="frostComparisonChart"></canvas>
          </div>
          <div class="key-indicators">
            <div class="indicator">
              <div class="indicator-color" style="background-color: #e74c3c;"></div>
              <span>Current Year Temperatures</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #3498db;"></div>
              <span>Historical Average</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #bbdefb;"></div>
              <span>Frost Threshold (0°C)</span>
            </div>
          </div>
          <div class="frost-months" id="frostMonthsList"></div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Frost Days This Year</div>
              <div class="stat-value" id="totalFrost">18</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Average Frost Days/Year</div>
              <div class="stat-value" id="avgFrost">15.2</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Coldest Month</div>
              <div class="stat-value" id="coldestMonth">January</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Frost Risk Level</div>
              <div class="stat-value" id="frostRisk">High</div>
            </div>
          </div>
          <div class="highlight-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Frost Advisory</h3>
            <p id="frostAdvisoryText">Based on the current data, there is a high probability of frost incidents in the upcoming week. Farmers should take necessary precautions to protect sensitive crops.</p>
          </div>
        </div>
        <div class="report-section">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis</h3>
          <div class="chart-container">
            <canvas id="frostChart"></canvas>
          </div>
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with High Frost Occurrence</h4>
              <div class="years-list" id="highFrostYears"></div>
            </div>
          </div>
        </div>
        <div class="report-section">
          <h3><i class="fas fa-tint-slash"></i> Drought Analysis</h3>
          <div class="chart-container">
            <canvas id="droughtChart"></canvas>
          </div>
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Moderate Drought</h4>
              <div class="years-list" id="moderateDroughtYears"></div>
            </div>
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Severe Drought</h4>
              <div class="years-list" id="severeDroughtYears"></div>
            </div>
          </div>
        </div>
        <!-- Prediction Section -->
        <div class="prediction-section">
          <div class="prediction-header">
            <i class="fas fa-crystal-ball" style="font-size: 2.5rem;"></i>
            <h3>2025 Climate Prediction</h3>
          </div>
          <div class="prediction-content">
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-temperature-high"></i>
                <h4>Temperature Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedTemp">22.8°C</div>
              <div class="prediction-label">Annual Average</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i> <span>1.4°C above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="tempGauge" style="width: 75%; background: linear-gradient(90deg, #4fc3f7, #e57373);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span> <span>Average</span> <span>High</span>
              </div>
            </div>
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-tint"></i>
                <h4>Precipitation Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedPrecip">580 mm</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-down">
                <i class="fas fa-arrow-down"></i> <span>7% below average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="precipGauge" style="width: 65%; background: linear-gradient(90deg, #81c784, #4fc3f7);"></div>
              </div>
              <div class="gauge-labels">
                <span>Dry</span> <span>Average</span> <span>Wet</span>
              </div>
            </div>
            <!-- Frost Prediction Card -->
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-snowflake"></i>
                <h4>Frost Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedFrost">18 days</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i> <span>3 days above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="frostGauge" style="width: 70%; background: linear-gradient(90deg, #bbdefb, #1e88e5);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span> <span>Average</span> <span>High</span>
              </div>
              <div class="frost-risk">
                <div class="risk-indicator risk-high"></div>
                <span>High Frost Risk Expected</span>
              </div>
            </div>
          </div>
          <div class="prediction-footer">
            <p><i class="fas fa-info-circle"></i> <span id="predictionSummary">Predictions based on historical trends and seasonal forecasting models. This forecast indicates a warmer and drier year ahead with increased frost risk. Farmers should prepare for potential water shortages, consider heat-tolerant crop varieties, and implement frost protection measures.</span></p>
          </div>
        </div>
        <!-- Climate Commentary -->
        <div class="commentary-section">
          <h3><i class="fas fa-comment-alt"></i> Climate Commentary</h3>
          <div class="commentary-content" id="climateCommentary">
            <p>The analysis reveals a warming trend of +1.2°C over the past 25 years, with precipitation decreasing by 8% during the same period. This indicates significant climate shifts that may impact agricultural planning.</p>
            <h4>Frost Analysis</h4>
            <p>High frost occurrences were most notable in 2010, 2012, 2015, 2018, and 2021, posing risks to sensitive crops during winter months. These frost events primarily occurred during the months of June to August. The prediction for the upcoming year shows an increased frost risk of 18 days, which is significantly above the historical average.</p>
            <div class="parameters-box">
              <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
            </div>
            <h4 class="drought-header">Drought Analysis</h4>
            <p>Drought conditions were recorded in several years, with moderate drought in 2005, 2009 and 2016, and severe drought in 2019 and 2023. The most prolonged drought period occurred from March to November in 2016.</p>
            <div class="drought-classification">
              <div class="drought-class moderate-drought-box">
                <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
                <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
              <div class="drought-class severe-drought-box">
                <h5><i class="fas fa-fire"></i> Severe Drought</h5>
                <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
            </div>
            <p>These patterns suggest increasing challenges for water management and crop selection in the coming years. Farmers should consider implementing advanced irrigation techniques and selecting drought-resistant crop varieties.</p>
          </div>
        </div>
        <!-- Farming Recommendations -->
        <div class="report-section" style="grid-column: 1 / -1; margin-top: 0;">
          <h3><i class="fas fa-lightbulb"></i> Farming Recommendations</h3>
          <ul style="padding-left: 20px; margin-top: 15px;" id="farmingRecommendations"></ul>
        </div>
      </div>
      <div class="report-footer">
        <div class="location-info">
          <div class="location-badge">
            <i class="fas fa-map-marker-alt"></i>
            <span id="reportLocation">-25.0, 30.0 (South Africa)</span>
          </div>
          <div class="location-badge">
            <i class="fas fa-calendar"></i>
            <span>2000 - 2024</span>
          </div>
        </div>
        <div class="report-actions">
          <button class="download-btn" onclick="downloadReport()">
            <i class="fas fa-download"></i> Download Report (PDF)
          </button>
          <button class="download-btn" onclick="printReport()" style="background: #5e35b1;">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="close-btn" onclick="closeReport()">
            <i class="fas fa-times"></i> Close Report
          </button>
        </div>
      </div>
      <!-- Prepared by -->
      <div class="prepared-by">
        Prepared by: <strong>Macdonald Makoro</strong>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([-25.0, 30.0], 5); // South Africa
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    const adminBoundaries = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      opacity: 0.3
    });
    const baseLayers = { "Standard Map": osmLayer };
    const overlays = { "Administrative Boundaries": adminBoundaries };
    L.control.layers(baseLayers, overlays).addTo(map);
    L.marker([-25.0, 30.0]).addTo(map).bindPopup('South Africa').openPopup();

    // Layers and controls
    let drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    let lastPolygonCenter = null;
    let currentMarker = null;
    let dataAvailable = false;
    let pinModeActive = false;
    let geocodeTimeout = null;
    let currentRequest = null;
    let currentLocationName = "South Africa";

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#2e7d32' } },
        polyline: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false
      },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    // Invalidate size after init
    setTimeout(() => { map.invalidateSize(); }, 100);

    // Helper functions
    function updateProgress(percentage, text) {
      const fill = document.getElementById('progress-fill');
      const label = document.getElementById('progress-label');
      const percentageDisplay = document.getElementById('progress-percentage');
      if (fill) fill.style.width = `${percentage}%`;
      if (label) label.textContent = text;
      if (percentageDisplay) percentageDisplay.textContent = `${Math.round(percentage)}%`;
    }

    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notification-text');
      notification.className = `notification ${type}`;
      notificationText.textContent = message;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function openReport(data) {
      const modal = document.getElementById('reportModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      initCharts(data);
      document.getElementById('reportDate').textContent = new Date().toLocaleDateString();
      showNotification("Report generated successfully!", "success");
    }

    function closeReport() {
      const modal = document.getElementById('reportModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    function printReport() {
      window.print();
    }

    // Generate PDF report
    async function downloadReport() {
      const loadingOverlay = document.getElementById('pdfLoading');
      loadingOverlay.style.display = 'flex';

      const reportContent = document.querySelector('.report-content');
      const originalHeight = reportContent.style.height;
      const originalOverflow = reportContent.style.overflow;

      reportContent.style.height = 'auto';
      reportContent.style.overflow = 'visible';

      // Add header to each page
      const headerDiv = document.createElement('div');
      headerDiv.innerHTML = `
        <div style="position:fixed; top:10px; left:0; right:0; text-align:center; font-size:14px; color:#2e7d32; z-index:9999;">
          PlaasRisk Climate Report - ${new Date().toLocaleDateString()}
        </div>
      `;
      document.body.appendChild(headerDiv);

      try {
        const canvas = await html2canvas(reportContent, {
          scale: 3,
          useCORS: true,
          logging: false
        });
        // Remove header div after capture
        document.body.removeChild(headerDiv);
        // Restore styles
        reportContent.style.height = originalHeight;
        reportContent.style.overflow = originalOverflow;

        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        let pageCount = 1;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // Add page numbers
        pdf.setFontSize(10);
        pdf.text(`Page ${pageCount}`, imgWidth - 20, pageHeight - 10);

        while (heightLeft > 0) {
          pdf.addPage();
          pageCount++;
          const yOffset = -(heightLeft);
          pdf.addImage(imgData, 'PNG', 0, yOffset, imgWidth, imgHeight);
          pdf.text(`Page ${pageCount}`, imgWidth - 20, pageHeight - 10);
          heightLeft -= pageHeight;
        }

        // Save PDF
        pdf.save(`PlaasRisk_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        showNotification("Report downloaded successfully!", 'success');
      } catch (err) {
        console.error('Error generating PDF:', err);
        showNotification("Failed to generate PDF. Try the print option.", 'error');
        document.body.removeChild(headerDiv);
        reportContent.style.height = originalHeight;
        reportContent.style.overflow = originalOverflow;
      } finally {
        document.getElementById('pdfLoading').style.display = 'none';
      }
    }

    // Initialize charts
    function initCharts(data) {
      // Temperature Chart
      const ctxTemp = document.getElementById('temperatureChart').getContext('2d');
      new Chart(ctxTemp, {
        type: 'line',
        data: {
          labels: data.temp.labels,
          datasets: [{
            label: 'Average Temperature (°C)',
            data: data.temp.values,
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Average Temperature Trend',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Temperature (°C)' }
            }
          }
        }
      });
      // Precipitation Chart
      const ctxPrecip = document.getElementById('precipitationChart').getContext('2d');
      new Chart(ctxPrecip, {
        type: 'bar',
        data: {
          labels: data.precip.labels,
          datasets: [{
            label: 'Average Precipitation (mm)',
            data: data.precip.values,
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Monthly Precipitation Averages',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Precipitation (mm)' }
            }
          }
        }
      });
      // Annual Rainfall Chart
      const ctxAnnual = document.getElementById('annualRainfallChart').getContext('2d');
      new Chart(ctxAnnual, {
        type: 'bar',
        data: {
          labels: data.annualRainfall.labels,
          datasets: [{
            label: 'Annual Rainfall (mm)',
            data: data.annualRainfall.values,
            backgroundColor: '#4caf50',
            borderColor: '#2e7d32',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Rainfall Totals',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Rainfall (mm)' }
            }
          }
        }
      });
      // Frost Days Chart
      const ctxFrost = document.getElementById('frostChart').getContext('2d');
      new Chart(ctxFrost, {
        type: 'line',
        data: {
          labels: data.frost.labels,
          datasets: [{
            label: 'Frost Days per Year',
            data: data.frost.values,
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30, 136, 229, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Frost Days',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Days per Year' }
            }
          }
        }
      });
      // Drought Chart
      const ctxDrought = document.getElementById('droughtChart').getContext('2d');
      new Chart(ctxDrought, {
        type: 'bar',
        data: {
          labels: data.drought.labels,
          datasets: [{
            label: 'Rainfall Departure (%)',
            data: data.drought.values,
            backgroundColor: data.drought.values.map(val => {
              if (val < -50) return '#f44336'; // severe
              if (val < -26) return '#ff9800'; // moderate
              return '#8d6e63'; // normal
            }),
            borderColor: '#6d4c41',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Rainfall Departure from Average',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Percentage Departure (%)' }
            }
          }
        }
      });
      // Frost Comparison Chart
      const ctxFrostComp = document.getElementById('frostComparisonChart').getContext('2d');
      new Chart(ctxFrostComp, {
        type: 'line',
        data: {
          labels: data.frostComparison.labels,
          datasets: [
            {
              label: 'Current Year Temperatures',
              data: data.frostComparison.currentTemps,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3
            },
            {
              label: 'Historical Average',
              data: data.frostComparison.historicalTemps,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Temperature Comparison with Frost Analysis',
              font: { size: 16 }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'Temperature (°C)' }
            }
          }
        }
      });

      // Update stats
      document.getElementById('avgTempValue').textContent = `${data.stats.avgTemp}°C`;
      document.getElementById('maxTempValue').textContent = `${data.stats.maxTemp}°C`;
      document.getElementById('minTempValue').textContent = `${data.stats.minTemp}°C`;
      document.getElementById('warmingValue').textContent = `${data.stats.warming >= 0 ? '+' : ''}${data.stats.warming}°C`;
      document.getElementById('annualPrecip').textContent = `${data.stats.annualPrecip} mm`;
      document.getElementById('maxMonthlyPrecip').textContent = `${data.stats.maxMonthlyPrecip} mm`;
      document.getElementById('drySpells').textContent = `${data.stats.drySpells}/yr`;
      document.getElementById('precipTrend').textContent = `${data.stats.precipTrend >= 0 ? '+' : ''}${data.stats.precipTrend}%`;
      document.getElementById('reportLocation').textContent = `${data.location.coords} (${data.location.name})`;

      // Frost stats
      document.getElementById('totalFrost').textContent = data.stats.totalFrost;
      document.getElementById('avgFrost').textContent = data.stats.avgFrost;
      document.getElementById('coldestMonth').textContent = data.stats.coldestMonth;
      document.getElementById('frostRisk').textContent = data.stats.frostRisk;

      // High Frost Years
      const highFrostYears = document.getElementById('highFrostYears');
      highFrostYears.innerHTML = '';
      data.stats.highFrostYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge frost';
        badge.textContent = year;
        highFrostYears.appendChild(badge);
      });

      // Frost months
      const frostMonthsList = document.getElementById('frostMonthsList');
      frostMonthsList.innerHTML = '';
      data.stats.frostMonths.forEach(month => {
        const tag = document.createElement('div');
        tag.className = `month-tag ${month.hasFrost ? 'frost-month' : 'normal-month'}`;
        tag.textContent = `${month.name}: ${month.frostDays} frost days`;
        frostMonthsList.appendChild(tag);
      });

      // Drought years
      const moderateDroughtYears = document.getElementById('moderateDroughtYears');
      moderateDroughtYears.innerHTML = '';
      data.stats.moderateDroughtYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge moderate-drought';
        badge.textContent = year;
        moderateDroughtYears.appendChild(badge);
      });
      const severeDroughtYears = document.getElementById('severeDroughtYears');
      severeDroughtYears.innerHTML = '';
      data.stats.severeDroughtYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge severe-drought';
        badge.textContent = year;
        severeDroughtYears.appendChild(badge);
      });

      // Prediction values
      document.getElementById('predictedTemp').textContent = `${data.prediction.temp}°C`;
      document.getElementById('predictedPrecip').textContent = `${data.prediction.precip} mm`;
      document.getElementById('predictedFrost').textContent = `${data.prediction.frost} days`;

      // Frost advisory based on risk
      if (data.stats.frostRisk === 'High') {
        document.getElementById('frostAdvisoryText').textContent = `Based on the current data, there is a high probability of frost incidents in the upcoming week. The region has experienced ${data.stats.totalFrost} frost days this year, which is above the historical average. Farmers should take necessary precautions to protect sensitive crops.`;
      } else if (data.stats.frostRisk === 'Moderate') {
        document.getElementById('frostAdvisoryText').textContent = `The frost risk for this region is moderate. While frost events are possible, they are less frequent than in high-risk areas. Farmers should monitor weather forecasts during colder months.`;
      } else {
        document.getElementById('frostAdvisoryText').textContent = `This region has a low frost risk. Frost events are rare, but farmers should still be prepared for occasional cold snaps during winter months.`;
      }

      // Summary
      document.getElementById('predictionSummary').textContent = `Predictions based on historical trends and seasonal forecasting models. This forecast indicates a ${data.prediction.temp > data.stats.avgTemp ? 'warmer' : 'cooler'} and ${data.prediction.precip > data.stats.annualPrecip ? 'wetter' : 'drier'} year ahead with ${data.prediction.frost > data.stats.avgFrost ? 'increased' : 'decreased'} frost risk. Farmers should prepare accordingly.`;

      // Climate commentary
      generateClimateCommentary(data);
      // Farming recommendations
      generateFarmingRecommendations(data);
    }

    function generateClimateCommentary(data) {
      const commentary = document.getElementById('climateCommentary');

      // Helper function to get warmest month (least frost days)
      function getWarmestMonth(frostMonths) {
        let minFrost = Infinity;
        let warmest = '';
        frostMonths.forEach(month => {
          if (month.frostDays < minFrost) {
            minFrost = month.frostDays;
            warmest = month.name;
          }
        });
        return warmest;
      }

      const highFrostYearsStr = data.stats.highFrostYears.length > 0 ? `<strong>${data.stats.highFrostYears.join(', ')}</strong>` : 'none';

      // Generate the commentary
      commentary.innerHTML = `
        <p>The climate analysis for <strong>${data.location.name}</strong> (${data.location.coords}) reveals a ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend of <strong>${Math.abs(data.stats.warming)}°C</strong> over the past ${data.temp.labels.length} years. Precipitation has ${data.stats.precipTrend >= 0 ? 'increased' : 'decreased'} by <strong>${Math.abs(data.stats.precipTrend)}%</strong> during the same period. This indicates significant climate shifts that may affect crop selection and growing seasons.</p>
        <h4>Frost Analysis</h4>
        <p>High frost occurrences were most notable in ${highFrostYearsStr}, posing risks to sensitive crops during winter months. These frost events primarily occurred during the months of June to August. The prediction for the upcoming year shows <strong>${data.prediction.frost} frost days</strong>, which is ${data.prediction.frost > data.stats.avgFrost ? 'above' : 'below'} the historical average, indicating a ${data.stats.frostRisk.toLowerCase()} frost risk.</p>
        <div class="parameters-box">
          <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
        </div>
        <h4 class="drought-header">Drought Analysis</h4>
        <p>Drought conditions were recorded in several years, with ${data.stats.severeDroughtYears.length > 0 ? `severe drought in <strong>${data.stats.severeDroughtYears.join(', ')}</strong>.` : 'minimal drought impact.'} ${data.stats.moderateDroughtYears.length > 0 ? `Moderate drought conditions were recorded in <strong>${data.stats.moderateDroughtYears.join(', ')}</strong>.` : ''} The most significant rainfall departure was ${Math.min(...data.drought.values).toFixed(1)}% in ${data.stats.severeDroughtYears[0] || 'these years'}.`}</p>
        <div class="drought-classification">
          <div class="drought-class moderate-drought-box">
            <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
            <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
          <div class="drought-class severe-drought-box">
            <h5><i class="fas fa-fire"></i> Severe Drought</h5>
            <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
        </div>
        <p>These patterns suggest increasing challenges for water management and crop selection in the coming years. Farmers should consider implementing advanced irrigation techniques and selecting drought-resistant crop varieties.</p>
        <p>The ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend suggests that ${data.stats.warming >= 0 ? 'heat-tolerant' : 'cold-resistant'} varieties may become increasingly important in the coming decades.</p>
      `;
    }

    function generateFarmingRecommendations(data) {
      const recs = document.getElementById('farmingRecommendations');
      recs.innerHTML = '';

      const base = [
        "Monitor weather forecasts regularly for timely decision-making",
        "Maintain soil health through proper crop rotation and organic matter addition",
        "Implement integrated pest management strategies"
      ];

      const frostRecs = [];
      if (data.stats.frostRisk === 'High') {
        frostRecs.push(
          "Plant frost-resistant crops during winter months",
          "Install frost protection systems in vulnerable areas",
          "Schedule planting to avoid peak frost periods",
          "Consider crop insurance for frost protection"
        );
      } else if (data.stats.frostRisk === 'Moderate') {
        frostRecs.push(
          "Have frost protection measures ready for unexpected cold snaps",
          "Monitor frost forecasts closely during high-risk months",
          "Consider frost-tolerant varieties for sensitive crops"
        );
      }

      const droughtRecs = [];
      if (data.stats.severeDroughtYears.length > 0 || data.stats.precipTrend < -5) {
        droughtRecs.push(
          "Implement water harvesting systems to mitigate drought impact",
          "Use drought-tolerant crop varieties",
          "Practice conservation tillage to retain soil moisture",
          "Consider drip irrigation for efficient water use"
        );
      }

      const tempRecs = [];
      if (data.stats.warming > 0.5) {
        tempRecs.push(
          "Consider heat-tolerant crop varieties",
          "Adjust planting schedules to avoid peak heat periods",
          "Implement shading strategies for sensitive crops"
        );
      }

      const allRecs = [...base, ...frostRecs, ...droughtRecs, ...tempRecs];

      allRecs.forEach(r => {
        const li = document.createElement('li');
        li.style.marginBottom = '10px';
        li.textContent = r;
        recs.appendChild(li);
      });
    }

    // Helper to get warmest month (least frost days)
    function getWarmestMonth(frostMonths) {
      let minFrost = Infinity;
      let warmestMonth = '';
      frostMonths.forEach(m => {
        if (m.frostDays < minFrost) {
          minFrost = m.frostDays;
          warmestMonth = m.name;
        }
      });
      return warmestMonth;
    }

    // Draw event
    map.on(L.Draw.Event.CREATED, function (e) {
      if (e.layerType === 'polygon') {
        const layer = e.layer;
        const latlngs = layer.getLatLngs()[0];
        if (latlngs.length < 3) {
          showNotification("Please draw a valid polygon with at least 3 points", "error");
          return;
        }
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);
        const latSum = latlngs.reduce((sum, pt) => sum + pt.lat, 0);
        const lngSum = latlngs.reduce((sum, pt) => sum + pt.lng, 0);
        const center = {
          lat: latSum / latlngs.length,
          lng: lngSum / latlngs.length
        };
        lastPolygonCenter = center;
        document.getElementById('searchInput').value = `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        showNotification(`Farm boundary drawn at ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 'success');
        checkDataAvailability(center.lat, center.lng);
      }
    });

    function checkDataAvailability(lat, lng) {
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        updateProgress(progress, `Checking data availability... ${progress}%`);
        if (progress >= 100) {
          clearInterval(interval);
          // Simulate data availability (ocean or remote)
          const isOcean = (lat < -60 || lat > 60 || Math.abs(lng) > 170);
          const isRemote = (Math.abs(lat) > 55 || Math.abs(lng) > 140);
          if (isOcean) {
            showNotification("No data available (ocean location)", "error");
            dataAvailable = false;
          } else if (isRemote) {
            showNotification("Limited data available (remote area)", "warning");
            dataAvailable = true;
          } else {
            showNotification("Reliable data available", "success");
            dataAvailable = true;
          }
        }
      }, 200);
    }

    // Activate pin mode
    let mapClickHandler = null;
    function activatePinMode() {
      pinModeActive = true;
      document.getElementById('dropPinBtn').classList.add('btn-primary');
      document.getElementById('dropPinBtn').classList.remove('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Click on Map';

      // Add event
      mapClickHandler = handleMapClick;
      map.on('click', mapClickHandler);
      showNotification("Click on the map to drop a pin", 'info');
    }

    function deactivatePinMode() {
      pinModeActive = false;
      if (mapClickHandler) {
        map.off('click', mapClickHandler);
        mapClickHandler = null;
      }
      document.getElementById('dropPinBtn').classList.remove('btn-primary');
      document.getElementById('dropPinBtn').classList.add('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Drop Pin';
    }

    function handleMapClick(e) {
      if (!pinModeActive) return;
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup("Dropped Pin: " + lat.toFixed(4) + ", " + lng.toFixed(4))
        .openPopup();
      document.getElementById('searchInput').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      lastPolygonCenter = { lat, lng };
      checkDataAvailability(lat, lng);
      deactivatePinMode();
      showNotification(`Pin dropped at ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
    }

    // Search input suggestions
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value;
      if (query.length < 3) {
        document.getElementById('suggestions').style.display = 'none';
        return;
      }
      if (geocodeTimeout) clearTimeout(geocodeTimeout);
      geocodeTimeout = setTimeout(() => {
        geocodeLocation(query, true);
      }, 500);
    });

    function searchLocation() {
      const query = document.getElementById('searchInput').value;
      if (!query) {
        showNotification("Enter coordinates or location name to search", 'error');
        return;
      }
      // Check if coordinates
      const coordPattern = /^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)$/;
      const match = query.match(coordPattern);
      if (match) {
        const lat = parseFloat(match[1]);
        const lng = parseFloat(match[3]);
        if (!isNaN(lat) && !isNaN(lng)) {
          map.setView([lat, lng], 13);
          if (currentMarker) map.removeLayer(currentMarker);
          currentMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup("Searched Location: " + lat + ", " + lng).openPopup();
          lastPolygonCenter = { lat, lng };
          currentLocationName = "Custom Location";
          checkDataAvailability(lat, lng);
          showNotification(`Location set to: ${lat}, ${lng}`, 'success');
        } else {
          showNotification("Invalid coordinates. Please enter in 'latitude, longitude' format.", "error");
        }
      } else {
        // Geocode by name
        geocodeLocation(query);
      }
    }

    function geocodeLocation(query, forSuggestions = false) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`;
      if (currentRequest) currentRequest.abort();
      const controller = new AbortController();
      currentRequest = controller;
      fetch(url, { signal: controller.signal })
        .then(res => {
          if (!res.ok) throw new Error('Network response not ok');
          return res.json();
        }).then(data => {
          if (forSuggestions) {
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';
            if (data.length === 0) {
              suggestions.style.display = 'none';
              return;
            }
            data.forEach(item => {
              const div = document.createElement('div');
              div.className = 'suggestion-item';
              div.textContent = item.display_name;
              div.onclick = () => {
                document.getElementById('searchInput').value = item.display_name;
                suggestions.style.display = 'none';
                const lat = parseFloat(item.lat);
                const lon = parseFloat(item.lon);
                map.setView([lat, lon], 13);
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.marker([lat, lon]).addTo(map).bindPopup(item.display_name).openPopup();
                lastPolygonCenter = { lat, lng: lon };
                currentLocationName = item.display_name;
                checkDataAvailability(lat, lon);
                showNotification(`Location set to: ${item.display_name}`, 'success');
              };
              suggestions.appendChild(div);
            });
            suggestions.style.display = 'block';
          } else {
            if (data.length === 0) {
              showNotification("Location not found. Please try a different name.", 'error');
              return;
            }
            const item = data[0];
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            map.setView([lat, lon], 13);
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(map).bindPopup(item.display_name).openPopup();
            lastPolygonCenter = { lat, lng: lon };
            currentLocationName = item.display_name;
            checkDataAvailability(lat, lon);
            showNotification(`Location set to: ${item.display_name}`, 'success');
          }
        }).catch(err => {
          if (err.name === 'AbortError') {
            console.log('Request aborted');
          } else {
            console.error('Geocoding error:', err);
            if (!forSuggestions) {
              showNotification('Error finding location. Please try again.', 'error');
            }
          }
        }).finally(() => {
          currentRequest = null;
        });
    }

    // Reset map
    function resetMap() {
      drawnItems.clearLayers();
      lastPolygonCenter = null;
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
      map.setView([-25.0, 30.0], 5);
      document.getElementById("searchInput").value = "";
      document.getElementById('suggestions').style.display = 'none';
      currentLocationName = "South Africa";
      // Reset progress
      updateProgress(0, 'Ready');
      // Reset pin mode
      if (pinModeActive) {
        deactivatePinMode();
      }
    }

    // Generate report
    async function generateReport() {
      if (!lastPolygonCenter) {
        showNotification("Draw a farm boundary or search a location first.", 'error');
        return;
      }
      if (!dataAvailable) {
        showNotification("No data available for this location. Please choose another location.", 'error');
        return;
      }
      // Show progress
      updateProgress(10, "Starting analysis...");
      document.getElementById('generateBtn').disabled = true;
      try {
        let progress = 10;
        const interval = setInterval(() => {
          progress += 5;
          if (progress > 95) progress = 95;
          updateProgress(progress, `Analyzing climate data... ${progress}%`);
          if (progress >= 95) {
            clearInterval(interval);
            const sampleData = generateSampleData(lastPolygonCenter.lat, lastPolygonCenter.lng);
            setTimeout(() => {
              updateProgress(100, "Analysis complete!");
              openReport(sampleData);
              document.getElementById('generateBtn').disabled = false;
            }, 500);
          }
        }, 100);
      } catch (err) {
        console.error('Error generating report:', err);
        showNotification("Error generating report. Please try again.", 'error');
        document.getElementById('generateBtn').disabled = false;
      }
    }

    // Sample data generator
    function generateSampleData(lat, lon) {
      const years = Array.from({ length: 25 }, (_, i) => 2000 + i);
      const yearLabels = years.map(String);

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      // Generate data
      const annualAvgTemp = years.map(() => +(14 + Math.random() * 6).toFixed(2));
      const annualPrecip = years.map(() => +(500 + Math.random() * 400).toFixed(2));
      const annualFrostDays = years.map(() => Math.floor(Math.random() * 20));
      const currentYearTemps = Array.from({ length: 12 }, () => +(10 + Math.random() * 10).toFixed(1));
      const historicalTemps = Array.from({ length: 12 }, () => +(8 + Math.random() * 8).toFixed(1));
      const monthlyPrecip = Array.from({ length: 12 }, () => +(30 + Math.random() * 90).toFixed(1));

      const avgTemp = +(annualAvgTemp.reduce((a, b) => a + b, 0) / annualAvgTemp.length).toFixed(1);
      const avgPrecip = +(annualPrecip.reduce((a, b) => a + b, 0) / annualPrecip.length).toFixed(1);
      const avgFrost = +(annualFrostDays.reduce((a, b) => a + b, 0) / annualFrostDays.length).toFixed(1);
      const warmingTrend = +(annualAvgTemp.slice(-1)[0] - annualAvgTemp[0]).toFixed(2);
      const precipTrend = +(((annualPrecip.slice(-1)[0] - annualPrecip[0]) / annualPrecip[0]) * 100).toFixed(2);

      const highFrostYears = years.filter((_, i) => annualFrostDays[i] > 15);
      const moderateDroughtYears = years.filter((_, i) => annualPrecip[i] < avgPrecip * 0.74);
      const severeDroughtYears = years.filter((_, i) => annualPrecip[i] < avgPrecip * 0.5);

      const frostMonths = monthNames.map((name, index) => {
        const frostDays = (index <= 2 || index >= 9) ? Math.floor(Math.random() * 6) : 0;
        return { name, frostDays, hasFrost: frostDays > 0 };
      });
      const coldestIndex = currentYearTemps.indexOf(Math.min(...currentYearTemps));
      const coldestMonth = monthNames[coldestIndex];

      const currentFrostDays = annualFrostDays.slice(-1)[0];
      const frostRisk = currentFrostDays > 15 ? 'High' : currentFrostDays > 10 ? 'Moderate' : 'Low';

      const drySpells = monthlyPrecip.filter(p => p < 30).length;

      // Next year predictions
      const nextYear = years.slice(-1)[0] + 1;
      const predictedTemp = +(annualAvgTemp.slice(-1)[0] + 0.4).toFixed(2);
      const predictedPrecip = Math.max(0, +(annualPrecip.slice(-1)[0] * 0.96).toFixed(2));
      const predictedFrost = Math.max(0, currentFrostDays + 1);

      // Return object
      return {
        location: {
          coords: `${lat}, ${lon}`,
          name: currentLocationName
        },
        temp: {
          labels: yearLabels,
          values: annualAvgTemp
        },
        precip: {
          labels: monthNames,
          values: monthlyPrecip
        },
        annualRainfall: {
          labels: yearLabels,
          values: annualPrecip
        },
        frost: {
          labels: yearLabels,
          values: annualFrostDays
        },
        drought: {
          labels: yearLabels,
          values: annualPrecip.map(p => +(((p - avgPrecip) / avgPrecip) * 100).toFixed(1))
        },
        frostComparison: {
          labels: monthNames,
          currentTemps: currentYearTemps,
          historicalTemps: historicalTemps
        },
        rainfallAnalysis: {
          averageAnnual: avgPrecip,
          maxAnnual: +(Math.max(...annualPrecip)).toFixed(1),
          minAnnual: +(Math.min(...annualPrecip)).toFixed(1),
          stdDev: +Math.sqrt(annualPrecip.reduce((sum, val) => sum + Math.pow(val - avgPrecip, 2), 0) / annualPrecip.length).toFixed(1),
          precipTrend: precipTrend,
          moderateDroughtCount: moderateDroughtYears.length,
          severeDroughtCount: severeDroughtYears.length
        },
        stats: {
          avgTemp,
          maxTemp: +(Math.max(...annualAvgTemp)).toFixed(1),
          minTemp: +(Math.min(...annualAvgTemp)).toFixed(1),
          warming: warmingTrend,
          annualPrecip: avgPrecip,
          maxMonthlyPrecip: Math.max(...monthlyPrecip).toFixed(1),
          drySpells: drySpells,
          precipTrend,
          highFrostYears,
          moderateDroughtYears,
          severeDroughtYears,
          totalFrost: currentFrostDays,
          avgFrost,
          coldestMonth,
          frostRisk,
          frostMonths
        },
        prediction: {
          year: nextYear,
          temp: predictedTemp,
          precip: predictedPrecip,
          frost: predictedFrost
        }
      };
    }

    // Future climate simulation
    function simulateFutureClimate(baseData, yearsToSimulate=25, scenario='moderate') {
      const warmingRate = scenario==='severe' ? 0.35 : 0.2; // °C/decade
      const precipChangeRate = scenario==='severe' ? -0.02 : 0; // % per year
      const frostReductionRate = scenario==='severe' ? -0.8 : -0.4; // days/year
      const startYear = baseData.prediction.year;
      const futureYears = Array.from({ length: yearsToSimulate }, (_, i) => startYear + i);
      const labels = futureYears.map(String);
      let lastTemp = parseFloat(baseData.prediction.temp);
      let lastPrecip = parseFloat(baseData.prediction.precip);
      let lastFrost = parseInt(baseData.prediction.frost);
      const futureTemps = [];
      const futurePrecip = [];
      const futureFrosts = [];
      for (let i=0; i<yearsToSimulate; i++) {
        lastTemp += warmingRate;
        futureTemps.push(+lastTemp.toFixed(2));
        lastPrecip += lastPrecip * precipChangeRate;
        futurePrecip.push(+lastPrecip.toFixed(1));
        lastFrost = Math.max(0, lastFrost + frostReductionRate);
        futureFrosts.push(Math.round(lastFrost));
      }
      return {
        labels,
        temp: futureTemps,
        precip: futurePrecip,
        frost: futureFrosts,
        scenario,
        fromYear: startYear,
        toYear: startYear + yearsToSimulate -1,
        assumptions: {
          warmingRate: `${warmingRate}°C/decade`,
          precipChange: `${(precipChangeRate*100).toFixed(1)}%/year`,
          frostReduction: `${frostReductionRate} days/year`
        }
      };
    }

    // Get warmest month (least frost days)
    function getWarmestMonth(frostMonths) {
      let minFrost = Infinity;
      let warmest = '';
      frostMonths.forEach(m => {
        if (m.frostDays < minFrost) {
          minFrost = m.frostDays;
          warmest = m.name;
        }
      });
      return warmest;
    }

    // Event handlers
    map.on(L.Draw.Event.CREATED, (e) => {
      if (e.layerType === 'polygon') {
        const layer = e.layer;
        const latlngs = layer.getLatLngs()[0];
        if (latlngs.length < 3) {
          showNotification("Please draw a valid polygon with at least 3 points", "error");
          return;
        }
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);
        const latSum = latlngs.reduce((sum, pt) => sum + pt.lat, 0);
        const lngSum = latlngs.reduce((sum, pt) => sum + pt.lng, 0);
        const center = {
          lat: latSum / latlngs.length,
          lng: lngSum / latlngs.length
        };
        lastPolygonCenter = center;
        document.getElementById('searchInput').value = `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        showNotification(`Farm boundary drawn at ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 'success');
        checkDataAvailability(center.lat, center.lng);
      }
    });

    // Map click for pin drop
    let mapClickListener = null;
    function activatePinMode() {
      pinModeActive = true;
      document.getElementById('dropPinBtn').classList.add('btn-primary');
      document.getElementById('dropPinBtn').classList.remove('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Click on Map';
      mapClickListener = handleMapClick;
      map.on('click', mapClickListener);
      showNotification("Click on the map to drop a pin", 'info');
    }
    function deactivatePinMode() {
      pinModeActive = false;
      if (mapClickListener) {
        map.off('click', mapClickListener);
        mapClickListener = null;
      }
      document.getElementById('dropPinBtn').classList.remove('btn-primary');
      document.getElementById('dropPinBtn').classList.add('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Drop Pin';
    }
    function handleMapClick(e) {
      if (!pinModeActive) return;
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup("Dropped Pin: " + lat.toFixed(4) + ", " + lng.toFixed(4))
        .openPopup();
      document.getElementById('searchInput').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      lastPolygonCenter = { lat, lng };
      checkDataAvailability(lat, lng);
      deactivatePinMode();
      showNotification(`Pin dropped at ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
    }

    // Search suggestions
    document.getElementById('searchInput').addEventListener('input', e => {
      const q = e.target.value;
      if (q.length < 3) {
        document.getElementById('suggestions').style.display = 'none';
        return;
      }
      if (geocodeTimeout) clearTimeout(geocodeTimeout);
      geocodeTimeout = setTimeout(() => {
        geocodeLocation(q, true);
      }, 500);
    });

    // Search by text
    function searchLocation() {
      const q = document.getElementById('searchInput').value;
      if (!q) {
        showNotification("Enter coordinates or location name to search", 'error');
        return;
      }
      const coordMatch = q.match(/^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)$/);
      if (coordMatch) {
        const lat = parseFloat(coordMatch[1]);
        const lng = parseFloat(coordMatch[3]);
        if (!isNaN(lat) && !isNaN(lng)) {
          map.setView([lat, lng], 13);
          if (currentMarker) map.removeLayer(currentMarker);
          currentMarker = L.marker([lat, lng]).addTo(map).bindPopup("Searched Location: " + lat + ", " + lng).openPopup();
          lastPolygonCenter = { lat, lng };
          currentLocationName = "Custom Location";
          checkDataAvailability(lat, lng);
          showNotification(`Location set to: ${lat}, ${lng}`, 'success');
        } else {
          showNotification("Invalid coordinates.", "error");
        }
      } else {
        // Geocode
        geocodeLocation(q);
      }
    }

    function geocodeLocation(q, forSuggestions=true) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`;
      if (currentRequest) currentRequest.abort();
      const ctrl = new AbortController();
      currentRequest = ctrl;
      fetch(url, { signal: ctrl.signal }).then(res => {
        if (!res.ok) throw new Error('Network response not ok');
        return res.json();
      }).then(data => {
        if (forSuggestions) {
          const suggDiv = document.getElementById('suggestions');
          suggDiv.innerHTML = '';
          if (data.length === 0) {
            suggDiv.style.display = 'none';
            return;
          }
          data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = item.display_name;
            div.onclick = () => {
              document.getElementById('searchInput').value = item.display_name;
              suggDiv.style.display = 'none';
              const lat = parseFloat(item.lat);
              const lon = parseFloat(item.lon);
              map.setView([lat, lon], 13);
              if (currentMarker) map.removeLayer(currentMarker);
              currentMarker = L.marker([lat, lon]).addTo(map).bindPopup(item.display_name).openPopup();
              lastPolygonCenter = { lat, lng: lon };
              currentLocationName = item.display_name;
              checkDataAvailability(lat, lon);
              showNotification(`Location set to: ${item.display_name}`, 'success');
            };
            suggDiv.appendChild(div);
          });
          suggDiv.style.display = 'block';
        } else {
          if (data.length === 0) {
            showNotification("Location not found. Please try a different name.", 'error');
            return;
          }
          const item = data[0];
          const lat = parseFloat(item.lat);
          const lon = parseFloat(item.lon);
          map.setView([lat, lon], 13);
          if (currentMarker) map.removeLayer(currentMarker);
          currentMarker = L.marker([lat, lon]).addTo(map).bindPopup(item.display_name).openPopup();
          lastPolygonCenter = { lat, lng: lon };
          currentLocationName = item.display_name;
          checkDataAvailability(lat, lon);
          showNotification(`Location set to: ${item.display_name}`, 'success');
        }
      }).catch(err => {
        if (err.name === 'AbortError') {
          console.log('aborted');
        } else {
          console.error('Geocode error:', err);
          if (!forSuggestions) showNotification("Error finding location.", 'error');
        }
      }).finally(() => {
        currentRequest = null;
      });
    }

    // Reset map
    function resetMap() {
      drawnItems.clearLayers();
      lastPolygonCenter = null;
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
      map.setView([-25.0, 30.0], 5);
      document.getElementById('searchInput').value = '';
      document.getElementById('suggestions').style.display = 'none';
      currentLocationName = "South Africa";
      updateProgress(0, 'Ready');
      if (pinModeActive) deactivatePinMode();
    }

    // Generate report
    async function generateReport() {
      if (!lastPolygonCenter) {
        showNotification("Draw a farm boundary or search a location first.", 'error');
        return;
      }
      if (!dataAvailable) {
        showNotification("No data available for this location. Please choose another location.", 'error');
        return;
      }
      updateProgress(10, "Starting analysis...");
      document.getElementById('generateBtn').disabled = true;
      try {
        let progress = 10;
        const interval = setInterval(() => {
          progress += 5;
          if (progress > 95) progress = 95;
          updateProgress(progress, `Analyzing climate data... ${progress}%`);
          if (progress >= 95) {
            clearInterval(interval);
            const data = generateSampleData(lastPolygonCenter.lat, lastPolygonCenter.lng);
            setTimeout(() => {
              updateProgress(100, "Analysis complete!");
              openReport(data);
              document.getElementById('generateBtn').disabled = false;
            }, 500);
          }
        }, 100);
      } catch (err) {
        console.error('Error:', err);
        showNotification("Error generating report.", 'error');
        document.getElementById('generateBtn').disabled = false;
      }
    }

    // Generate sample data (already included above)
    // ... (No need to duplicate here, already in generateReport)

    // Generate climate commentary
    function generateClimateCommentary(data) {
      const container = document.getElementById('climateCommentary');
      // Use the same logic as inside generateChartData
      // For simplicity, reusing data
      const highFrostYearsStr = data.stats.highFrostYears.length > 0 ? `<strong>${data.stats.highFrostYears.join(', ')}</strong>` : 'none';
      container.innerHTML = `
        <p>The climate analysis for <strong>${data.location.name}</strong> (${data.location.coords}) reveals a ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend of <strong>${Math.abs(data.stats.warming)}°C</strong> over the past ${data.temp.labels.length} years. Precipitation has ${data.stats.precipTrend >= 0 ? 'increased' : 'decreased'} by <strong>${Math.abs(data.stats.precipTrend)}%</strong> during the same period. This indicates significant climate shifts that may affect crop selection and growing seasons.</p>
        <h4>Frost Analysis</h4>
        <p>High frost occurrences were most notable in ${highFrostYearsStr}, posing risks to sensitive crops during winter months. These frost events primarily occurred during the months of June to August. The prediction for the upcoming year shows <strong>${data.prediction.frost} frost days</strong>, which is ${data.prediction.frost > data.stats.avgFrost ? 'above' : 'below'} the average, indicating a ${data.stats.frostRisk} frost risk.</p>
        <div class="parameters-box">
          <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
        </div>
        <h4 class="drought-header">Drought Analysis</h4>
        <p>Drought conditions were recorded in several years, with ${data.stats.severeDroughtYears.length > 0 ? `severe drought in <strong>${data.stats.severeDroughtYears.join(', ')}</strong>.` : 'minimal drought impact.'} ${data.stats.moderateDroughtYears.length > 0 ? `Moderate drought conditions were recorded in <strong>${data.stats.moderateDroughtYears.join(', ')}</strong>.` : ''} The most significant rainfall departure was ${Math.min(...data.drought.values).toFixed(1)}% in ${data.stats.severeDroughtYears[0] || 'these years'}.`}</p>
        <div class="drought-classification">
          <div class="drought-class moderate-drought-box">
            <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
            <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
          <div class="drought-class severe-drought-box">
            <h5><i class="fas fa-fire"></i> Severe Drought</h5>
            <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
        </div>
        <p>Based on these patterns, farmers should consider implementing appropriate water conservation techniques and ${data.stats.frostRisk !== 'Low' ? 'selecting frost-resistant crop varieties.' : 'focusing on optimal planting schedules.'} The ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend suggests that ${data.stats.warming >= 0 ? 'heat-tolerant' : 'cold-resistant'} varieties may become increasingly important in the coming decades.</p>
      `;
    }

    // Generate farming recommendations
    function generateFarmingRecommendations(data) {
      const recs = document.getElementById('farmingRecommendations');
      recs.innerHTML = '';

      const base = [
        "Monitor weather forecasts regularly for timely decision-making",
        "Maintain soil health through proper crop rotation and organic matter addition",
        "Implement integrated pest management strategies"
      ];

      const frostRecs = [];
      if (data.stats.frostRisk === 'High') {
        frostRecs.push(
          "Plant frost-resistant crops during winter months",
          "Install frost protection systems in vulnerable areas",
          "Schedule planting to avoid peak frost periods",
          "Consider crop insurance for frost protection"
        );
      } else if (data.stats.frostRisk === 'Moderate') {
        frostRecs.push(
          "Have frost protection measures ready for unexpected cold snaps",
          "Monitor frost forecasts closely during high-risk months",
          "Consider frost-tolerant varieties for sensitive crops"
        );
      }

      const droughtRecs = [];
      if (data.stats.severeDroughtYears.length > 0 || data.stats.precipTrend < -5) {
        droughtRecs.push(
          "Implement water harvesting systems to mitigate drought impact",
          "Use drought-tolerant crop varieties",
          "Practice conservation tillage to retain soil moisture",
          "Consider drip irrigation for efficient water use"
        );
      }

      const tempRecs = [];
      if (data.stats.warming > 0.5) {
        tempRecs.push(
          "Consider heat-tolerant crop varieties",
          "Adjust planting schedules to avoid peak heat periods",
          "Implement shading strategies for sensitive crops"
        );
      }

      const allRecs = [...base, ...frostRecs, ...droughtRecs, ...tempRecs];

      allRecs.forEach(r => {
        const li = document.createElement('li');
        li.style.marginBottom = '10px';
        li.textContent = r;
        recs.appendChild(li);
      });
    }

    // Initialize progress
    updateProgress(0, 'Ready');

    // Window resize
    window.addEventListener('resize', () => {
      if (map) {
        setTimeout(() => { map.invalidateSize(); }, 100);
      }
    });

    // Click outside suggestions
    document.addEventListener('click', (e) => {
      const sugg = document.getElementById('suggestions');
      const input = document.getElementById('searchInput');
      if (sugg && input && !input.contains(e.target) && !sugg.contains(e.target)) {
        sugg.style.display = 'none';
      }
    });
  </script>
</body>
</html>
