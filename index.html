<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlaasRisk - Advanced Climate Analysis</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --primary-dark: #1b5e20;
      --secondary: #388e3c;
      --accent: #f57c00;
      --accent-light: #ffb74d;
      --accent-dark: #e65100;
      --light: #f5f9f5;
      --light-gray: #f8f9fa;
      --dark: #2d3748;
      --text: #333333;
      --border: #e0e0e0;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --frost-blue: #1e88e5;
      --frost-light: #bbdefb;
      --drought-brown: #8d6e63;
      --drought-light: #efebe9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f9f5 0%, #e8f5e9 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 15px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .map-section {
      flex: 1;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin: 15px 0;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    #map {
      flex: 1;
      z-index: 1;
      background: #e8f5e9;
    }
    
    /* HORIZONTAL CONTROL BAR */
    .control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px;
      background: white;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      position: relative;
      align-items: center;
      justify-content: space-between;
    }
    
    @media (max-width: 1200px) {
      .control-bar {
        gap: 10px;
        padding: 10px;
      }
    }
    
    @media (max-width: 768px) {
      .control-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 300px;
    }
    
    @media (max-width: 768px) {
      .control-group {
        min-width: 100%;
      }
    }
    
    .input-with-icon {
      position: relative;
      flex: 1;
    }
    
    .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 9px 12px 9px 35px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s;
      background: var(--light-gray);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      background: white;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      gap: 6px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(46, 125, 50, 0.25);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      font-weight: 500;
    }
    
    .btn-outline:hover {
      background: rgba(46, 125, 50, 0.08);
    }
    
    .btn-sm {
      padding: 7px 10px;
      font-size: 0.85rem;
    }
    
    .btn-block {
      width: 100%;
    }
    
    .map-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .map-actions .btn {
      flex: 1;
      min-width: 110px;
    }
    
    @media (max-width: 768px) {
      .map-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .map-actions .btn {
        min-width: auto;
        flex: none;
      }
    }
    
    .progress-container {
      width: 200px;
      margin-left: 15px;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
      color: var(--dark);
    }
    
    .progress-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 5px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .progress-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 0.7rem;
      font-weight: 500;
      text-shadow: 0 1px 1px rgba(0,0,0,0.3);
    }
    
    .suggestions-box {
      position: absolute;
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 180px;
      overflow-y: auto;
      z-index: 1001;
      margin-top: 4px;
      display: none;
      border: 1px solid var(--border);
    }
    
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
      font-size: 0.85rem;
    }
    
    .suggestion-item:hover {
      background: var(--light);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .notification {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(200%);
      transition: transform 0.4s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .notification {
        top: auto;
        bottom: 15px;
        left: 15px;
        right: 15px;
        width: calc(100% - 30px);
      }
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: var(--success);
    }
    
    .notification.error {
      background: var(--danger);
    }
    
    .notification.info {
      background: var(--primary);
    }
    
    footer {
      text-align: center;
      padding: 8px;
      color: #666;
      font-size: 0.8rem;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-top: 12px;
    }
    
    /* Redesigned PlaasRisk Logo */
    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 10px;
    }
    
    .plaasrisk-logo {
      height: 40px;
      width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    .logo-icon {
      color: white;
      font-size: 22px;
      position: relative;
      z-index: 2;
    }
    
    .logo-text {
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      position: relative;
    }
    
    .logo-text::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    /* Report Modal */
    .report-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 3000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .report-modal.active {
      display: block;
      opacity: 1;
    }
    
    .report-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      margin: 20px auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-height: 95vh;
      overflow-y: auto;
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .report-title {
      font-size: 1.8rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .close-report {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }
    
    .close-report:hover {
      color: var(--danger);
    }
    
    .report-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 992px) {
      .report-body {
        grid-template-columns: 1fr;
      }
    }
    
    .report-section {
      background: var(--light);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    .report-section h3 {
      margin-bottom: 15px;
      color: var(--primary-dark);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
      margin-top: 15px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .report-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .report-actions {
      display: flex;
      gap: 12px;
    }
    
    .download-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
    }
    
    .download-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(46, 125, 50, 0.4);
    }
    
    .close-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 25px;
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .close-btn:hover {
      background: #e0e0e0;
    }
    
    .location-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .location-badge {
      background: var(--light);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Years sections */
    .years-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .years-container {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .years-container h4 {
      margin-bottom: 10px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .years-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .year-badge {
      padding: 5px 10px;
      background: #e8f5e9;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .year-badge.frost {
      background: var(--frost-light);
      color: var(--frost-blue);
    }
    
    .year-badge.drought {
      background: var(--drought-light);
      color: var(--drought-brown);
    }
    
    .year-badge.moderate-drought {
      background: #ffecb3;
      color: #ff9800;
    }
    
    .year-badge.severe-drought {
      background: #ffcdd2;
      color: #f44336;
    }
    
    /* Commentary Section */
    .commentary-section {
      grid-column: 1 / -1;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid var(--primary);
    }
    
    .commentary-section h3 {
      color: var(--primary-dark);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .commentary-content {
      line-height: 1.7;
      padding: 10px;
    }
    
    .commentary-content p {
      margin-bottom: 15px;
    }
    
    .commentary-content h4 {
      color: var(--frost-blue);
      margin: 20px 0 10px 0;
      border-bottom: 1px solid var(--frost-light);
      padding-bottom: 5px;
    }
    
    .commentary-content .drought-header {
      color: var(--drought-brown);
      border-bottom: 1px solid var(--drought-light);
    }
    
    .parameters-box {
      background: white;
      border-left: 3px solid var(--primary);
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .drought-classification {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .drought-class {
      flex: 1;
      min-width: 200px;
      padding: 15px;
      border-radius: 8px;
      color: white;
    }
    
    .moderate-drought-box {
      background: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%);
    }
    
    .severe-drought-box {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }
    
    .drought-class h5 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .drought-class p {
      font-size: 0.9rem;
      margin-bottom: 0;
    }
    
    /* Report Headers */
    .report-header-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .report-header-section h2 {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Prediction Section */
    .prediction-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
      color: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .prediction-section::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      z-index: 1;
    }
    
    .prediction-section::after {
      content: "";
      position: absolute;
      bottom: -30%;
      left: -30%;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      z-index: 1;
    }
    
    .prediction-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }
    
    .prediction-header h3 {
      font-size: 1.8rem;
      margin: 0;
    }
    
    .prediction-content {
      display: flex;
      gap: 20px;
      position: relative;
      z-index: 2;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .prediction-content {
        flex-direction: column;
      }
    }
    
    .prediction-card {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 300px;
    }
    
    .prediction-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .prediction-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      text-align: center;
    }
    
    .prediction-label {
      text-align: center;
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .prediction-trend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .trend-up {
      color: #ff7043;
    }
    
    .trend-down {
      color: #81c784;
    }
    
    .prediction-gauge {
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      margin-top: 15px;
      position: relative;
      overflow: hidden;
    }
    
    .gauge-fill {
      height: 100%;
      border-radius: 10px;
      position: absolute;
      left: 0;
      top: 0;
      transition: width 1s ease;
    }
    
    .gauge-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    
    .prediction-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
      position: relative;
      z-index: 2;
    }
    
    /* Frost Risk Indicator */
    .frost-risk {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
      gap: 8px;
    }
    
    .risk-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
    }
    
    .risk-low { background-color: #4caf50; }
    .risk-moderate { background-color: #ff9800; }
    .risk-high { background-color: #f44336; }
    
    /* Report Letterhead */
    .letterhead {
      position: relative;
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary);
    }
    
    .letterhead-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .letterhead-logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .letterhead-text {
      text-align: right;
    }
    
    .letterhead-text h1 {
      color: var(--primary-dark);
      font-size: 2.2rem;
      margin-bottom: 5px;
    }
    
    .letterhead-text p {
      color: #666;
      font-size: 0.9rem;
    }
    
    /* PDF loading overlay */
    .pdf-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 4000;
      color: white;
      display: none;
    }
    
    .pdf-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Prepared by section */
    .prepared-by {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--primary);
    }
    
    .prepared-by strong {
      color: var(--primary-dark);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .report-content {
        padding: 20px;
      }
      
      .report-title {
        font-size: 1.4rem;
      }
      
      .report-section {
        padding: 15px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .report-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .report-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .years-section {
        flex-direction: column;
      }
      
      .progress-container {
        width: 100%;
        margin: 12px 0 0 0;
      }
      
      .drought-classification {
        flex-direction: column;
      }
      
      .prediction-value {
        font-size: 2rem;
      }
      
      .letterhead-content {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .letterhead-text {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-section">
      <div class="control-bar">
        <div class="logo-container">
          <div class="plaasrisk-logo">
            <i class="fas fa-seedling logo-icon"></i>
          </div>
          <div class="logo-text">PlaasRisk</div>
        </div>
        
        <div class="control-group">
          <div class="input-with-icon">
            <i class="fas fa-search input-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Enter coordinates or location (e.g. -25.0, 30.0 or Johannesburg)" />
            <div id="suggestions" class="suggestions-box"></div>
          </div>
          
          <button class="btn btn-primary" onclick="searchLocation()">
            <i class="fas fa-search-location"></i> Search
          </button>
          
          <!-- Progress bar moved next to GPS input -->
          <div class="progress-container">
            <div class="progress-header">
              <span>Data Retrieval</span>
              <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
              <div class="progress-label" id="progress-label">Ready</div>
            </div>
          </div>
        </div>
        
        <div class="map-actions">
          <button class="btn btn-outline" onclick="resetMap()">
            <i class="fas fa-trash-alt"></i> Clear
          </button>
          <button class="btn btn-primary" onclick="generateReport()" id="generateBtn">
            <i class="fas fa-chart-line"></i> Analyze
          </button>
          <button class="btn btn-outline" id="dropPinBtn" onclick="activatePinMode()">
            <i class="fas fa-map-pin"></i> Drop Pin
          </button>
          <button class="btn btn-outline" id="satelliteBtn" onclick="toggleSatellite()">
            <i class="fas fa-satellite"></i> Vegetation
          </button>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
    
    <footer>
      <p>Farm Climate Analysis Tool • Data provided by Open-Meteo Historical Weather API</p>
      <p style="margin-top: 5px; font-size: 0.8rem; color: #777;">Platform developed by Macdonald Makoro: 076-623-2221</p>
    </footer>
  </div>
  
  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text">Notification message</span>
  </div>
  
  <!-- PDF Loading Overlay -->
  <div class="pdf-loading-overlay" id="pdfLoading">
    <div class="pdf-spinner"></div>
    <h3>Generating PDF Report</h3>
    <p>Please wait while we prepare your full report...</p>
  </div>
  
  <!-- Report Modal -->
  <div class="report-modal" id="reportModal">
    <div class="report-content">
      <!-- Report Letterhead -->
      <div class="letterhead">
        <div class="letterhead-content">
          <div class="letterhead-logo">
            <div class="plaasrisk-logo">
              <i class="fas fa-seedling logo-icon"></i>
            </div>
            <div>
              <h1 class="logo-text">PlaasRisk</h1>
              <p>Advanced Farm Climate Analysis</p>
            </div>
          </div>
          <div class="letterhead-text">
            <p>Date: <span id="reportDate">${new Date().toLocaleDateString()}</span></p>
            <p>Prepared for: <strong>Macdonald Makoro</strong></p>
          </div>
        </div>
      </div>
      
      <div class="report-header">
        <h2 class="report-title">
          <i class="fas fa-file-alt"></i>
          Farm Climate Analysis Report
        </h2>
        <button class="close-report" onclick="closeReport()">&times;</button>
      </div>
      
      <div class="report-body">
        <div class="report-header-section">
          <h2><i class="fas fa-tractor"></i> Farm Climate Risk Assessment</h2>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-temperature-low"></i> Temperature Analysis</h3>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Average Temp</div>
              <div class="stat-value" id="avgTempValue">21.4°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Temp</div>
              <div class="stat-value" id="maxTempValue">34.2°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Min Temp</div>
              <div class="stat-value" id="minTempValue">-1.3°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Warming Trend</div>
              <div class="stat-value" id="warmingValue">+1.2°C</div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-cloud-rain"></i> Precipitation Analysis</h3>
          <div class="chart-container">
            <canvas id="precipitationChart"></canvas>
          </div>
          
          <div class="chart-container" style="margin-top: 25px;">
            <canvas id="annualRainfallChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Annual Avg</div>
              <div class="stat-value" id="annualPrecip">625 mm</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Monthly</div>
              <div class="stat-value" id="maxMonthlyPrecip">210 mm</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Dry Spells</div>
              <div class="stat-value" id="drySpells">3.2/yr</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Trend</div>
              <div class="stat-value" id="precipTrend">-8%</div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis</h3>
          <div class="chart-container">
            <canvas id="frostChart"></canvas>
          </div>
          
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with High Frost Occurrence</h4>
              <div class="years-list" id="highFrostYears">
                <div class="year-badge frost">2010</div>
                <div class="year-badge frost">2012</div>
                <div class="year-badge frost">2015</div>
                <div class="year-badge frost">2018</div>
                <div class="year-badge frost">2021</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-tint-slash"></i> Drought Analysis</h3>
          <div class="chart-container">
            <canvas id="droughtChart"></canvas>
          </div>
          
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Moderate Drought</h4>
              <div class="years-list" id="moderateDroughtYears">
                <div class="year-badge moderate-drought">2005</div>
                <div class="year-badge moderate-drought">2009</div>
                <div class="year-badge moderate-drought">2016</div>
              </div>
            </div>
            
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Severe Drought</h4>
              <div class="years-list" id="severeDroughtYears">
                <div class="year-badge severe-drought">2019</div>
                <div class="year-badge severe-drought">2023</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Prediction Section -->
        <div class="prediction-section">
          <div class="prediction-header">
            <i class="fas fa-crystal-ball" style="font-size: 2.5rem;"></i>
            <h3>2025 Climate Prediction</h3>
          </div>
          
          <div class="prediction-content">
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-temperature-high"></i>
                <h4>Temperature Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedTemp">22.8°C</div>
              <div class="prediction-label">Annual Average</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>1.4°C above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="tempGauge" style="width: 75%; background: linear-gradient(90deg, #4fc3f7, #e57373);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span>
                <span>Average</span>
                <span>High</span>
              </div>
            </div>
            
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-tint"></i>
                <h4>Precipitation Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedPrecip">580 mm</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-down">
                <i class="fas fa-arrow-down"></i>
                <span>7% below average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="precipGauge" style="width: 65%; background: linear-gradient(90deg, #81c784, #4fc3f7);"></div>
              </div>
              <div class="gauge-labels">
                <span>Dry</span>
                <span>Average</span>
                <span>Wet</span>
              </div>
            </div>
            
            <!-- Frost Prediction Card -->
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-snowflake"></i>
                <h4>Frost Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedFrost">18 days</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>3 days above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="frostGauge" style="width: 70%; background: linear-gradient(90deg, #bbdefb, #1e88e5);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span>
                <span>Average</span>
                <span>High</span>
              </div>
              <div class="frost-risk">
                <div class="risk-indicator risk-high"></div>
                <span>High Frost Risk Expected</span>
              </div>
            </div>
          </div>
          
          <div class="prediction-footer">
            <p><i class="fas fa-info-circle"></i> Predictions based on historical trends and seasonal forecasting models. This forecast indicates a warmer and drier year ahead with increased frost risk. Farmers should prepare for potential water shortages, consider heat-tolerant crop varieties, and implement frost protection measures.</p>
          </div>
        </div>
        
        <!-- Commentary Section -->
        <div class="commentary-section">
          <h3><i class="fas fa-comment-alt"></i> Climate Commentary</h3>
          <div class="commentary-content" id="climateCommentary">
            <p>The analysis reveals a warming trend of +1.2°C over the past 25 years, with precipitation decreasing by 8% during the same period. This indicates significant climate shifts that may impact agricultural planning.</p>
            
            <h4>Frost Analysis</h4>
            <p>High frost occurrences were most notable in 2010, 2012, 2015, 2018, and 2021, posing risks to sensitive crops during winter months. These frost events primarily occurred during the months of June to August. The prediction for the upcoming year shows an increased frost risk of 18 days, which is significantly above the historical average.</p>
            
            <div class="parameters-box">
              <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
            </div>
            
            <h4 class="drought-header">Drought Analysis</h4>
            <p>Drought conditions were recorded in several years, with moderate drought in 2005, 2009 and 2016, and severe drought in 2019 and 2023. The most prolonged drought period occurred from March to November in 2016.</p>
            
            <div class="drought-classification">
              <div class="drought-class moderate-drought-box">
                <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
                <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
              
              <div class="drought-class severe-drought-box">
                <h5><i class="fas fa-fire"></i> Severe Drought</h5>
                <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
            </div>
            
            <p>These patterns suggest increasing challenges for water management and crop selection in the coming years. Farmers should consider implementing advanced irrigation techniques and selecting drought-resistant crop varieties.</p>
          </div>
        </div>
        
        <div class="report-section" style="grid-column: 1 / -1; margin-top: 0;">
          <h3><i class="fas fa-lightbulb"></i> Farming Recommendations</h3>
          <ul style="padding-left: 20px; margin-top: 15px;">
            <li style="margin-bottom: 10px;">Plant frost-resistant crops during winter months in high-risk years</li>
            <li style="margin-bottom: 10px;">Implement water harvesting systems to mitigate drought impact</li>
            <li style="margin-bottom: 10px;">Use drought-tolerant crop varieties in anticipation of dry spells</li>
            <li style="margin-bottom: 10px;">Schedule planting to avoid peak frost periods in high-risk years</li>
            <li style="margin-bottom: 10px;">Install frost protection systems in vulnerable areas</li>
            <li style="margin-bottom: 10px;">Monitor frost forecasts closely during high-risk months (May-August)</li>
            <li style="margin-bottom: 10px;">Consider crop insurance for frost and drought protection</li>
          </ul>
        </div>
      </div>
      
      <div class="report-footer">
        <div class="location-info">
          <div class="location-badge">
            <i class="fas fa-map-marker-alt"></i>
            <span id="reportLocation">-25.0, 30.0 (South Africa)</span>
          </div>
          <div class="location-badge">
            <i class="fas fa-calendar"></i>
            <span>2000 - 2024</span>
          </div>
        </div>
        
        <div class="report-actions">
          <button class="download-btn" onclick="downloadReport()">
            <i class="fas fa-download"></i> Download Report (PDF)
          </button>
          <button class="download-btn" onclick="printReport()" style="background: #5e35b1;">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="close-btn" onclick="closeReport()">
            <i class="fas fa-times"></i> Close Report
          </button>
        </div>
      </div>
      
      <!-- Prepared by section -->
      <div class="prepared-by">
        Prepared by: <strong>Macdonald Makoro</strong>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([-25.0, 30.0], 5); // Set to South Africa coordinates
    
    // Add tile layer
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add satellite vegetation layer
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles &copy; Esri'
    });
    
    // Add layer control
    const baseLayers = {
      "Standard Map": osmLayer,
      "Satellite Vegetation": satelliteLayer
    };
    
    L.control.layers(baseLayers).addTo(map);
    
    // Add a marker to South Africa
    L.marker([-25.0, 30.0]).addTo(map)
      .bindPopup('South Africa')
      .openPopup();

    // Initialize layers and controls
    let drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    let lastPolygonCenter = null;
    let currentMarker = null;
    let dataAvailable = false;
    let pinModeActive = false;
    let geocodeTimeout = null;
    let currentRequest = null;
    let currentLocationName = "South Africa";
    
    const drawControl = new L.Control.Draw({
      draw: {
        polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#2e7d32' } },
        polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
      },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    // Fix for mobile devices - invalidate map size after initialization
    setTimeout(() => {
      map.invalidateSize();
    }, 100);

    // Progress bar function
    function updateProgress(percentage, text) {
      const fill = document.getElementById('progress-fill');
      const label = document.getElementById('progress-label');
      const percentageDisplay = document.getElementById('progress-percentage');
      
      if (fill) fill.style.width = `${percentage}%`;
      if (label) label.textContent = text;
      if (percentageDisplay) percentageDisplay.textContent = `${Math.round(percentage)}%`;
    }
    
    // Show notification
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notification-text');
      
      notification.className = `notification ${type}`;
      notificationText.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => notification.classList.remove('show'), 3000);
    }
    
    // Open report modal
    function openReport(data) {
      const modal = document.getElementById('reportModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Initialize charts with data
      initCharts(data);
      
      // Update prediction values
      document.getElementById('predictedTemp').textContent = `${data.prediction.temp.toFixed(1)}°C`;
      document.getElementById('predictedPrecip').textContent = `${data.prediction.precip.toFixed(0)} mm`;
      document.getElementById('predictedFrost').textContent = `${data.prediction.frost} days`;
    }
    
    // Close report modal
    function closeReport() {
      const modal = document.getElementById('reportModal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    
    // Print report
    function printReport() {
      window.print();
    }
    
    // Toggle satellite layer
    function toggleSatellite() {
      if (map.hasLayer(satelliteLayer)) {
        map.removeLayer(satelliteLayer);
        map.addLayer(osmLayer);
        document.getElementById('satelliteBtn').classList.remove('btn-primary');
        document.getElementById('satelliteBtn').classList.add('btn-outline');
        showNotification("Standard map view activated", 'info');
      } else {
        map.removeLayer(osmLayer);
        map.addLayer(satelliteLayer);
        document.getElementById('satelliteBtn').classList.add('btn-primary');
        document.getElementById('satelliteBtn').classList.remove('btn-outline');
        showNotification("Satellite vegetation view activated", 'success');
      }
    }
    
    // Download report as PDF - IMPROVED VERSION
    function downloadReport() {
      const loadingOverlay = document.getElementById('pdfLoading');
      loadingOverlay.style.display = 'flex';
      
      const reportContent = document.querySelector('.report-content');
      const originalHeight = reportContent.style.height;
      const originalOverflow = reportContent.style.overflow;
      
      // Temporarily make content visible for capture
      reportContent.style.height = 'auto';
      reportContent.style.overflow = 'visible';
      
      // Add report title to each page
      const header = document.createElement('div');
      header.innerHTML = `
        <div style="position:fixed; top:10px; left:0; right:0; text-align:center; font-size:14px; color:#2e7d32; z-index:9999;">
          PlaasRisk Climate Report - ${new Date().toLocaleDateString()}
        </div>
      `;
      document.body.appendChild(header);
      
      html2canvas(reportContent, {
        scale: 3,
        useCORS: true,
        logging: false,
        onclone: function(clonedDoc) {
          clonedDoc.body.appendChild(header.cloneNode(true));
        }
      }).then(canvas => {
        // Remove temporary elements
        document.body.removeChild(header);
        
        // Restore original styles
        reportContent.style.height = originalHeight;
        reportContent.style.overflow = originalOverflow;
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        let pageCount = 1;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add page number to first page
        pdf.setFontSize(10);
        pdf.text(`Page ${pageCount}`, imgWidth - 20, pageHeight - 10);
        pageCount++;
        
        // Add additional pages if needed
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          
          // Add page number
          pdf.text(`Page ${pageCount}`, imgWidth - 20, pageHeight - 10);
          pageCount++;
          
          heightLeft -= pageHeight;
        }
        
        // Save the PDF
        pdf.save(`PlaasRisk_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        loadingOverlay.style.display = 'none';
        showNotification("Report downloaded successfully!", 'success');
      })
      .catch(error => {
        console.error('Error generating PDF:', error);
        document.body.removeChild(header);
        loadingOverlay.style.display = 'none';
        showNotification("Failed to generate PDF. Try the print option.", 'error');
      });
    }
    
    // Initialize charts in report
    function initCharts(data) {
      // Temperature chart
      const tempCtx = document.getElementById('temperatureChart').getContext('2d');
      new Chart(tempCtx, {
        type: 'line',
        data: {
          labels: data.temp.labels,
          datasets: [{
            label: 'Average Temperature (°C)',
            data: data.temp.values,
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Average Temperature Trend',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Temperature (°C)' }
            }
          }
        }
      });
      
      // Precipitation chart
      const precipCtx = document.getElementById('precipitationChart').getContext('2d');
      new Chart(precipCtx, {
        type: 'bar',
        data: {
          labels: data.precip.labels,
          datasets: [{
            label: 'Average Precipitation (mm)',
            data: data.precip.values,
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Monthly Precipitation Averages',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Precipitation (mm)' }
            }
          }
        }
      });
      
      // Annual Rainfall Chart
      const annualRainfallCtx = document.getElementById('annualRainfallChart').getContext('2d');
      new Chart(annualRainfallCtx, {
        type: 'bar',
        data: {
          labels: data.annualRainfall.labels,
          datasets: [{
            label: 'Annual Rainfall (mm)',
            data: data.annualRainfall.values,
            backgroundColor: '#4caf50',
            borderColor: '#2e7d32',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Rainfall Totals',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Rainfall (mm)' }
            }
          }
        }
      });
      
      // Frost chart
      const frostCtx = document.getElementById('frostChart').getContext('2d');
      new Chart(frostCtx, {
        type: 'line',
        data: {
          labels: data.frost.labels,
          datasets: [{
            label: 'Frost Days per Year',
            data: data.frost.values,
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30, 136, 229, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Frost Days',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Days per Year' }
            }
          }
        }
      });
      
      // Drought chart
      const droughtCtx = document.getElementById('droughtChart').getContext('2d');
      new Chart(droughtCtx, {
        type: 'bar',
        data: {
          labels: data.drought.labels,
          datasets: [{
            label: 'Rainfall Departure (%)',
            data: data.drought.values,
            backgroundColor: data.drought.values.map(value => {
              if (value < -50) return '#f44336'; // Severe drought
              if (value < -26) return '#ff9800'; // Moderate drought
              return '#8d6e63'; // Normal
            }),
            borderColor: '#6d4c41',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Annual Rainfall Departure from Average',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: 'Percentage Departure (%)' }
            }
          }
        }
      });
      
      // Update stats
      document.getElementById('avgTempValue').textContent = `${data.stats.avgTemp}°C`;
      document.getElementById('maxTempValue').textContent = `${data.stats.maxTemp}°C`;
      document.getElementById('minTempValue').textContent = `${data.stats.minTemp}°C`;
      document.getElementById('warmingValue').textContent = `${data.stats.warming >= 0 ? '+' : ''}${data.stats.warming}°C`;
      document.getElementById('annualPrecip').textContent = `${data.stats.annualPrecip} mm`;
      document.getElementById('maxMonthlyPrecip').textContent = `${data.stats.maxMonthlyPrecip} mm`;
      document.getElementById('drySpells').textContent = `${data.stats.drySpells}/yr`;
      document.getElementById('precipTrend').textContent = `${data.stats.precipTrend >= 0 ? '+' : ''}${data.stats.precipTrend}%`;
      document.getElementById('reportLocation').textContent = `${data.location.coords} (${data.location.name})`;
      
      // Update years with frost
      const highFrostYears = document.getElementById('highFrostYears');
      highFrostYears.innerHTML = '';
      data.stats.highFrostYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge frost';
        badge.textContent = year;
        highFrostYears.appendChild(badge);
      });
      
      // Update drought years
      const moderateDroughtYears = document.getElementById('moderateDroughtYears');
      moderateDroughtYears.innerHTML = '';
      data.stats.moderateDroughtYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge moderate-drought';
        badge.textContent = year;
        moderateDroughtYears.appendChild(badge);
      });
      
      const severeDroughtYears = document.getElementById('severeDroughtYears');
      severeDroughtYears.innerHTML = '';
      data.stats.severeDroughtYears.forEach(year => {
        const badge = document.createElement('div');
        badge.className = 'year-badge severe-drought';
        badge.textContent = year;
        severeDroughtYears.appendChild(badge);
      });
      
      // Generate climate commentary
      generateClimateCommentary(data);
    }
    
    // Generate climate commentary
    function generateClimateCommentary(data) {
      const commentary = document.getElementById('climateCommentary');
      
      // Generate commentary based on data
      commentary.innerHTML = `
        <p>The climate analysis for <strong>${data.location.name}</strong> (${data.location.coords}) reveals a ${data.stats.warming >= 0 ? 'warming' : 'cooling'} trend of <strong>${Math.abs(data.stats.warming)}°C</strong> over the past ${data.temp.labels.length} years. This represents a significant shift in temperature patterns that may affect crop selection and growing seasons.</p>
        
        <h4>Frost Analysis</h4>
        <p>High frost events occurred in <strong>${data.stats.highFrostYears.join(', ')}</strong>, which presents challenges for frost-sensitive crops. The highest number of frost days (${Math.max(...data.frost.values)}) was recorded in ${data.stats.highFrostYears[0]}. Frost typically occurs between May and August in this region. The prediction for the upcoming year shows <strong>${data.prediction.frost} frost days</strong>, which is ${data.prediction.frost > 15 ? 'above' : 'below'} the historical average.</p>
        
        <div class="parameters-box">
          <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
        </div>
        
        <h4 class="drought-header">Drought Analysis</h4>
        <p>Drought conditions were most severe in <strong>${data.stats.severeDroughtYears.join(', ')}</strong>, requiring careful water management planning. The most significant rainfall departure was ${Math.min(...data.drought.values).toFixed(1)}% in ${data.stats.severeDroughtYears[0]}. Precipitation patterns show increasing variability during the rainy season.</p>
        
        <div class="drought-classification">
          <div class="drought-class moderate-drought-box">
            <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
            <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
          
          <div class="drought-class severe-drought-box">
            <h5><i class="fas fa-fire"></i> Severe Drought</h5>
            <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
          </div>
        </div>
        
        <p>Based on these patterns, farmers should consider implementing water conservation techniques and selecting frost-resistant crop varieties. The warming trend suggests that heat-tolerant varieties may become increasingly important in the coming decades.</p>
      `;
    }

    // Event handlers
    map.on(L.Draw.Event.CREATED, function (e) {
      if (e.layerType === 'polygon') {
        const layer = e.layer;
        const latlngs = layer.getLatLngs()[0];
        
        if (latlngs.length < 3) {
          showNotification("Please draw a valid polygon with at least 3 points", "error");
          return;
        }
        
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);

        const latSum = latlngs.reduce((sum, pt) => sum + pt.lat, 0);
        const lngSum = latlngs.reduce((sum, pt) => sum + pt.lng, 0);
        const center = {
          lat: latSum / latlngs.length,
          lng: lngSum / latlngs.length
        };
        lastPolygonCenter = center;
        
        // Update search input with coordinates
        document.getElementById('searchInput').value = `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        
        showNotification(`Farm boundary drawn at ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 'success');
        
        checkDataAvailability(center.lat, center.lng);
      }
    });
    
    // Function to check data availability
    function checkDataAvailability(lat, lng) {
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        updateProgress(progress, `Checking data availability... ${progress}%`);
        
        if (progress >= 100) {
          clearInterval(interval);
          
          const isLand = !(lat < -60 || lat > 60 || Math.abs(lng) > 170);
          const isRemote = Math.abs(lat) > 55 || Math.abs(lng) > 140;
          
          if (!isLand) {
            showNotification("No data available (ocean location)", "error");
            dataAvailable = false;
          } else if (isRemote) {
            showNotification("Limited data available (remote area)", "warning");
            dataAvailable = true;
          } else {
            showNotification("Reliable data available", "success");
            dataAvailable = true;
          }
        }
      }, 200);
    }

    // Activate pin drop mode
    function activatePinMode() {
      pinModeActive = true;
      document.getElementById('dropPinBtn').classList.add('btn-primary');
      document.getElementById('dropPinBtn').classList.remove('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Click on Map';
      
      // Add event listener for map click
      map.on('click', handleMapClick);
      
      showNotification("Click on the map to drop a pin", 'info');
    }
    
    // Handle map click for pin drop
    function handleMapClick(e) {
      if (!pinModeActive) return;
      
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      
      // Clear any existing markers
      if (currentMarker) map.removeLayer(currentMarker);
      
      // Add new marker
      currentMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup("Dropped Pin: " + lat.toFixed(4) + ", " + lng.toFixed(4))
        .openPopup();
      
      // Update search input
      document.getElementById("searchInput").value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      lastPolygonCenter = { lat, lng };
      
      // Check data availability
      checkDataAvailability(lat, lng);
      
      // Deactivate pin mode
      pinModeActive = false;
      document.getElementById('dropPinBtn').classList.remove('btn-primary');
      document.getElementById('dropPinBtn').classList.add('btn-outline');
      document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Drop Pin';
      
      // Remove event listener
      map.off('click', handleMapClick);
      
      showNotification(`Pin dropped at ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
    }
    
    // Location input suggestions
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value;
      if (query.length < 3) {
        document.getElementById('suggestions').style.display = 'none';
        return;
      }
      
      // Clear any existing timeout
      if (geocodeTimeout) clearTimeout(geocodeTimeout);
      
      // Set timeout to avoid too many requests
      geocodeTimeout = setTimeout(() => {
        geocodeLocation(query, true);
      }, 500);
    });
    
    // Search location by text or coordinates
    function searchLocation() {
      const query = document.getElementById('searchInput').value;
      if (!query) {
        showNotification("Enter coordinates or location name to search", 'error');
        return;
      }
      
      // Check if input looks like coordinates
      const coordPattern = /^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)$/;
      const match = query.match(coordPattern);
      
      if (match) {
        // It's coordinates
        const lat = parseFloat(match[1]);
        const lng = parseFloat(match[3]);
        
        if (!isNaN(lat) && !isNaN(lng)) {
          map.setView([lat, lng], 13);
          
          if (currentMarker) map.removeLayer(currentMarker);
          
          currentMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup("Searched Location: " + lat + ", " + lng).openPopup();
          lastPolygonCenter = { lat, lng };
          currentLocationName = "Custom Location";
          showNotification(`Location set to: ${lat}, ${lng}`, 'success');
          
          checkDataAvailability(lat, lng);
        } else {
          showNotification("Invalid coordinates. Please enter in 'latitude, longitude' format.", 'error');
        }
      } else {
        // It's a location name
        geocodeLocation(query);
      }
    }
    
    // Fixed geocoding function with better error handling
    function geocodeLocation(query, forSuggestions = false) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`;
      
      // Cancel previous request if any
      if (currentRequest) {
        currentRequest.abort();
      }
      
      const controller = new AbortController();
      const signal = controller.signal;
      currentRequest = controller;
      
      fetch(url, { signal })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          if (forSuggestions) {
            // Show suggestions
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';
            
            if (data.length === 0) {
              suggestions.style.display = 'none';
              return;
            }
            
            // Use document fragment for efficient DOM updates
            const fragment = document.createDocumentFragment();
            data.forEach(item => {
              const suggestion = document.createElement('div');
              suggestion.className = 'suggestion-item';
              suggestion.textContent = item.display_name;
              suggestion.onclick = () => {
                document.getElementById('searchInput').value = item.display_name;
                suggestions.style.display = 'none';
                
                // Set the location on the map
                const lat = parseFloat(item.lat);
                const lon = parseFloat(item.lon);
                map.setView([lat, lon], 13);
                
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.marker([lat, lon]).addTo(map)
                  .bindPopup(item.display_name)
                  .openPopup();
                
                lastPolygonCenter = { lat, lng: lon };
                currentLocationName = item.display_name;
                checkDataAvailability(lat, lon);
                
                showNotification(`Location set to: ${item.display_name}`, 'success');
              };
              fragment.appendChild(suggestion);
            });
            
            suggestions.appendChild(fragment);
            suggestions.style.display = 'block';
          } else {
            // Process actual search
            if (data.length === 0) {
              showNotification("Location not found. Please try a different name.", 'error');
              return;
            }
            
            const item = data[0];
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            
            map.setView([lat, lon], 13);
            
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(map)
              .bindPopup(item.display_name)
              .openPopup();
            
            lastPolygonCenter = { lat, lng: lon };
            currentLocationName = item.display_name;
            checkDataAvailability(lat, lon);
            
            showNotification(`Location set to: ${item.display_name}`, 'success');
          }
        })
        .catch(error => {
          if (error.name === 'AbortError') {
            console.log('Request aborted');
          } else {
            console.error('Geocoding error:', error);
            if (!forSuggestions) {
              showNotification("Error finding location. Please try again.", 'error');
            }
          }
        })
        .finally(() => {
          currentRequest = null;
        });
    }

    // Reset map
    function resetMap() {
      drawnItems.clearLayers();
      lastPolygonCenter = null;
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
      map.setView([-25.0, 30.0], 5);
      document.getElementById("searchInput").value = "";
      document.getElementById('suggestions').style.display = 'none';
      currentLocationName = "South Africa";
      
      // Reset progress bar
      updateProgress(0, 'Ready');
      
      // Reset pin mode if active
      if (pinModeActive) {
        pinModeActive = false;
        map.off('click', handleMapClick);
        document.getElementById('dropPinBtn').classList.remove('btn-primary');
        document.getElementById('dropPinBtn').classList.add('btn-outline');
        document.getElementById('dropPinBtn').innerHTML = '<i class="fas fa-map-pin"></i> Drop Pin';
      }
      
      // Reset to standard map view
      if (map.hasLayer(satelliteLayer)) {
        map.removeLayer(satelliteLayer);
        map.addLayer(osmLayer);
        document.getElementById('satelliteBtn').classList.remove('btn-primary');
        document.getElementById('satelliteBtn').classList.add('btn-outline');
      }
    }

    // Generate report with real climate data
    async function generateReport() {
      if (!lastPolygonCenter) {
        showNotification("Draw a farm boundary or search a location first.", 'error');
        return;
      }
      
      if (!dataAvailable) {
        showNotification("No data available for this location. Please choose another location.", 'error');
        return;
      }

      const lat = lastPolygonCenter.lat.toFixed(4);
      const lon = lastPolygonCenter.lng.toFixed(4);
      
      // API request parameters
      const startDate = "2000-01-01";
      const endDate = "2024-12-31";
      const apiUrl = `https://archive-api.open-meteo.com/v1/era5?latitude=${lat}&longitude=${lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_min,temperature_2m_max,precipitation_sum&timezone=auto`;
      
      try {
        // Cancel any previous request
        if (currentRequest) {
          currentRequest.abort();
        }
        
        const controller = new AbortController();
        const signal = controller.signal;
        currentRequest = controller;
        
        // Step 1: Fetch data
        updateProgress(0, "Starting data retrieval...");
        
        // Simulate progress during fetch
        let fetchProgress = 0;
        const fetchInterval = setInterval(() => {
          if (fetchProgress < 95) {
            fetchProgress += 5;
            updateProgress(fetchProgress, `Fetching data... ${fetchProgress}%`);
          }
        }, 200);
        
        const response = await fetch(apiUrl, { signal });
        if (!response.ok) {
          let errorMessage = `API request failed with status ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.reason) {
              errorMessage = errorData.reason;
            }
          } catch (e) {
            // Ignore JSON parse error
          }
          throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        // Clear interval immediately after fetch
        clearInterval(fetchInterval);
        updateProgress(100, "Data fetched!");
        
        showNotification("Climate data retrieved successfully! Generating report...", 'success');
        
        // Process data for charts and stats
        const processedData = processClimateData(data, lat, lon);
        
        // Open the report modal
        setTimeout(() => {
          openReport(processedData);
        }, 500);
      } catch (err) {
        console.error('Error generating report:', err);
        showNotification("Couldn't fetch data for this location", 'error');
      } finally {
        currentRequest = null;
      }
    }
    
    // Process climate data for charts and stats
    function processClimateData(apiData, lat, lon) {
      const daily = apiData.daily;
      const times = daily.time;
      const tempMin = daily.temperature_2m_min;
      const tempMax = daily.temperature_2m_max;
      const precipitation = daily.precipitation_sum;
      
      // Initialize data structures
      const years = [];
      const annualAvgTemp = [];
      const annualPrecip = [];
      const annualFrostDays = [];
      
      const monthlyPrecip = Array(12).fill(0);
      const monthlyCounts = Array(12).fill(0);
      
      // Track min/max values
      let minTemp = Infinity;
      let maxTemp = -Infinity;
      let totalPrecip = 0;
      let frostDays = 0;
      
      // Process each day
      for (let i = 0; i < times.length; i++) {
        const date = new Date(times[i]);
        const year = date.getFullYear();
        const month = date.getMonth();
        
        const avgTemp = (tempMin[i] + tempMax[i]) / 2;
        
        // Initialize year data if new year
        if (!years.includes(year)) {
          years.push(year);
          annualAvgTemp.push(0);
          annualPrecip.push(0);
          annualFrostDays.push(0);
        }
        
        const yearIndex = years.indexOf(year);
        
        // Accumulate annual data
        annualAvgTemp[yearIndex] += avgTemp;
        annualPrecip[yearIndex] += precipitation[i];
        
        // Check for frost
        if (tempMin[i] < 0) {
          annualFrostDays[yearIndex]++;
          frostDays++;
        }
        
        // Track min/max temps
        if (tempMin[i] < minTemp) minTemp = tempMin[i];
        if (tempMax[i] > maxTemp) maxTemp = tempMax[i];
        
        // Accumulate monthly precipitation
        monthlyPrecip[month] += precipitation[i];
        monthlyCounts[month]++;
        
        totalPrecip += precipitation[i];
      }
      
      // Calculate averages
      for (let i = 0; i < years.length; i++) {
        annualAvgTemp[i] = parseFloat((annualAvgTemp[i] / 365).toFixed(1));
      }
      
      for (let i = 0; i < 12; i++) {
        if (monthlyCounts[i] > 0) {
          monthlyPrecip[i] = parseFloat((monthlyPrecip[i] / monthlyCounts[i]).toFixed(1));
        }
      }
      
      // Calculate warming trend
      const warmingTrend = parseFloat((annualAvgTemp[annualAvgTemp.length - 1] - annualAvgTemp[0]).toFixed(1));
      
      // Calculate precipitation trend
      const precipTrend = parseFloat(((annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / annualPrecip[0] * 100).toFixed(1));
      
      // Find max monthly precipitation
      const maxMonthlyPrecip = Math.max(...monthlyPrecip).toFixed(1);
      
      // Calculate average dry spells (months with < 30mm precipitation)
      const drySpells = monthlyPrecip.filter(p => p < 30).length;
      
      // Identify years with high frost (above 15 days)
      const highFrostYears = [];
      for (let i = 0; i < years.length; i++) {
        if (annualFrostDays[i] > 15) {
          highFrostYears.push(years[i]);
        }
      }
      
      // Calculate long-term average precipitation (30 years)
      const longTermAvg = annualPrecip.reduce((a, b) => a + b, 0) / annualPrecip.length;
      
      // Calculate precipitation departure for each year
      const annualDeparture = annualPrecip.map(precip => 
        parseFloat(((precip - longTermAvg) / longTermAvg * 100).toFixed(1))
      );
      
      // Identify drought years based on departure
      const moderateDroughtYears = [];
      const severeDroughtYears = [];
      
      for (let i = 0; i < years.length; i++) {
        const departure = annualDeparture[i];
        if (departure < -50) {
          severeDroughtYears.push(years[i]);
        } else if (departure < -26) {
          moderateDroughtYears.push(years[i]);
        }
      }
      
      // Generate labels for years
      const yearLabels = years.map(y => y.toString());
      
      // PREDICTIVE MODEL for next year (2025)
      // Simple linear regression based on historical trends
      const lastYear = years[years.length - 1];
      const nextYear = lastYear + 1;
      
      // Predict temperature
      const tempSlope = warmingTrend / (years.length - 1);
      const predictedTemp = annualAvgTemp[annualAvgTemp.length - 1] + tempSlope;
      
      // Predict precipitation
      const precipSlope = (annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / (years.length - 1);
      const predictedPrecip = annualPrecip[annualAvgTemp.length - 1] + precipSlope;
      
      // Predict frost days
      const frostSlope = (annualFrostDays[annualFrostDays.length - 1] - annualFrostDays[0]) / (years.length - 1);
      const predictedFrost = Math.max(0, annualFrostDays[annualFrostDays.length - 1] + frostSlope).toFixed(0);
      
      // Prepare data for charts
      return {
        location: {
          coords: `${lat}, ${lon}`,
          name: currentLocationName
        },
        temp: {
          labels: yearLabels,
          values: annualAvgTemp
        },
        precip: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          values: monthlyPrecip
        },
        // Annual Rainfall Data
        annualRainfall: {
          labels: yearLabels,
          values: annualPrecip.map(p => parseFloat(p.toFixed(1)))
        },
        frost: {
          labels: yearLabels,
          values: annualFrostDays
        },
        drought: {
          labels: yearLabels,
          values: annualDeparture
        },
        stats: {
          avgTemp: (annualAvgTemp.reduce((a, b) => a + b, 0) / annualAvgTemp.length).toFixed(1),
          maxTemp: maxTemp.toFixed(1),
          minTemp: minTemp.toFixed(1),
          warming: warmingTrend,
          annualPrecip: longTermAvg.toFixed(1),
          maxMonthlyPrecip,
          drySpells: (drySpells / years.length).toFixed(1),
          precipTrend: precipTrend,
          highFrostYears,
          moderateDroughtYears,
          severeDroughtYears
        },
        prediction: {
          year: nextYear,
          temp: predictedTemp,
          precip: predictedPrecip,
          frost: predictedFrost
        }
      };
    }
    
    // Initialize progress bar
    updateProgress(0, 'Ready');
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      const suggestions = document.getElementById('suggestions');
      const searchInput = document.getElementById('searchInput');
      
      if (suggestions && searchInput) {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.style.display = 'none';
        }
      }
    });
    
    // Handle window resize for mobile devices
    window.addEventListener('resize', function() {
      if (map) {
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      }
    });
  </script>
</body>
</html>
