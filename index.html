<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlaasRisk - Advanced Climate Analysis</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --primary-dark: #1b5e20;
      --secondary: #388e3c;
      --accent: #f57c00;
      --accent-light: #ffb74d;
      --accent-dark: #e65100;
      --light: #f5f9f5;
      --light-gray: #f8f9fa;
      --dark: #2d3748;
      --text: #333333;
      --border: #e0e0e0;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --frost-blue: #1e88e5;
      --frost-light: #bbdefb;
      --drought-brown: #8d6e63;
      --drought-light: #efebe9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f9f5 0%, #e8f5e9 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 15px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .map-section {
      flex: 1;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin: 15px 0;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    #map {
      flex: 1;
      z-index: 1;
      background: #e8f5e9;
    }
    
    /* HORIZONTAL CONTROL BAR */
    .control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px;
      background: white;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      position: relative;
      align-items: center;
      justify-content: space-between;
    }
    
    @media (max-width: 1200px) {
      .control-bar {
        gap: 10px;
        padding: 10px;
      }
    }
    
    @media (max-width: 768px) {
      .control-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 300px;
    }
    
    @media (max-width: 768px) {
      .control-group {
        min-width: 100%;
      }
    }
    
    .input-with-icon {
      position: relative;
      flex: 1;
    }
    
    .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 9px 12px 9px 35px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s;
      background: var(--light-gray);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      background: white;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      gap: 6px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(46, 125, 50, 0.25);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      font-weight: 500;
    }
    
    .btn-outline:hover {
      background: rgba(46, 125, 50, 0.08);
    }
    
    .btn-sm {
      padding: 7px 10px;
      font-size: 0.85rem;
    }
    
    .btn-block {
      width: 100%;
    }
    
    .map-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .map-actions .btn {
      flex: 1;
      min-width: 110px;
    }
    
    @media (max-width: 768px) {
      .map-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .map-actions .btn {
        min-width: auto;
        flex: none;
      }
    }
    
    .progress-container {
      width: 200px;
      margin-left: 15px;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
      color: var(--dark);
    }
    
    .progress-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 5px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .progress-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 0.7rem;
      font-weight: 500;
      text-shadow: 0 1px 1px rgba(0,0,0,0.3);
    }
    
    .suggestions-box {
      position: absolute;
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 180px;
      overflow-y: auto;
      z-index: 1001;
      margin-top: 4px;
      display: none;
      border: 1px solid var(--border);
    }
    
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
      font-size: 0.85rem;
    }
    
    .suggestion-item:hover {
      background: var(--light);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .notification {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(200%);
      transition: transform 0.4s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .notification {
        top: auto;
        bottom: 15px;
        left: 15px;
        right: 15px;
        width: calc(100% - 30px);
      }
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: var(--success);
    }
    
    .notification.error {
      background: var(--danger);
    }
    
    .notification.info {
      background: var(--primary);
    }
    
    footer {
      text-align: center;
      padding: 8px;
      color: #666;
      font-size: 0.8rem;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-top: 12px;
    }
    
    /* Redesigned PlaasRisk Logo */
    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 10px;
    }
    
    .plaasrisk-logo {
      height: 40px;
      width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    .logo-icon {
      color: white;
      font-size: 22px;
      position: relative;
      z-index: 2;
    }
    
    .logo-text {
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      position: relative;
    }
    
    .logo-text::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    /* Report Modal */
    .report-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 3000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .report-modal.active {
      display: block;
      opacity: 1;
    }
    
    .report-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      margin: 20px auto;
      padding: 30px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-height: 95vh;
      overflow-y: auto;
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .report-title {
      font-size: 1.8rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .close-report {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }
    
    .close-report:hover {
      color: var(--danger);
    }
    
    .report-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 992px) {
      .report-body {
        grid-template-columns: 1fr;
      }
    }
    
    .report-section {
      background: var(--light);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    .report-section h3 {
      margin-bottom: 15px;
      color: var(--primary-dark);
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
      margin-top: 15px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    .report-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .report-actions {
      display: flex;
      gap: 12px;
    }
    
    .download-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
    }
    
    .download-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(46, 125, 50, 0.4);
    }
    
    .close-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 25px;
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .close-btn:hover {
      background: #e0e0e0;
    }
    
    .location-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .location-badge {
      background: var(--light);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Years sections */
    .years-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .years-container {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .years-container h4 {
      margin-bottom: 10px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .years-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .year-badge {
      padding: 5px 10px;
      background: #e8f5e9;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .year-badge.frost {
      background: var(--frost-light);
      color: var(--frost-blue);
    }
    
    .year-badge.drought {
      background: var(--drought-light);
      color: var(--drought-brown);
    }
    
    .year-badge.moderate-drought {
      background: #ffecb3;
      color: #ff9800;
    }
    
    .year-badge.severe-drought {
      background: #ffcdd2;
      color: #f44336;
    }
    
    /* Commentary Section */
    .commentary-section {
      grid-column: 1 / -1;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid var(--primary);
    }
    
    .commentary-section h3 {
      color: var(--primary-dark);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .commentary-content {
      line-height: 1.7;
      padding: 10px;
    }
    
    .commentary-content p {
      margin-bottom: 15px;
    }
    
    .commentary-content h4 {
      color: var(--frost-blue);
      margin: 20px 0 10px 0;
      border-bottom: 1px solid var(--frost-light);
      padding-bottom: 5px;
    }
    
    .commentary-content .drought-header {
      color: var(--drought-brown);
      border-bottom: 1px solid var(--drought-light);
    }
    
    .parameters-box {
      background: white;
      border-left: 3px solid var(--primary);
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .drought-classification {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .drought-class {
      flex: 1;
      min-width: 200px;
      padding: 15px;
      border-radius: 8px;
      color: white;
    }
    
    .moderate-drought-box {
      background: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%);
    }
    
    .severe-drought-box {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }
    
    .drought-class h5 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .drought-class p {
      font-size: 0.9rem;
      margin-bottom: 0;
    }
    
    /* Report Headers */
    .report-header-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .report-header-section h2 {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Prediction Section */
    .prediction-section {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
      color: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .prediction-section::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      z-index: 1;
    }
    
    .prediction-section::after {
      content: "";
      position: absolute;
      bottom: -30%;
      left: -30%;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      z-index: 1;
    }
    
    .prediction-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }
    
    .prediction-header h3 {
      font-size: 1.8rem;
      margin: 0;
    }
    
    .prediction-content {
      display: flex;
      gap: 20px;
      position: relative;
      z-index: 2;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .prediction-content {
        flex-direction: column;
      }
    }
    
    .prediction-card {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 300px;
    }
    
    .prediction-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .prediction-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      text-align: center;
    }
    
    .prediction-label {
      text-align: center;
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .prediction-trend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .trend-up {
      color: #ff7043;
    }
    
    .trend-down {
      color: #81c784;
    }
    
    .prediction-gauge {
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      margin-top: 15px;
      position: relative;
      overflow: hidden;
    }
    
    .gauge-fill {
      height: 100%;
      border-radius: 10px;
      position: absolute;
      left: 0;
      top: 0;
      transition: width 1s ease;
    }
    
    .gauge-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    
    .prediction-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
      position: relative;
      z-index: 2;
    }
    
    /* Frost Risk Indicator */
    .frost-risk {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
      gap: 8px;
    }
    
    .risk-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
    }
    
    .risk-low { background-color: #4caf50; }
    .risk-moderate { background-color: #ff9800; }
    .risk-high { background-color: #f44336; }
    
    /* Report Letterhead */
    .letterhead {
      position: relative;
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary);
    }
    
    .letterhead-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .letterhead-logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .letterhead-text {
      text-align: right;
    }
    
    .letterhead-text h1 {
      color: var(--primary-dark);
      font-size: 2.2rem;
      margin-bottom: 5px;
    }
    
    .letterhead-text p {
      color: #666;
      font-size: 0.9rem;
    }
    
    /* PDF loading overlay */
    .pdf-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 4000;
      color: white;
      display: none;
    }
    
    .pdf-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Prepared by section */
    .prepared-by {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--primary);
    }
    
    .prepared-by strong {
      color: var(--primary-dark);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .report-content {
        padding: 20px;
      }
      
      .report-title {
        font-size: 1.4rem;
      }
      
      .report-section {
        padding: 15px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .report-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .report-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .years-section {
        flex-direction: column;
      }
      
      .progress-container {
        width: 100%;
        margin: 12px 0 0 0;
      }
      
      .drought-classification {
        flex-direction: column;
      }
      
      .prediction-value {
        font-size: 2rem;
      }
      
      .letterhead-content {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .letterhead-text {
        text-align: center;
      }
    }
    
    /* Frost Analysis Specific Styles */
    .frost-months {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .month-tag {
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .frost-month {
      background: var(--frost-light);
      color: var(--frost-blue);
    }
    
    .normal-month {
      background: var(--light);
      color: var(--text);
    }
    
    .key-indicators {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    .indicator-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    
    .highlight-box {
      background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .highlight-box h3 {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Planting Date Model Styles */
    .planting-table-container {
      grid-column: 1 / -1;
      margin-top: 20px;
    }
    
    .planting-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .planting-table th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }
    
    .planting-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .planting-table tr:nth-child(even) {
      background: var(--light-gray);
    }
    
    .planting-table tr:hover {
      background: #e8f5e9;
    }
    
    .planting-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-optimal {
      background: #e8f5e9;
      color: var(--success);
    }
    
    .status-good {
      background: #fff3e0;
      color: var(--warning);
    }
    
    .status-poor {
      background: #ffebee;
      color: var(--danger);
    }
    
    .rainfall-amount {
      font-weight: 600;
      color: var(--primary);
    }
    
    .planting-recommendation {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid var(--frost-blue);
    }
    
    .recommendation-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--frost-blue);
    }
    
    .recommendation-list {
      list-style: none;
      padding: 0;
    }
    
    .recommendation-list li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(30, 136, 229, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .recommendation-list li:last-child {
      border-bottom: none;
    }
    
    .recommendation-icon {
      color: var(--frost-blue);
      width: 20px;
      text-align: center;
    }
    
    .planting-section {
      grid-column: 1 / -1;
      background: var(--light);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }
    
    .planting-section h3 {
      color: var(--primary-dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.4rem;
    }
    
    .model-criteria {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid var(--accent);
    }
    
    .model-criteria h4 {
      color: var(--accent-dark);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .criteria-list {
      list-style: none;
      padding: 0;
    }
    
    .criteria-list li {
      padding: 5px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .criteria-icon {
      color: var(--accent);
      width: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-section">
      <div class="control-bar">
        <div class="logo-container">
          <div class="plaasrisk-logo">
            <i class="fas fa-seedling logo-icon"></i>
          </div>
          <div class="logo-text">PlaasRisk</div>
        </div>
        
        <div class="control-group">
          <div class="input-with-icon">
            <i class="fas fa-search input-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Enter coordinates or location (e.g. -25.0, 30.0 or Johannesburg)" />
            <div id="suggestions" class="suggestions-box"></div>
          </div>
          
          <button class="btn btn-primary" onclick="searchLocation()">
            <i class="fas fa-search-location"></i> Search
          </button>
          
          <!-- Progress bar moved next to GPS input -->
          <div class="progress-container">
            <div class="progress-header">
              <span>Data Retrieval</span>
              <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
              <div class="progress-label" id="progress-label">Ready</div>
            </div>
          </div>
        </div>
        
        <div class="map-actions">
          <button class="btn btn-outline" onclick="resetMap()">
            <i class="fas fa-trash-alt"></i> Clear
          </button>
          <button class="btn btn-primary" onclick="generateReport()" id="generateBtn">
            <i class="fas fa-chart-line"></i> Analyze
          </button>
          <button class="btn btn-outline" id="dropPinBtn" onclick="activatePinMode()">
            <i class="fas fa-map-pin"></i> Drop Pin
          </button>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
    
    <footer>
      <p>Farm Climate Analysis Tool • Data provided by Open-Meteo Historical Weather API</p>
      <p style="margin-top: 5px; font-size: 0.8rem; color: #777;">Platform developed by Macdonald Makoro: 076-623-2221</p>
    </footer>
  </div>
  
  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text">Notification message</span>
  </div>
  
  <!-- PDF Loading Overlay -->
  <div class="pdf-loading-overlay" id="pdfLoading">
    <div class="pdf-spinner"></div>
    <h3>Generating PDF Report</h3>
    <p>Please wait while we prepare your full report...</p>
  </div>
  
  <!-- Report Modal -->
  <div class="report-modal" id="reportModal">
    <div class="report-content">
      <!-- Report Letterhead -->
      <div class="letterhead">
        <div class="letterhead-content">
          <div class="letterhead-logo">
            <div class="plaasrisk-logo">
              <i class="fas fa-seedling logo-icon"></i>
            </div>
            <div>
              <h1 class="logo-text">PlaasRisk</h1>
              <p>Advanced Farm Climate Analysis</p>
            </div>
          </div>
          <div class="letterhead-text">
            <p>Date: <span id="reportDate">${new Date().toLocaleDateString()}</span></p>
            <p>Prepared for: <strong>Macdonald Makoro</strong></p>
          </div>
        </div>
      </div>
      
      <div class="report-header">
        <h2 class="report-title">
          <i class="fas fa-file-alt"></i>
          Farm Climate Analysis Report
        </h2>
        <button class="close-report" onclick="closeReport()">&times;</button>
      </div>
      
      <div class="report-body">
        <div class="report-header-section">
          <h2><i class="fas fa-tractor"></i> Farm Climate Risk Assessment</h2>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-temperature-low"></i> Temperature Analysis</h3>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Average Temp</div>
              <div class="stat-value" id="avgTempValue">21.4°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Temp</div>
              <div class="stat-value" id="maxTempValue">34.2°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Min Temp</div>
              <div class="stat-value" id="minTempValue">-1.3°C</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Warming Trend</div>
              <div class="stat-value" id="warmingValue">+1.2°C</div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-cloud-rain"></i> Precipitation Analysis</h3>
          <div class="chart-container">
            <canvas id="precipitationChart"></canvas>
          </div>
          
          <div class="chart-container" style="margin-top: 25px;">
            <canvas id="annualRainfallChart"></canvas>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Annual Avg</div>
              <div class="stat-value" id="annualPrecip">625 mm</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Max Monthly</div>
              <div class="stat-value" id="maxMonthlyPrecip">210 mm</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Dry Spells</div>
              <div class="stat-value" id="drySpells">3.2/yr</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-label">Trend</div>
              <div class="stat-value" id="precipTrend">-8%</div>
            </div>
          </div>
        </div>
        
        <!-- New Frost Analysis Section -->
        <div class="report-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis & Temperature Comparison</h3>
          <div class="chart-container">
            <canvas id="frostComparisonChart"></canvas>
          </div>
          
          <div class="key-indicators">
            <div class="indicator">
              <div class="indicator-color" style="background-color: #e74c3c;"></div>
              <span>Current Year Temperatures</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #3498db;"></div>
              <span>Historical Average</span>
            </div>
            <div class="indicator">
              <div class="indicator-color" style="background-color: #bbdefb;"></div>
              <span>Frost Threshold (0°C)</span>
            </div>
          </div>
          
          <div class="frost-months" id="frostMonthsList">
            <!-- Months will be populated here -->
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Frost Days This Year</div>
              <div class="stat-value" id="totalFrost">18</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Average Frost Days/Year</div>
              <div class="stat-value" id="avgFrost">15.2</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Coldest Month</div>
              <div class="stat-value" id="coldestMonth">January</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Frost Risk Level</div>
              <div class="stat-value" id="frostRisk">High</div>
            </div>
          </div>
          
          <div class="highlight-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Frost Advisory</h3>
            <p id="frostAdvisoryText">Based on the current data, there is a high probability of frost incidents in the upcoming week. Farmers should take necessary precautions to protect sensitive crops.</p>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-snowflake"></i> Frost Analysis</h3>
          <div class="chart-container">
            <canvas id="frostChart"></canvas>
          </div>
          
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with High Frost Occurrence</h4>
              <div class="years-list" id="highFrostYears">
                <div class="year-badge frost">2010</div>
                <div class="year-badge frost">2012</div>
                <div class="year-badge frost">2015</div>
                <div class="year-badge frost">2018</div>
                <div class="year-badge frost">2021</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="report-section">
          <h3><i class="fas fa-tint-slash"></i> Drought Analysis</h3>
          <div class="chart-container">
            <canvas id="droughtChart"></canvas>
          </div>
          
          <div class="years-section">
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Moderate Drought</h4>
              <div class="years-list" id="moderateDroughtYears">
                <div class="year-badge moderate-drought">2005</div>
                <div class="year-badge moderate-drought">2009</div>
                <div class="year-badge moderate-drought">2016</div>
              </div>
            </div>
            
            <div class="years-container">
              <h4><i class="fas fa-calendar-day"></i> Years with Severe Drought</h4>
              <div class="years-list" id="severeDroughtYears">
                <div class="year-badge severe-drought">2019</div>
                <div class="year-badge severe-drought">2023</div>
              </div>
            </div>
          </div>
        </div>

        <!-- NEW PLANTING DATE MODEL SECTION -->
        <div class="planting-section">
          <h3><i class="fas fa-seedling"></i> Planting Date Model</h3>
          
          <div class="model-criteria">
            <h4><i class="fas fa-list-check"></i> Model Criteria</h4>
            <ul class="criteria-list">
              <li><i class="fas fa-check criteria-icon"></i> Minimum 10mm rainfall within 7 consecutive days</li>
              <li><i class="fas fa-check criteria-icon"></i> Soil temperature above 10°C for warm-season crops</li>
              <li><i class="fas fa-check criteria-icon"></i> No frost expected in following 14 days</li>
              <li><i class="fas fa-check criteria-icon"></i> Optimal planting window: 2-4 weeks after criteria met</li>
            </ul>
          </div>
          
          <div class="planting-table-container">
            <table class="planting-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Rainfall Event Date</th>
                  <th>Total Rainfall (mm)</th>
                  <th>Consecutive Days</th>
                  <th>Recommended Planting</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="plantingDatesTable">
                <!-- Planting dates will be populated here -->
              </tbody>
            </table>
          </div>
          
          <div class="planting-recommendation">
            <div class="recommendation-header">
              <i class="fas fa-lightbulb"></i>
              <h4>Planting Recommendations</h4>
            </div>
            <ul class="recommendation-list" id="plantingRecommendations">
              <!-- Recommendations will be populated here -->
            </ul>
          </div>
        </div>
        
        <!-- Prediction Section -->
        <div class="prediction-section">
          <div class="prediction-header">
            <i class="fas fa-crystal-ball" style="font-size: 2.5rem;"></i>
            <h3>2025 Climate Prediction</h3>
          </div>
          
          <div class="prediction-content">
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-temperature-high"></i>
                <h4>Temperature Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedTemp">22.8°C</div>
              <div class="prediction-label">Annual Average</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>1.4°C above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="tempGauge" style="width: 75%; background: linear-gradient(90deg, #4fc3f7, #e57373);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span>
                <span>Average</span>
                <span>High</span>
              </div>
            </div>
            
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-tint"></i>
                <h4>Precipitation Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedPrecip">580 mm</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-down">
                <i class="fas fa-arrow-down"></i>
                <span>7% below average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="precipGauge" style="width: 65%; background: linear-gradient(90deg, #81c784, #4fc3f7);"></div>
              </div>
              <div class="gauge-labels">
                <span>Dry</span>
                <span>Average</span>
                <span>Wet</span>
              </div>
            </div>
            
            <!-- Frost Prediction Card -->
            <div class="prediction-card">
              <div class="prediction-title">
                <i class="fas fa-snowflake"></i>
                <h4>Frost Forecast</h4>
              </div>
              <div class="prediction-value" id="predictedFrost">18 days</div>
              <div class="prediction-label">Annual Total</div>
              <div class="prediction-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                <span>3 days above average</span>
              </div>
              <div class="prediction-gauge">
                <div class="gauge-fill" id="frostGauge" style="width: 70%; background: linear-gradient(90deg, #bbdefb, #1e88e5);"></div>
              </div>
              <div class="gauge-labels">
                <span>Low</span>
                <span>Average</span>
                <span>High</span>
              </div>
              <div class="frost-risk">
                <div class="risk-indicator risk-high"></div>
                <span>High Frost Risk Expected</span>
              </div>
            </div>
          </div>
          
          <div class="prediction-footer">
            <p><i class="fas fa-info-circle"></i> <span id="predictionSummary">Predictions based on historical trends and seasonal forecasting models. This forecast indicates a warmer and drier year ahead with increased frost risk. Farmers should prepare for potential water shortages, consider heat-tolerant crop varieties, and implement frost protection measures.</span></p>
          </div>
        </div>
        
        <!-- Commentary Section -->
        <div class="commentary-section">
          <h3><i class="fas fa-comment-alt"></i> Climate Commentary</h3>
          <div class="commentary-content" id="climateCommentary">
            <p>The analysis reveals a warming trend of +1.2°C over the past 25 years, with precipitation decreasing by 8% during the same period. This indicates significant climate shifts that may impact agricultural planning.</p>
            
            <h4>Frost Analysis</h4>
            <p>High frost occurrences were most notable in 2010, 2012, 2015, 2018, and 2021, posing risks to sensitive crops during winter months. These frost events primarily occurred during the months of June to August. The prediction for the upcoming year shows an increased frost risk of 18 days, which is significantly above the historical average.</p>
            
            <div class="parameters-box">
              <p><strong>Frost Classification Parameters:</strong> Frost events are classified when minimum temperature drops below -2°C for 3+ consecutive hours, with wind speed &lt; 2 m/s and cloud cover &lt; 20%.</p>
            </div>
            
            <h4 class="drought-header">Drought Analysis</h4>
            <p>Drought conditions were recorded in several years, with moderate drought in 2005, 2009 and 2016, and severe drought in 2019 and 2023. The most prolonged drought period occurred from March to November in 2016.</p>
            
            <div class="drought-classification">
              <div class="drought-class moderate-drought-box">
                <h5><i class="fas fa-exclamation-triangle"></i> Moderate Drought</h5>
                <p>26%–50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
              
              <div class="drought-class severe-drought-box">
                <h5><i class="fas fa-fire"></i> Severe Drought</h5>
                <p>More than 50% below normal rainfall compared to the long-term average (30 years)</p>
              </div>
            </div>
            
            <p>These patterns suggest increasing challenges for water management and crop selection in the coming years. Farmers should consider implementing advanced irrigation techniques and selecting drought-resistant crop varieties.</p>
          </div>
        </div>
        
        <div class="report-section" style="grid-column: 1 / -1; margin-top: 0;">
          <h3><i class="fas fa-lightbulb"></i> Farming Recommendations</h3>
          <ul style="padding-left: 20px; margin-top: 15px;" id="farmingRecommendations">
            <li style="margin-bottom: 10px;">Plant frost-resistant crops during winter months in high-risk years</li>
            <li style="margin-bottom: 10px;">Implement water harvesting systems to mitigate drought impact</li>
            <li style="margin-bottom: 10px;">Use drought-tolerant crop varieties in anticipation of dry spells</li>
            <li style="margin-bottom: 10px;">Schedule planting to avoid peak frost periods in high-risk years</li>
            <li style="margin-bottom: 10px;">Install frost protection systems in vulnerable areas</li>
            <li style="margin-bottom: 10px;">Monitor frost forecasts closely during high-risk months (May-August)</li>
            <li style="margin-bottom: 10px;">Consider crop insurance for frost and drought protection</li>
          </ul>
        </div>
      </div>
      
      <div class="report-footer">
        <div class="location-info">
          <div class="location-badge">
            <i class="fas fa-map-marker-alt"></i>
            <span id="reportLocation">-25.0, 30.0 (South Africa)</span>
          </div>
          <div class="location-badge">
            <i class="fas fa-calendar"></i>
            <span>2000 - 2024</span>
          </div>
        </div>
        
        <div class="report-actions">
          <button class="download-btn" onclick="downloadReport()">
            <i class="fas fa-download"></i> Download Report (PDF)
          </button>
          <button class="download-btn" onclick="printReport()" style="background: #5e35b1;">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="close-btn" onclick="closeReport()">
            <i class="fas fa-times"></i> Close Report
          </button>
        </div>
      </div>
      
      <!-- Prepared by section -->
      <div class="prepared-by">
        Prepared by: <strong>Macdonald Makoro</strong>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Previous JavaScript code remains the same until the planting date functions

    // Add these functions to process planting date data

    // Function to analyze planting dates based on rainfall patterns
    function analyzePlantingDates(dailyData, years) {
      const plantingWindows = [];
      
      years.forEach(year => {
        const yearData = dailyData.time.map((date, idx) => ({
          date: new Date(date),
          rainfall: dailyData.precipitation_sum[idx] || 0,
          year: new Date(date).getFullYear()
        })).filter(item => item.year === year);
        
        // Find 7-day windows with >10mm rainfall
        const windows = findRainfallWindows(yearData, 7, 10);
        
        windows.forEach(window => {
          plantingWindows.push({
            year: year,
            eventDate: window.startDate,
            totalRainfall: window.totalRainfall,
            consecutiveDays: window.days,
            recommendedPlanting: calculatePlantingDate(window.startDate),
            status: assessPlantingQuality(window)
          });
        });
      });
      
      return plantingWindows;
    }

    // Find rainfall windows meeting criteria
    function findRainfallWindows(yearData, minDays, minRainfall) {
      const windows = [];
      
      for (let i = 0; i <= yearData.length - minDays; i++) {
        const window = yearData.slice(i, i + minDays);
        const totalRainfall = window.reduce((sum, day) => sum + day.rainfall, 0);
        
        if (totalRainfall >= minRainfall) {
          windows.push({
            startDate: window[0].date,
            totalRainfall: totalRainfall,
            days: minDays,
            windowData: window
          });
        }
      }
      
      return windows;
    }

    // Calculate optimal planting date (2-4 weeks after rainfall event)
    function calculatePlantingDate(rainfallDate) {
      const plantingDate = new Date(rainfallDate);
      // Add 2-4 weeks (random for demonstration, in real app use soil temp and frost data)
      const weeksToAdd = 2 + Math.floor(Math.random() * 3);
      plantingDate.setDate(plantingDate.getDate() + (weeksToAdd * 7));
      return plantingDate;
    }

    // Assess planting quality based on rainfall amount and timing
    function assessPlantingQuality(window) {
      const rainfall = window.totalRainfall;
      
      if (rainfall >= 20) return 'optimal';
      if (rainfall >= 15) return 'good';
      return 'poor';
    }

    // Update the processClimateData function to include planting analysis
    function processClimateData(historicalData, currentData, lat, lon) {
      updateProgress(60, "Processing climate data...");
      
      const dailyData = historicalData.daily;
      const currentDailyData = currentData.daily;
      
      // Extract years from data
      const years = [...new Set(dailyData.time.map(date => new Date(date).getFullYear()))].sort();
      const yearLabels = years.map(y => y.toString());
      
      // Calculate annual averages (existing code)
      const annualAvgTemp = years.map(year => {
        const yearIndices = dailyData.time.map((date, idx) => 
          new Date(date).getFullYear() === year ? idx : -1
        ).filter(idx => idx !== -1);
        
        const yearTemps = yearIndices.map(idx => 
          (dailyData.temperature_2m_max[idx] + dailyData.temperature_2m_min[idx]) / 2
        );
        return yearTemps.reduce((sum, temp) => sum + temp, 0) / yearTemps.length;
      });
      
      // Calculate annual precipitation
      const annualPrecip = years.map(year => {
        const yearIndices = dailyData.time.map((date, idx) => 
          new Date(date).getFullYear() === year ? idx : -1
        ).filter(idx => idx !== -1);
        
        return yearIndices.reduce((sum, idx) => sum + (dailyData.precipitation_sum[idx] || 0), 0);
      });
      
      // Calculate frost days per year
      const annualFrostDays = years.map(year => {
        const yearIndices = dailyData.time.map((date, idx) => 
          new Date(date).getFullYear() === year ? idx : -1
        ).filter(idx => idx !== -1);
        
        return yearIndices.filter(idx => dailyData.temperature_2m_min[idx] <= 0).length;
      });
      
      // Analyze planting dates
      const plantingDates = analyzePlantingDates(dailyData, years);
      
      // Rest of existing processing code...
      const monthlyPrecip = Array(12).fill(0);
      const currentYear = new Date().getFullYear();
      const currentYearIndices = dailyData.time.map((date, idx) => 
        new Date(date).getFullYear() === currentYear ? idx : -1
      ).filter(idx => idx !== -1);
      
      currentYearIndices.forEach(idx => {
        const month = new Date(dailyData.time[idx]).getMonth();
        monthlyPrecip[month] += dailyData.precipitation_sum[idx] || 0;
      });
      
      // Calculate trends
      const warmingTrend = parseFloat((annualAvgTemp[annualAvgTemp.length - 1] - annualAvgTemp[0]).toFixed(1));
      const avgPrecip = annualPrecip.reduce((a, b) => a + b, 0) / annualPrecip.length;
      const precipTrend = parseFloat(((annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / annualPrecip[0] * 100).toFixed(1));
      
      // Identify years with high frost (above 75th percentile)
      const frostThreshold = calculatePercentile(annualFrostDays, 75);
      const highFrostYears = years.filter((_, i) => annualFrostDays[i] > frostThreshold);
      
      // Identify drought years
      const moderateDroughtThreshold = avgPrecip * 0.74;
      const severeDroughtThreshold = avgPrecip * 0.5;
      const moderateDroughtYears = years.filter((_, i) => annualPrecip[i] < moderateDroughtThreshold);
      const severeDroughtYears = years.filter((_, i) => annualPrecip[i] < severeDroughtThreshold);
      
      // Generate frost comparison data (current vs historical)
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const currentYearTemps = Array(12).fill(0);
      const historicalTemps = Array(12).fill(0);
      const monthCounts = Array(12).fill(0);
      
      // Calculate historical monthly averages
      dailyData.time.forEach((date, idx) => {
        const month = new Date(date).getMonth();
        const year = new Date(date).getFullYear();
        const temp = (dailyData.temperature_2m_max[idx] + dailyData.temperature_2m_min[idx]) / 2;
        
        if (year === currentYear) {
          currentYearTemps[month] += temp;
        } else {
          historicalTemps[month] += temp;
          monthCounts[month]++;
        }
      });
      
      // Calculate averages
      historicalTemps.forEach((temp, month) => {
        historicalTemps[month] = monthCounts[month] > 0 ? temp / monthCounts[month] : 0;
      });
      
      // Generate frost months data
      const frostMonths = monthNames.map((name, index) => {
        const frostDays = currentYearIndices.filter(idx => 
          new Date(dailyData.time[idx]).getMonth() === index && 
          dailyData.temperature_2m_min[idx] <= 0
        ).length;
        return {
          name: name,
          frostDays: frostDays,
          hasFrost: frostDays > 0
        };
      });
      
      // Determine frost risk level
      const currentFrostDays = annualFrostDays[annualFrostDays.length - 1] || 0;
      let frostRisk = 'Low';
      if (currentFrostDays > 15) frostRisk = 'High';
      else if (currentFrostDays > 8) frostRisk = 'Moderate';
      
      // Determine coldest month
      const coldestMonthIndex = monthlyPrecip.indexOf(Math.min(...monthlyPrecip));
      const coldestMonth = monthNames[coldestMonthIndex];
      
      // Calculate prediction values based on trends
      const lastTemp = annualAvgTemp[annualAvgTemp.length - 1];
      const lastPrecip = annualPrecip[annualPrecip.length - 1];
      const lastFrost = annualFrostDays[annualFrostDays.length - 1];
      
      const predictedTemp = parseFloat((lastTemp + (warmingTrend / years.length)).toFixed(1));
      const predictedPrecip = Math.max(0, parseFloat((lastPrecip * (1 + precipTrend / 100 / years.length)).toFixed(0)));
      const predictedFrost = Math.max(0, lastFrost + Math.round(warmingTrend / 10));
      
      updateProgress(80, "Finalizing analysis...");
      
      return {
        location: {
          coords: `${parseFloat(lat).toFixed(4)}, ${parseFloat(lon).toFixed(4)}`,
          name: currentLocationName
        },
        temp: {
          labels: yearLabels,
          values: annualAvgTemp
        },
        precip: {
          labels: monthNames,
          values: monthlyPrecip
        },
        annualRainfall: {
          labels: yearLabels,
          values: annualPrecip
        },
        frost: {
          labels: yearLabels,
          values: annualFrostDays
        },
        drought: {
          labels: yearLabels,
          values: annualPrecip.map(p => parseFloat(((p - avgPrecip) / avgPrecip * 100).toFixed(1)))
        },
        frostComparison: {
          labels: monthNames,
          currentTemps: currentYearTemps,
          historicalTemps: historicalTemps
        },
        plantingDates: plantingDates, // NEW: Planting dates data
        stats: {
          avgTemp: (annualAvgTemp.reduce((a, b) => a + b, 0) / annualAvgTemp.length).toFixed(1),
          maxTemp: Math.max(...dailyData.temperature_2m_max).toFixed(1),
          minTemp: Math.min(...dailyData.temperature_2m_min).toFixed(1),
          warming: warmingTrend,
          annualPrecip: avgPrecip.toFixed(1),
          maxMonthlyPrecip: Math.max(...monthlyPrecip).toFixed(1),
          drySpells: calculateDrySpells(dailyData),
          precipTrend: precipTrend,
          highFrostYears: highFrostYears,
          moderateDroughtYears: moderateDroughtYears,
          severeDroughtYears: severeDroughtYears,
          totalFrost: currentFrostDays,
          avgFrost: (annualFrostDays.reduce((a, b) => a + b, 0) / annualFrostDays.length).toFixed(1),
          coldestMonth: coldestMonth,
          frostRisk: frostRisk,
          frostMonths: frostMonths
        },
        prediction: {
          year: new Date().getFullYear() + 1,
          temp: predictedTemp,
          precip: predictedPrecip,
          frost: predictedFrost
        }
      };
    }

    // Update the initCharts function to include planting dates table
    function initCharts(data) {
      // Previous chart initialization code remains the same...
      
      // Initialize Planting Dates Table
      initPlantingDatesTable(data.plantingDates);
      
      // Initialize Planting Recommendations
      initPlantingRecommendations(data);
    }

    // Initialize planting dates table
    function initPlantingDatesTable(plantingDates) {
      const tableBody = document.getElementById('plantingDatesTable');
      tableBody.innerHTML = '';
      
      // Sort by year and date
      plantingDates.sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return new Date(a.eventDate) - new Date(b.eventDate);
      });
      
      // Show only last 3 years for clarity
      const recentYears = [...new Set(plantingDates.map(p => p.year))].sort((a, b) => b - a).slice(0, 3);
      const filteredDates = plantingDates.filter(p => recentYears.includes(p.year));
      
      filteredDates.forEach(planting => {
        const row = document.createElement('tr');
        
        const statusClass = `status-${planting.status}`;
        const statusText = planting.status.charAt(0).toUpperCase() + planting.status.slice(1);
        
        row.innerHTML = `
          <td>${planting.year}</td>
          <td>${formatDate(planting.eventDate)}</td>
          <td><span class="rainfall-amount">${planting.totalRainfall.toFixed(1)} mm</span></td>
          <td>${planting.consecutiveDays} days</td>
          <td>${formatDate(planting.recommendedPlanting)}</td>
          <td><span class="planting-status ${statusClass}">${statusText}</span></td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // If no planting dates found, show message
      if (filteredDates.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" style="text-align: center; color: #666;">No suitable planting windows found in recent years</td>`;
        tableBody.appendChild(row);
      }
    }

    // Initialize planting recommendations
    function initPlantingRecommendations(data) {
      const recommendationsList = document.getElementById('plantingRecommendations');
      recommendationsList.innerHTML = '';
      
      const plantingDates = data.plantingDates;
      const recentYear = Math.max(...plantingDates.map(p => p.year));
      const recentPlantings = plantingDates.filter(p => p.year === recentYear);
      
      const recommendations = [
        "Monitor soil moisture levels before planting",
        "Consider soil temperature (ideal: 10-30°C for most crops)",
        "Check 14-day weather forecast for frost risk",
        "Prepare irrigation backup for dry spells"
      ];
      
      if (recentPlantings.length > 0) {
        const optimalPlantings = recentPlantings.filter(p => p.status === 'optimal');
        if (optimalPlantings.length > 0) {
          const bestPlanting = optimalPlantings[0];
          recommendations.unshift(`Based on ${recentYear} data, optimal planting around ${formatDate(bestPlanting.recommendedPlanting)}`);
        }
        
        // Add crop-specific recommendations based on location and climate
        const avgTemp = parseFloat(data.stats.avgTemp);
        if (avgTemp > 20) {
          recommendations.push("Suitable for warm-season crops: maize, sorghum, soybeans");
        } else {
          recommendations.push("Suitable for cool-season crops: wheat, barley, oats");
        }
        
        if (data.stats.frostRisk === 'High') {
          recommendations.push("Delay planting until frost risk decreases");
        }
      }
      
      recommendations.forEach(rec => {
        const li = document.createElement('li');
        li.innerHTML = `<i class="fas fa-leaf recommendation-icon"></i> ${rec}`;
        recommendationsList.appendChild(li);
      });
    }

    // Helper function to format dates
    function formatDate(date) {
      return new Date(date).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    // Update the sample data generation to include planting dates
    function generateSampleData(lat, lon) {
      const years = Array.from({length: 10}, (_, i) => new Date().getFullYear() - 9 + i);
      const yearLabels = years.map(y => y.toString());
      
      // Generate realistic sample data based on latitude
      const baseTemp = 20 - (Math.abs(lat) / 3);
      const basePrecip = 500 + (Math.abs(lat) * 10);
      
      const annualAvgTemp = years.map(() => baseTemp + (Math.random() * 6 - 3));
      const annualPrecip = years.map(() => basePrecip + (Math.random() * 300 - 150));
      const annualFrostDays = years.map(() => Math.floor(Math.random() * (lat > -30 ? 10 : 30)));
      
      // Generate sample planting dates
      const plantingDates = [];
      years.forEach(year => {
        // Generate 1-3 planting windows per year
        const numWindows = 1 + Math.floor(Math.random() * 3);
        for (let i = 0; i < numWindows; i++) {
          const eventDate = new Date(year, Math.floor(Math.random() * 9), 1 + Math.floor(Math.random() * 28));
          const totalRainfall = 10 + Math.random() * 30;
          const recommendedPlanting = new Date(eventDate);
          recommendedPlanting.setDate(recommendedPlanting.getDate() + (14 + Math.floor(Math.random() * 14)));
          
          plantingDates.push({
            year: year,
            eventDate: eventDate,
            totalRainfall: totalRainfall,
            consecutiveDays: 7,
            recommendedPlanting: recommendedPlanting,
            status: totalRainfall >= 20 ? 'optimal' : totalRainfall >= 15 ? 'good' : 'poor'
          });
        }
      });
      
      // Calculate trends
      const warmingTrend = parseFloat((annualAvgTemp[annualAvgTemp.length - 1] - annualAvgTemp[0]).toFixed(1));
      const precipTrend = parseFloat(((annualPrecip[annualPrecip.length - 1] - annualPrecip[0]) / annualPrecip[0] * 100).toFixed(1));
      
      // Identify years with high frost
      const highFrostYears = years.filter((_, i) => annualFrostDays[i] > 10);
      
      // Identify drought years
      const avgPrecip = annualPrecip.reduce((a, b) => a + b, 0) / annualPrecip.length;
      const moderateDroughtYears = years.filter((_, i) => annualPrecip[i] < avgPrecip * 0.74);
      const severeDroughtYears = years.filter((_, i) => annualPrecip[i] < avgPrecip * 0.5);
      
      // Generate monthly precipitation data
      const monthlyPrecip = Array(12).fill().map(() => 20 + Math.random() * 100);
      
      // Generate frost comparison data
      const currentYearTemps = Array(12).fill().map(() => baseTemp + Math.random() * 10 - 5);
      const historicalTemps = Array(12).fill().map(() => baseTemp + Math.random() * 8 - 4);
      
      // Generate frost months data
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const frostMonths = monthNames.map((name, index) => {
        const frostDays = (index >= 4 && index <= 8) ? Math.floor(Math.random() * 5) : 0;
        return {
          name: name,
          frostDays: frostDays,
          hasFrost: frostDays > 0
        };
      });
      
      // Determine frost risk level
      const currentFrostDays = annualFrostDays[annualFrostDays.length - 1];
      let frostRisk = 'Low';
      if (currentFrostDays > 15) frostRisk = 'High';
      else if (currentFrostDays > 8) frostRisk = 'Moderate';
      
      // Determine coldest month
      const coldestMonthIndex = monthlyPrecip.indexOf(Math.min(...monthlyPrecip));
      const coldestMonth = monthNames[coldestMonthIndex];
      
      // Prepare data structure
      return {
        location: {
          coords: `${lat}, ${lon}`,
          name: currentLocationName
        },
        temp: {
          labels: yearLabels,
          values: annualAvgTemp
        },
        precip: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          values: monthlyPrecip
        },
        annualRainfall: {
          labels: yearLabels,
          values: annualPrecip
        },
        frost: {
          labels: yearLabels,
          values: annualFrostDays
        },
        drought: {
          labels: yearLabels,
          values: annualPrecip.map(p => parseFloat(((p - avgPrecip) / avgPrecip * 100).toFixed(1)))
        },
        frostComparison: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          currentTemps: currentYearTemps,
          historicalTemps: historicalTemps
        },
        plantingDates: plantingDates, // Include sample planting dates
        stats: {
          avgTemp: (annualAvgTemp.reduce((a, b) => a + b, 0) / annualAvgTemp.length).toFixed(1),
          maxTemp: (Math.max(...annualAvgTemp) + 10).toFixed(1),
          minTemp: (Math.min(...annualAvgTemp) - 15).toFixed(1),
          warming: warmingTrend,
          annualPrecip: avgPrecip.toFixed(1),
          maxMonthlyPrecip: Math.max(...monthlyPrecip).toFixed(1),
          drySpells: (monthlyPrecip.filter(p => p < 30).length / years.length).toFixed(1),
          precipTrend: precipTrend,
          highFrostYears: highFrostYears,
          moderateDroughtYears: moderateDroughtYears,
          severeDroughtYears: severeDroughtYears,
          totalFrost: currentFrostDays,
          avgFrost: (annualFrostDays.reduce((a, b) => a + b, 0) / annualFrostDays.length).toFixed(1),
          coldestMonth: coldestMonth,
          frostRisk: frostRisk,
          frostMonths: frostMonths
        },
        prediction: {
          year: new Date().getFullYear() + 1,
          temp: parseFloat(annualAvgTemp[annualAvgTemp.length - 1] + (warmingTrend / years.length)).toFixed(1),
          precip: Math.max(0, parseFloat(annualPrecip[annualPrecip.length - 1] * (1 + precipTrend / 100 / years.length)).toFixed(0)),
          frost: Math.max(0, annualFrostDays[annualFrostDays.length - 1] + Math.round(warmingTrend / 10))
        }
      };
    }

    // The rest of the original JavaScript code remains unchanged...
    // [Include all the original JavaScript functions from the previous implementation]
  </script>
</body>
</html>
